<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>關於 Python 你該知道的那些事 - GIL(Global Interpreter Lock) | Shawn Hsu</title>
<meta name="description" content="為什麼在 python 中多執行緒會比較慢？ 這是因為 GIL 的存在所導致。這篇文章將會介紹 GIL 的概念以及歷史以及在多執行緒下的一些問題">


  <meta name="author" content="Shawn Hsu">
  
  <meta property="article:author" content="Shawn Hsu">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Shawn Hsu">
<meta property="og:title" content="關於 Python 你該知道的那些事 - GIL(Global Interpreter Lock)">
<meta property="og:url" content="https://ambersuncreates.com/random/python-gil/">


  <meta property="og:description" content="為什麼在 python 中多執行緒會比較慢？ 這是因為 GIL 的存在所導致。這篇文章將會介紹 GIL 的概念以及歷史以及在多執行緒下的一些問題">


<meta property="og:image" content="/assets/img/og/python-gil.png">




  <meta property="article:published_time" content="2022-01-16T00:00:00+08:00">



  <meta property="article:modified_time" content="2024-05-14T21:13:03+08:00">



  

  


<link rel="canonical" href="https://ambersuncreates.com/random/python-gil/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Shawn Hsu",
      "url": "https://ambersuncreates.com/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Shawn Hsu Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3411784157543420"
     crossorigin="anonymous"></script>

<!-- google ads -->
<script async src="https://fundingchoicesmessages.google.com/i/pub-3411784157543420?ers=1" nonce="DTHVC27nOex6L5olJXhYMg"></script><script nonce="DTHVC27nOex6L5olJXhYMg">(function() {function signalGooglefcPresent() {if (!window.frames['googlefcPresent']) {if (document.body) {const iframe = document.createElement('iframe'); iframe.style = 'width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;'; iframe.style.display = 'none'; iframe.name = 'googlefcPresent'; document.body.appendChild(iframe);} else {setTimeout(signalGooglefcPresent, 0);}}}signalGooglefcPresent();})();</script>
<script>(function(){'use strict';function aa(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}var ba="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};
  function ca(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");}var da=ca(this);function k(a,b){if(b)a:{var c=da;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))break a;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&ba(c,a,{configurable:!0,writable:!0,value:b})}}
  function ea(a){return a.raw=a}function m(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];if(b)return b.call(a);if("number"==typeof a.length)return{next:aa(a)};throw Error(String(a)+" is not an iterable or ArrayLike");}function fa(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c}var ha="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},n;
  if("function"==typeof Object.setPrototypeOf)n=Object.setPrototypeOf;else{var q;a:{var ia={a:!0},ja={};try{ja.__proto__=ia;q=ja.a;break a}catch(a){}q=!1}n=q?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var ka=n;
  function r(a,b){a.prototype=ha(b.prototype);a.prototype.constructor=a;if(ka)ka(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.A=b.prototype}function la(){for(var a=Number(this),b=[],c=a;c<arguments.length;c++)b[c-a]=arguments[c];return b}k("Number.MAX_SAFE_INTEGER",function(){return 9007199254740991});
  k("Number.isFinite",function(a){return a?a:function(b){return"number"!==typeof b?!1:!isNaN(b)&&Infinity!==b&&-Infinity!==b}});k("Number.isInteger",function(a){return a?a:function(b){return Number.isFinite(b)?b===Math.floor(b):!1}});k("Number.isSafeInteger",function(a){return a?a:function(b){return Number.isInteger(b)&&Math.abs(b)<=Number.MAX_SAFE_INTEGER}});
  k("Math.trunc",function(a){return a?a:function(b){b=Number(b);if(isNaN(b)||Infinity===b||-Infinity===b||0===b)return b;var c=Math.floor(Math.abs(b));return 0>b?-c:c}});k("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}});k("Array.prototype.includes",function(a){return a?a:function(b,c){var d=this;d instanceof String&&(d=String(d));var e=d.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=d[c];if(f===b||Object.is(f,b))return!0}return!1}});
  k("String.prototype.includes",function(a){return a?a:function(b,c){if(null==this)throw new TypeError("The 'this' value for String.prototype.includes must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype.includes must not be a regular expression");return-1!==this.indexOf(b,c||0)}});/*
  
   Copyright The Closure Library Authors.
   SPDX-License-Identifier: Apache-2.0
  */
  var t=this||self;function v(a){return a};var w,x;a:{for(var ma=["CLOSURE_FLAGS"],y=t,z=0;z<ma.length;z++)if(y=y[ma[z]],null==y){x=null;break a}x=y}var na=x&&x[610401301];w=null!=na?na:!1;var A,oa=t.navigator;A=oa?oa.userAgentData||null:null;function B(a){return w?A?A.brands.some(function(b){return(b=b.brand)&&-1!=b.indexOf(a)}):!1:!1}function C(a){var b;a:{if(b=t.navigator)if(b=b.userAgent)break a;b=""}return-1!=b.indexOf(a)};function D(){return w?!!A&&0<A.brands.length:!1}function E(){return D()?B("Chromium"):(C("Chrome")||C("CriOS"))&&!(D()?0:C("Edge"))||C("Silk")};var pa=D()?!1:C("Trident")||C("MSIE");!C("Android")||E();E();C("Safari")&&(E()||(D()?0:C("Coast"))||(D()?0:C("Opera"))||(D()?0:C("Edge"))||(D()?B("Microsoft Edge"):C("Edg/"))||D()&&B("Opera"));var qa={},F=null;var ra="undefined"!==typeof Uint8Array,sa=!pa&&"function"===typeof btoa;function G(){return"function"===typeof BigInt};var H=0,I=0;function ta(a){var b=0>a;a=Math.abs(a);var c=a>>>0;a=Math.floor((a-c)/4294967296);b&&(c=m(ua(c,a)),b=c.next().value,a=c.next().value,c=b);H=c>>>0;I=a>>>0}function va(a,b){b>>>=0;a>>>=0;if(2097151>=b)var c=""+(4294967296*b+a);else G()?c=""+(BigInt(b)<<BigInt(32)|BigInt(a)):(c=(a>>>24|b<<8)&16777215,b=b>>16&65535,a=(a&16777215)+6777216*c+6710656*b,c+=8147497*b,b*=2,1E7<=a&&(c+=Math.floor(a/1E7),a%=1E7),1E7<=c&&(b+=Math.floor(c/1E7),c%=1E7),c=b+wa(c)+wa(a));return c}
  function wa(a){a=String(a);return"0000000".slice(a.length)+a}function ua(a,b){b=~b;a?a=~a+1:b+=1;return[a,b]};var J;J="function"===typeof Symbol&&"symbol"===typeof Symbol()?Symbol():void 0;var xa=J?function(a,b){a[J]|=b}:function(a,b){void 0!==a.g?a.g|=b:Object.defineProperties(a,{g:{value:b,configurable:!0,writable:!0,enumerable:!1}})},K=J?function(a){return a[J]|0}:function(a){return a.g|0},L=J?function(a){return a[J]}:function(a){return a.g},M=J?function(a,b){a[J]=b;return a}:function(a,b){void 0!==a.g?a.g=b:Object.defineProperties(a,{g:{value:b,configurable:!0,writable:!0,enumerable:!1}});return a};function ya(a,b){M(b,(a|0)&-14591)}function za(a,b){M(b,(a|34)&-14557)}
  function Aa(a){a=a>>14&1023;return 0===a?536870912:a};var N={},Ba={};function Ca(a){return!(!a||"object"!==typeof a||a.g!==Ba)}function Da(a){return null!==a&&"object"===typeof a&&!Array.isArray(a)&&a.constructor===Object}function P(a,b,c){if(!Array.isArray(a)||a.length)return!1;var d=K(a);if(d&1)return!0;if(!(b&&(Array.isArray(b)?b.includes(c):b.has(c))))return!1;M(a,d|1);return!0}Object.freeze(new function(){});Object.freeze(new function(){});var Ea=/^-?([1-9][0-9]*|0)(\.[0-9]+)?$/;var Q;function Fa(a,b){Q=b;a=new a(b);Q=void 0;return a}
  function R(a,b,c){null==a&&(a=Q);Q=void 0;if(null==a){var d=96;c?(a=[c],d|=512):a=[];b&&(d=d&-16760833|(b&1023)<<14)}else{if(!Array.isArray(a))throw Error();d=K(a);if(d&64)return a;d|=64;if(c&&(d|=512,c!==a[0]))throw Error();a:{c=a;var e=c.length;if(e){var f=e-1;if(Da(c[f])){d|=256;b=f-(+!!(d&512)-1);if(1024<=b)throw Error();d=d&-16760833|(b&1023)<<14;break a}}if(b){b=Math.max(b,e-(+!!(d&512)-1));if(1024<b)throw Error();d=d&-16760833|(b&1023)<<14}}}M(a,d);return a};function Ga(a){switch(typeof a){case "number":return isFinite(a)?a:String(a);case "boolean":return a?1:0;case "object":if(a)if(Array.isArray(a)){if(P(a,void 0,0))return}else if(ra&&null!=a&&a instanceof Uint8Array){if(sa){for(var b="",c=0,d=a.length-10240;c<d;)b+=String.fromCharCode.apply(null,a.subarray(c,c+=10240));b+=String.fromCharCode.apply(null,c?a.subarray(c):a);a=btoa(b)}else{void 0===b&&(b=0);if(!F){F={};c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");d=["+/=",
  "+/","-_=","-_.","-_"];for(var e=0;5>e;e++){var f=c.concat(d[e].split(""));qa[e]=f;for(var g=0;g<f.length;g++){var h=f[g];void 0===F[h]&&(F[h]=g)}}}b=qa[b];c=Array(Math.floor(a.length/3));d=b[64]||"";for(e=f=0;f<a.length-2;f+=3){var l=a[f],p=a[f+1];h=a[f+2];g=b[l>>2];l=b[(l&3)<<4|p>>4];p=b[(p&15)<<2|h>>6];h=b[h&63];c[e++]=g+l+p+h}g=0;h=d;switch(a.length-f){case 2:g=a[f+1],h=b[(g&15)<<2]||d;case 1:a=a[f],c[e]=b[a>>2]+b[(a&3)<<4|g>>4]+h+d}a=c.join("")}return a}}return a};function Ha(a,b,c){a=Array.prototype.slice.call(a);var d=a.length,e=b&256?a[d-1]:void 0;d+=e?-1:0;for(b=b&512?1:0;b<d;b++)a[b]=c(a[b]);if(e){b=a[b]={};for(var f in e)Object.prototype.hasOwnProperty.call(e,f)&&(b[f]=c(e[f]))}return a}function Ia(a,b,c,d,e){if(null!=a){if(Array.isArray(a))a=P(a,void 0,0)?void 0:e&&K(a)&2?a:Ja(a,b,c,void 0!==d,e);else if(Da(a)){var f={},g;for(g in a)Object.prototype.hasOwnProperty.call(a,g)&&(f[g]=Ia(a[g],b,c,d,e));a=f}else a=b(a,d);return a}}
  function Ja(a,b,c,d,e){var f=d||c?K(a):0;d=d?!!(f&32):void 0;a=Array.prototype.slice.call(a);for(var g=0;g<a.length;g++)a[g]=Ia(a[g],b,c,d,e);c&&c(f,a);return a}function Ka(a){return a.s===N?a.toJSON():Ga(a)};function La(a,b,c){c=void 0===c?za:c;if(null!=a){if(ra&&a instanceof Uint8Array)return b?a:new Uint8Array(a);if(Array.isArray(a)){var d=K(a);if(d&2)return a;b&&(b=0===d||!!(d&32)&&!(d&64||!(d&16)));return b?M(a,(d|34)&-12293):Ja(a,La,d&4?za:c,!0,!0)}a.s===N&&(c=a.h,d=L(c),a=d&2?a:Fa(a.constructor,Ma(c,d,!0)));return a}}function Ma(a,b,c){var d=c||b&2?za:ya,e=!!(b&32);a=Ha(a,b,function(f){return La(f,e,d)});xa(a,32|(c?2:0));return a};function Na(a,b){a=a.h;return Oa(a,L(a),b)}function Oa(a,b,c,d){if(-1===c)return null;if(c>=Aa(b)){if(b&256)return a[a.length-1][c]}else{var e=a.length;if(d&&b&256&&(d=a[e-1][c],null!=d))return d;b=c+(+!!(b&512)-1);if(b<e)return a[b]}}function Pa(a,b,c,d,e){var f=Aa(b);if(c>=f||e){var g=b;if(b&256)e=a[a.length-1];else{if(null==d)return;e=a[f+(+!!(b&512)-1)]={};g|=256}e[c]=d;c<f&&(a[c+(+!!(b&512)-1)]=void 0);g!==b&&M(a,g)}else a[c+(+!!(b&512)-1)]=d,b&256&&(a=a[a.length-1],c in a&&delete a[c])}
  function Qa(a,b){var c=Ra;var d=void 0===d?!1:d;var e=a.h;var f=L(e),g=Oa(e,f,b,d);if(null!=g&&"object"===typeof g&&g.s===N)c=g;else if(Array.isArray(g)){var h=K(g),l=h;0===l&&(l|=f&32);l|=f&2;l!==h&&M(g,l);c=new c(g)}else c=void 0;c!==g&&null!=c&&Pa(e,f,b,c,d);e=c;if(null==e)return e;a=a.h;f=L(a);f&2||(g=e,c=g.h,h=L(c),g=h&2?Fa(g.constructor,Ma(c,h,!1)):g,g!==e&&(e=g,Pa(a,f,b,e,d)));return e}function Sa(a,b){a=Na(a,b);return null==a||"string"===typeof a?a:void 0}
  function Ta(a,b){var c=void 0===c?0:c;a=Na(a,b);if(null!=a)if(b=typeof a,"number"===b?Number.isFinite(a):"string"!==b?0:Ea.test(a))if("number"===typeof a){if(a=Math.trunc(a),!Number.isSafeInteger(a)){ta(a);b=H;var d=I;if(a=d&2147483648)b=~b+1>>>0,d=~d>>>0,0==b&&(d=d+1>>>0);b=4294967296*d+(b>>>0);a=a?-b:b}}else if(b=Math.trunc(Number(a)),Number.isSafeInteger(b))a=String(b);else{if(b=a.indexOf("."),-1!==b&&(a=a.substring(0,b)),!("-"===a[0]?20>a.length||20===a.length&&-922337<Number(a.substring(0,7)):
  19>a.length||19===a.length&&922337>Number(a.substring(0,6)))){if(16>a.length)ta(Number(a));else if(G())a=BigInt(a),H=Number(a&BigInt(4294967295))>>>0,I=Number(a>>BigInt(32)&BigInt(4294967295));else{b=+("-"===a[0]);I=H=0;d=a.length;for(var e=b,f=(d-b)%6+b;f<=d;e=f,f+=6)e=Number(a.slice(e,f)),I*=1E6,H=1E6*H+e,4294967296<=H&&(I+=Math.trunc(H/4294967296),I>>>=0,H>>>=0);b&&(b=m(ua(H,I)),a=b.next().value,b=b.next().value,H=a,I=b)}a=H;b=I;b&2147483648?G()?a=""+(BigInt(b|0)<<BigInt(32)|BigInt(a>>>0)):(b=
  m(ua(a,b)),a=b.next().value,b=b.next().value,a="-"+va(a,b)):a=va(a,b)}}else a=void 0;return null!=a?a:c}function S(a,b){a=Sa(a,b);return null!=a?a:""};function T(a,b,c){this.h=R(a,b,c)}T.prototype.toJSON=function(){return Ua(this,Ja(this.h,Ka,void 0,void 0,!1),!0)};T.prototype.s=N;T.prototype.toString=function(){return Ua(this,this.h,!1).toString()};
  function Ua(a,b,c){var d=a.constructor.v,e=L(c?a.h:b);a=b.length;if(!a)return b;var f;if(Da(c=b[a-1])){a:{var g=c;var h={},l=!1,p;for(p in g)if(Object.prototype.hasOwnProperty.call(g,p)){var u=g[p];if(Array.isArray(u)){var jb=u;if(P(u,d,+p)||Ca(u)&&0===u.size)u=null;u!=jb&&(l=!0)}null!=u?h[p]=u:l=!0}if(l){for(var O in h){g=h;break a}g=null}}g!=c&&(f=!0);a--}for(p=+!!(e&512)-1;0<a;a--){O=a-1;c=b[O];O-=p;if(!(null==c||P(c,d,O)||Ca(c)&&0===c.size))break;var kb=!0}if(!f&&!kb)return b;b=Array.prototype.slice.call(b,
  0,a);g&&b.push(g);return b};function Va(a){return function(b){if(null==b||""==b)b=new a;else{b=JSON.parse(b);if(!Array.isArray(b))throw Error(void 0);xa(b,32);b=Fa(a,b)}return b}};function Wa(a){this.h=R(a)}r(Wa,T);var Xa=Va(Wa);var U;function V(a){this.g=a}V.prototype.toString=function(){return this.g+""};var Ya={};function Za(a){if(void 0===U){var b=null;var c=t.trustedTypes;if(c&&c.createPolicy){try{b=c.createPolicy("goog#html",{createHTML:v,createScript:v,createScriptURL:v})}catch(d){t.console&&t.console.error(d.message)}U=b}else U=b}a=(b=U)?b.createScriptURL(a):a;return new V(a,Ya)};function $a(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)};function ab(a,b){b=String(b);"application/xhtml+xml"===a.contentType&&(b=b.toLowerCase());return a.createElement(b)}function bb(a){this.g=a||t.document||document};/*
  
   SPDX-License-Identifier: Apache-2.0
  */
  function cb(a,b){a.src=b instanceof V&&b.constructor===V?b.g:"type_error:TrustedResourceUrl";var c,d;(c=(b=null==(d=(c=(a.ownerDocument&&a.ownerDocument.defaultView||window).document).querySelector)?void 0:d.call(c,"script[nonce]"))?b.nonce||b.getAttribute("nonce")||"":"")&&a.setAttribute("nonce",c)};function db(a){a=void 0===a?document:a;return a.createElement("script")};function eb(a,b,c,d,e,f){try{var g=a.g,h=db(g);h.async=!0;cb(h,b);g.head.appendChild(h);h.addEventListener("load",function(){e();d&&g.head.removeChild(h)});h.addEventListener("error",function(){0<c?eb(a,b,c-1,d,e,f):(d&&g.head.removeChild(h),f())})}catch(l){f()}};var fb=t.atob("aHR0cHM6Ly93d3cuZ3N0YXRpYy5jb20vaW1hZ2VzL2ljb25zL21hdGVyaWFsL3N5c3RlbS8xeC93YXJuaW5nX2FtYmVyXzI0ZHAucG5n"),gb=t.atob("WW91IGFyZSBzZWVpbmcgdGhpcyBtZXNzYWdlIGJlY2F1c2UgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlIGlzIGludGVyZmVyaW5nIHdpdGggdGhpcyBwYWdlLg=="),hb=t.atob("RGlzYWJsZSBhbnkgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlLCB0aGVuIHJlbG9hZCB0aGlzIHBhZ2Uu");function ib(a,b,c){this.i=a;this.u=b;this.o=c;this.g=null;this.j=[];this.m=!1;this.l=new bb(this.i)}
  function lb(a){if(a.i.body&&!a.m){var b=function(){mb(a);t.setTimeout(function(){nb(a,3)},50)};eb(a.l,a.u,2,!0,function(){t[a.o]||b()},b);a.m=!0}}
  function mb(a){for(var b=W(1,5),c=0;c<b;c++){var d=X(a);a.i.body.appendChild(d);a.j.push(d)}b=X(a);b.style.bottom="0";b.style.left="0";b.style.position="fixed";b.style.width=W(100,110).toString()+"%";b.style.zIndex=W(2147483544,2147483644).toString();b.style.backgroundColor=ob(249,259,242,252,219,229);b.style.boxShadow="0 0 12px #888";b.style.color=ob(0,10,0,10,0,10);b.style.display="flex";b.style.justifyContent="center";b.style.fontFamily="Roboto, Arial";c=X(a);c.style.width=W(80,85).toString()+
  "%";c.style.maxWidth=W(750,775).toString()+"px";c.style.margin="24px";c.style.display="flex";c.style.alignItems="flex-start";c.style.justifyContent="center";d=ab(a.l.g,"IMG");d.className=$a();d.src=fb;d.alt="Warning icon";d.style.height="24px";d.style.width="24px";d.style.paddingRight="16px";var e=X(a),f=X(a);f.style.fontWeight="bold";f.textContent=gb;var g=X(a);g.textContent=hb;Y(a,e,f);Y(a,e,g);Y(a,c,d);Y(a,c,e);Y(a,b,c);a.g=b;a.i.body.appendChild(a.g);b=W(1,5);for(c=0;c<b;c++)d=X(a),a.i.body.appendChild(d),
  a.j.push(d)}function Y(a,b,c){for(var d=W(1,5),e=0;e<d;e++){var f=X(a);b.appendChild(f)}b.appendChild(c);c=W(1,5);for(d=0;d<c;d++)e=X(a),b.appendChild(e)}function W(a,b){return Math.floor(a+Math.random()*(b-a))}function ob(a,b,c,d,e,f){return"rgb("+W(Math.max(a,0),Math.min(b,255)).toString()+","+W(Math.max(c,0),Math.min(d,255)).toString()+","+W(Math.max(e,0),Math.min(f,255)).toString()+")"}function X(a){a=ab(a.l.g,"DIV");a.className=$a();return a}
  function nb(a,b){0>=b||null!=a.g&&0!==a.g.offsetHeight&&0!==a.g.offsetWidth||(pb(a),mb(a),t.setTimeout(function(){nb(a,b-1)},50))}function pb(a){for(var b=m(a.j),c=b.next();!c.done;c=b.next())(c=c.value)&&c.parentNode&&c.parentNode.removeChild(c);a.j=[];(b=a.g)&&b.parentNode&&b.parentNode.removeChild(b);a.g=null};function qb(a,b,c,d,e){function f(l){document.body?g(document.body):0<l?t.setTimeout(function(){f(l-1)},e):b()}function g(l){l.appendChild(h);t.setTimeout(function(){h?(0!==h.offsetHeight&&0!==h.offsetWidth?b():a(),h.parentNode&&h.parentNode.removeChild(h)):a()},d)}var h=rb(c);f(3)}function rb(a){var b=document.createElement("div");b.className=a;b.style.width="1px";b.style.height="1px";b.style.position="absolute";b.style.left="-10000px";b.style.top="-10000px";b.style.zIndex="-10000";return b};function Ra(a){this.h=R(a)}r(Ra,T);function sb(a){this.h=R(a)}r(sb,T);var tb=Va(sb);function ub(a){var b=la.apply(1,arguments);if(0===b.length)return Za(a[0]);for(var c=a[0],d=0;d<b.length;d++)c+=encodeURIComponent(b[d])+a[d+1];return Za(c)};function vb(a){if(!a)return null;a=Sa(a,4);var b;null===a||void 0===a?b=null:b=Za(a);return b};var wb=ea([""]),xb=ea([""]);function yb(a,b){this.m=a;this.o=new bb(a.document);this.g=b;this.j=S(this.g,1);this.u=vb(Qa(this.g,2))||ub(wb);this.i=!1;b=vb(Qa(this.g,13))||ub(xb);this.l=new ib(a.document,b,S(this.g,12))}yb.prototype.start=function(){zb(this)};
  function zb(a){Ab(a);eb(a.o,a.u,3,!1,function(){a:{var b=a.j;var c=t.btoa(b);if(c=t[c]){try{var d=Xa(t.atob(c))}catch(e){b=!1;break a}b=b===Sa(d,1)}else b=!1}b?Z(a,S(a.g,14)):(Z(a,S(a.g,8)),lb(a.l))},function(){qb(function(){Z(a,S(a.g,7));lb(a.l)},function(){return Z(a,S(a.g,6))},S(a.g,9),Ta(a.g,10),Ta(a.g,11))})}function Z(a,b){a.i||(a.i=!0,a=new a.m.XMLHttpRequest,a.open("GET",b,!0),a.send())}function Ab(a){var b=t.btoa(a.j);a.m[b]&&Z(a,S(a.g,5))};(function(a,b){t[a]=function(){var c=la.apply(0,arguments);t[a]=function(){};b.call.apply(b,[null].concat(c instanceof Array?c:fa(m(c))))}})("__h82AlnkH6D91__",function(a){"function"===typeof window.atob&&(new yb(window,tb(window.atob(a)))).start()});}).call(this);
  
  window.__h82AlnkH6D91__("WyJwdWItMzQxMTc4NDE1NzU0MzQyMCIsW251bGwsbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9iL3B1Yi0zNDExNzg0MTU3NTQzNDIwIl0sbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9lbC9BR1NLV3hXcFo2SEZhZ2tXV3BBeDkyVm5FUm1HelA4Sng3NDBjbG82QTd1U1BzMjMtb1J6aTl0R2tJZC0ySTZkbU9kVExldXJ5VU5pdDJmWVl6cVN3ZXFSaHFtT1d3XHUwMDNkXHUwMDNkP3RlXHUwMDNkVE9LRU5fRVhQT1NFRCIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFVub2h4aTRwNDRvRHN5UjNjSzBTTlVWdlhldmoySHp3dHBPMk52dlF4SXpPc1RuT1E4ZXV1Qzc4UExTRzROMFplT28xRWF6MG5hYjVHNElnMGJ5M1RqTkFcdTAwM2RcdTAwM2Q/YWJcdTAwM2QxXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFU0c2VpaDRuem1aQ2VKc0s0OUpFdHNBT3ZIZkNGaE9yMXFDN3N5bzRSaHBmamQzay02OGlaakhUT0UybWlxTEx6SnpZYUFPZHhTYWVRMC1LMGRZc0VabWdcdTAwM2RcdTAwM2Q/YWJcdTAwM2QyXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFdROU1sNExITHNkMVg0RzJualpOUXBhVE1GVzVTU2RUb0hUVF9oU1F6OVI3cm1RSVZsR3kzOFgyMng0dDZSVHJLdTVRaUlrdkl0ZFd2TFJ1Mnl2SEVaTXdcdTAwM2RcdTAwM2Q/c2JmXHUwMDNkMiIsImRpdi1ncHQtYWQiLDIwLDEwMCwiY0hWaUxUTTBNVEUzT0RReE5UYzFORE0wTWpBXHUwMDNkIixbbnVsbCxudWxsLG51bGwsImh0dHBzOi8vd3d3LmdzdGF0aWMuY29tLzBlbW4vZi9wL3B1Yi0zNDExNzg0MTU3NTQzNDIwLmpzP3VzcXBcdTAwM2RDQkkiXSwiaHR0cHM6Ly9mdW5kaW5nY2hvaWNlc21lc3NhZ2VzLmdvb2dsZS5jb20vZWwvQUdTS1d4V3YwN0dzbGhnVi1oUV85a0wzV0FhN0hmUXo3dXhKTWFBLUtHQ3VMOUhrWmRVWEFneHNmcVdIYUJrZlhBZkF1TUdyM2hFTmVMeVhZZDItS25ublNQODdwZ1x1MDAzZFx1MDAzZCJd");</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="shortcut icon" href="/assets/img/favicon.ico">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Shawn Hsu
          <span class="site-subtitle">Shawn Hsu's personal study blog | Software Engineer | Backend | Cloud Native | Blockchain</span>
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/archive/">Archive</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li>
</ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#random" itemprop="item"><span itemprop="name">Random</span></a>
          <meta itemprop="position" content="2">
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">關於 Python 你該知道的那些事 - GIL(Global Interpreter Lock)</li>
      
    
  </ol>
</nav>

  


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const sidebarNav = document.querySelector("nav.toc");
    if (!sidebarNav) {
      return;
    }

    // Find the actual scrollable container
    let scrollContainer = null;

    // Check if the nav itself is scrollable
    if (sidebarNav.scrollHeight > sidebarNav.offsetHeight) {
      scrollContainer = sidebarNav;
    } else {
      // Look for scrollable children
      const tocMenu = sidebarNav.querySelector(".toc__menu");
      if (tocMenu && tocMenu.scrollHeight > tocMenu.offsetHeight) {
        scrollContainer = tocMenu;
      } else {
        // Look for any scrollable child
        const children = sidebarNav.children;
        for (let child of children) {
          if (child.scrollHeight > child.offsetHeight) {
            scrollContainer = child;
            break;
          }
        }
      }
    }

    if (!scrollContainer) {
      return;
    }

    let isUserScrolling = false;
    let autoScrollEnabled = true;
    let scrollTimeout;
    let pageScrollTimeout;
    let periodicCheckInterval;

    // Function to check if element is visible in container
    const isElementVisible = (element) => {
      const containerTop = scrollContainer.scrollTop;
      const containerHeight = scrollContainer.offsetHeight;
      const elementTop = element.offsetTop;
      const elementHeight = element.offsetHeight;

      const isVisible =
        elementTop >= containerTop &&
        elementTop + elementHeight <= containerTop + containerHeight;

      return isVisible;
    };

    // Function to find the current active heading based on scroll position
    const findCurrentActiveHeading = () => {
      const headings = document.querySelectorAll(
        "h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]"
      );
      const scrollY = window.scrollY;
      const offset = 100; // Offset to trigger activation

      let currentHeading = null;

      // Find the heading that's currently at the top of the viewport
      for (let i = 0; i < headings.length; i++) {
        const heading = headings[i];
        const headingTop = heading.offsetTop;

        if (headingTop <= scrollY + offset) {
          currentHeading = heading;
        } else {
          break;
        }
      }

      return currentHeading;
    };

    // Function to find the TOC element that corresponds to a heading
    const findTocElementForHeading = (heading) => {
      if (!heading || !heading.id) return null;

      const tocLinks = document.querySelectorAll("nav.toc a");
      for (const link of tocLinks) {
        if (link.getAttribute("href") === `#${heading.id}`) {
          return link.closest("li");
        }
      }
      return null;
    };

    // Function to scroll TOC to show active element
    const scrollTocToActive = () => {
      // Don't auto-scroll if user is manually scrolling or auto-scroll is disabled
      if (isUserScrolling || !autoScrollEnabled) {
        return;
      }

      // Always use scroll position to find the current heading
      const currentHeading = findCurrentActiveHeading();
      if (!currentHeading) {
        return;
      }

      const activeElement = findTocElementForHeading(currentHeading);
      if (!activeElement) {
        return;
      }

      // Check if active element is visible
      if (!isElementVisible(activeElement)) {
        // Get the current scroll position and container dimensions
        const currentScrollTop = scrollContainer.scrollTop;
        const containerHeight = scrollContainer.offsetHeight;
        const elementTop = activeElement.offsetTop;
        const elementHeight = activeElement.offsetHeight;

        // Calculate the position to center the active element in the visible area
        const targetScrollTop =
          elementTop - containerHeight / 2 + elementHeight / 2;

        // Ensure we don't scroll beyond the bounds
        const maxScrollTop = scrollContainer.scrollHeight - containerHeight;
        const finalScrollTop = Math.max(
          0,
          Math.min(targetScrollTop, maxScrollTop)
        );

        // Scroll to the target position
        scrollContainer.scrollTo({
          top: finalScrollTop,
          behavior: "smooth",
        });
      }
    };

    // Function to enable auto-scroll
    const enableAutoScroll = () => {
      if (!autoScrollEnabled) {
        autoScrollEnabled = true;
        // Resume periodic checks
        startPeriodicCheck();
      }
    };

    // Function to disable auto-scroll
    const disableAutoScroll = () => {
      if (autoScrollEnabled) {
        autoScrollEnabled = false;
        // Stop periodic checks
        if (periodicCheckInterval) {
          clearInterval(periodicCheckInterval);
          periodicCheckInterval = null;
        }
      }
    };

    // Function to start periodic check
    const startPeriodicCheck = () => {
      if (!periodicCheckInterval) {
        periodicCheckInterval = setInterval(() => {
          scrollTocToActive();
        }, 5000); // Increased interval to 5 seconds
      }
    };

    // Handle TOC scrolling
    scrollContainer.addEventListener("scroll", () => {
      isUserScrolling = true;
      disableAutoScroll(); // Disable auto-scroll when user scrolls TOC

      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }

      scrollTimeout = setTimeout(() => {
        isUserScrolling = false;
        // Don't automatically re-enable auto-scroll here
        // It will be re-enabled when user interacts with main page
      }, 500);
    });

    // Handle page scrolling
    window.addEventListener("scroll", () => {
      enableAutoScroll(); // Re-enable auto-scroll when user scrolls main page

      if (pageScrollTimeout) {
        clearTimeout(pageScrollTimeout);
      }

      pageScrollTimeout = setTimeout(() => {
        scrollTocToActive();
      }, 100);
    });

    // Handle clicks on main page content
    document.addEventListener("click", (event) => {
      // Only enable auto-scroll if click is not on TOC
      if (!sidebarNav.contains(event.target)) {
        enableAutoScroll();
      }
    });

    // Handle keyboard navigation
    document.addEventListener("keydown", () => {
      enableAutoScroll();
    });

    // Initial scroll to active element
    setTimeout(() => {
      scrollTocToActive();
    }, 1000);

    // Start periodic check
    startPeriodicCheck();
  });
</script>


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://ambersuncreates.com/" itemprop="url">Shawn Hsu</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>For it isn’t by size that you win or fail</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Taipei, Taiwan</span>
        </li>
      

      
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/ambersun1234" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/ambersun1234" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
      

      

      
        <li>
          <a href="mailto:ambersun1019.shawn@gmail.com" rel="me" class="u-email">
            <meta itemprop="email" content="ambersun1019.shawn@gmail.com">
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="關於 Python 你該知道的那些事 - GIL(Global Interpreter Lock)">
    <meta itemprop="description" content="Preface">
    <meta itemprop="datePublished" content="2022-01-16T00:00:00+08:00">
    <meta itemprop="dateModified" content="2024-05-14T21:13:03+08:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://ambersuncreates.com/random/python-gil/" class="u-url" itemprop="url">關於 Python 你該知道的那些事 - GIL(Global Interpreter Lock)
</a>
          </h1>
          


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2022-01-16">2022-01-16</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2024-05-14">
            2024-05-14
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/random/python-gil/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/random/python-gil/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/random/python-gil/").innerHTML = text;
      }
    })
</script>

        </header>
      

      <section class="page__content e-content" itemprop="text" style="margin-top: 2em">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
<li><a href="#preface">Preface</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#atomic-operation">Atomic Operation</a></li>
<li>
<a href="#concurrency-vs-parallelism">Concurrency vs. Parallelism</a><ul>
<li><a href="#concurrency">Concurrency</a></li>
<li><a href="#parallelism">Parallelism</a></li>
</ul>
</li>
<li>
<a href="#why-multicore-slower-than-single-core">Why Multicore Slower than Single Core</a><ul><li><a href="#what-does-thread-waiting-for">What does Thread Waiting for?</a></li></ul>
</li>
<li><a href="#cpu-bound-vs-io-bound">CPU-bound vs. I/O-bound</a></li>
<li>
<a href="#gil---global-interpreter-lock">GIL - Global Interpreter Lock</a><ul><li>
<a href="#when-will-gil-be-released">When will GIL be Released</a><ul>
<li><a href="#io">I/O</a></li>
<li><a href="#timeout">timeout</a></li>
</ul>
</li></ul>
</li>
<li><a href="#why-do-we-need-threadinglock-if-we-have-gil">Why do we Need threading.Lock if we have GIL</a></li>
<li><a href="#how-about-real-threading">How about Real Threading</a></li>
<li>
<a href="#eliminate-gil">Eliminate GIL</a><ul><li><a href="#pep-703">PEP-703</a></li></ul>
</li>
<li><a href="#reference">Reference</a></li>
</ul>

            </nav>

            <br>

            <div class="sidebar__top_down" style="display: flex;">
              <div>
                <nav style="padding: 0 0.5em;">
                  <a href="#site-nav"> <i class="fas fa-angle-double-up fa-2x"></i></a>
                </nav>
              </div>

              <div>
                <nav style="padding: 0 0.5em;">
                  <a href="#footer"> <i class="fas fa-angle-double-down fa-2x"></i></a>
                </nav>
              </div>
            </div>

            
          </aside>
        
        <h1 id="preface">Preface</h1>

<p>我一開始用 python 開發多執行緒的程式的時候<br>
學長姐都告誡我說不要使用 <a href="https://docs.python.org/3/library/threading.html">threading</a> 而是要使用 <a href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing</a> 這個 library<br>
因為後者才是 <strong>真正的 threading</strong></p>

<p>我就好奇啦<br>
甚麼叫做 真正的 threading?</p>

<h1 id="introduction">Introduction</h1>

<p>python 擁有不只一套實作，包含 <a href="https://www.jython.org/">Jython</a>, <a href="https://ironpython.net/">IronPython</a>, <a href="https://github.com/python/cpython">Cpython</a> 等等的<br>
就如同 C 語言有不同的實作一樣 <a href="https://gcc.gnu.org/">GCC</a>, <a href="https://docs.microsoft.com/zh-tw/cpp/windows/latest-supported-vc-redist?view=msvc-170">Visual c++</a> 等等的</p>

<p>GIL, Global Interpreter Lock 是一個 <strong><em>類</em></strong> <a href="https://en.wikipedia.org/wiki/Mutual_exclusion">mutex</a>，用於保護在多執行緒之下的物件
而他目前僅存在於 Cpython 的實作當中(因為 Cpython 的記憶體管理實作並非是 thread-safe 的)</p>

<p><img src="https://www.w3.org/People/Frystyk/thesis/MultiStackThread.gif" alt=""></p>

<blockquote>
  <p>Thread 只有 stack 是各自擁有的，其餘都是共享的</p>
</blockquote>

<h1 id="atomic-operation">Atomic Operation</h1>

<p>在多執行緒下首要目標即是確保資料的正確性，而多執行緒的程式在執行的時候，其執行順序有可能是混亂的<br>
如果這時候你又在多條執行緒中共享變數 那麼就有可能造成資料在計算的過程中出現差錯</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td>
<td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">dis</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">num</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">dis</span><span class="p">.</span><span class="n">dis</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>考慮以上程式碼，如果我們將上述 add 程式碼進行反組譯成 python bytecode 我們可以得到以下</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre>  4           0 LOAD_FAST                0 (num)
              2 LOAD_CONST               1 (1)
              4 INPLACE_ADD
              6 STORE_FAST               0 (num)

  5           8 LOAD_FAST                0 (num)
             10 RETURN_VALUE
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>第一列數字對應到原始程式碼行數 第二列是 python bytecode 的執行指令<br>
你可以很輕易的看到 在短短的 <code class="language-plaintext highlighter-rouge">num += 1</code> 這行裡面它實際上執行了 <strong><em>4 條指令</em></strong><br>
那有沒有可能你在執行到 <code class="language-plaintext highlighter-rouge">INPLACE_ADD</code> 的時候，中間被 thread1 被 swap out 然後換 thread2 執行，就拿到錯誤的資料了呢?<br>
答案很明顯 如果沒有做適當的處理, 100% 一定會遇到這個問題(然後你的程式就出錯 你就會被老闆臭罵一頓)</p>

<p>上述的 LOAD_FAST, LOAD_CONST 就是所謂的 atmoic operation<br>
是不可被打斷的(意即不能被 interrupt)</p>

<blockquote>
  <p>有些 compiler 或 interpreter 在執行的時候會為了最佳化而移動指令順序<br>
這種貼心的舉動有時候會造成問題<br>
這時候就需要 <a href="https://en.wikipedia.org/wiki/Memory_barrier">memory barrier</a></p>
</blockquote>

<p>題外話，這些 python byte code 是透過 python virtual machine(PVM) 所執行的(跟 Java 一樣)<br>
Cpython 的實作包含了一個 virtual machine 用以執行上面我們看到的 python byte code</p>

<blockquote>
  <p>注意到 Cpython 是 interpreter，Cython 是一種語言</p>
</blockquote>

<h1 id="concurrency-vs-parallelism">Concurrency vs. Parallelism</h1>

<p>單位時間內只有一個 thread 在跑的算是平行處理嗎? 那肯定是阿
<img src="https://media.licdn.com/dms/image/C4E12AQE2NS4xfB3k5A/article-inline_image-shrink_1000_1488/0/1592126129434?e=1681344000&amp;v=beta&amp;t=l8zZRSZE3HAMI4XxK6uMt9f-pwqlRAaFnoRCphRiwQQ" alt=""></p>

<h2 id="concurrency">Concurrency</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:828/format:webp/1*HCZSJX-XJxrOvQlKcabvmQ.png" alt="">
concurrency 是將 <code class="language-plaintext highlighter-rouge">一個切成不同的子部份</code>，將這些 <code class="language-plaintext highlighter-rouge">子部份</code> 給不同 worker, 每個 worker 各司其職, 負責完成 <strong><em>不同部分</em></strong></p>

<blockquote>
  <p>ref: <a href="https://medium.com/mr-efacani-teatime/concurrency%E8%88%87parallelism%E7%9A%84%E4%B8%8D%E5%90%8C%E4%B9%8B%E8%99%95-1b212a020e30">Concurrency與Parallelism的不同之處</a></p>
</blockquote>

<h2 id="parallelism">Parallelism</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:828/format:webp/1*_CVfYVLNSrpzZhwwB4D1pg.png" alt="">
parallelism 是將 n 個 task 分割給多個 worker, 每個 worker 都執行 <strong><em>完整的 task</em></strong> 內容</p>

<blockquote>
  <p>ref: <a href="https://medium.com/mr-efacani-teatime/concurrency%E8%88%87parallelism%E7%9A%84%E4%B8%8D%E5%90%8C%E4%B9%8B%E8%99%95-1b212a020e30">Concurrency與Parallelism的不同之處</a></p>
</blockquote>

<h1 id="why-multicore-slower-than-single-core">Why Multicore Slower than Single Core</h1>

<p>接下來我們就做點實驗來驗證以及探詢為甚麼 python 多執行緒下反而會比較慢的情況<br>
在這之前我們要準備點工具以及程式碼來幫助我們驗證</p>

<p>測試環境</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux station 5.11.0-46-generic <span class="c">#51~20.04.1-Ubuntu SMP Fri Jan 7 06:51:40 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>
<span class="nv">$ </span>python3 <span class="nt">--version</span>
Python 3.8.10
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>我們先測量一下 threading 與單純的 for-loop 各個執行時間<br>
考慮以下實作程式碼</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td>
<td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">thread_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">mysum</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">result</span>

    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="n">thread_lock</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="n">num</span>
        <span class="n">thread_lock</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">thread_pool</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">worker</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">1000000</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">chunk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">worker</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">%</span> <span class="n">worker</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Cannot divide equally to each thread"</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># measure threading execution time
</span>    <span class="n">start_t</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">worker</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">chunk</span>
        <span class="n">thread_pool</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">mysum</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="p">)))</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
        <span class="n">thread_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">worker</span><span class="p">):</span>
        <span class="n">thread_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">join</span><span class="p">()</span>
    <span class="n">end_t</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">end_t</span> <span class="o">-</span> <span class="n">start_t</span><span class="p">)</span>

    <span class="c1"># measure for-loop execution time
</span>    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">start_t</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
      <span class="n">result</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="n">end_t</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">end_t</span> <span class="o">-</span> <span class="n">start_t</span><span class="p">)</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>得到的執行結果為</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"> </th>
      <th style="text-align: center">執行時間</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">for-loop</td>
      <td style="text-align: center">0.085470438003540 sec</td>
    </tr>
    <tr>
      <td style="text-align: center">single thread</td>
      <td style="text-align: center">0.282294273376464 sec</td>
    </tr>
    <tr>
      <td style="text-align: center">5 條 thread</td>
      <td style="text-align: center">6.306507110595703 sec</td>
    </tr>
    <tr>
      <td style="text-align: center">10 條 thread</td>
      <td style="text-align: center">6.836602449417114 sec</td>
    </tr>
  </tbody>
</table>

<p>這時候你就發現奇怪<br>
怎麼 thread 變多反而比較慢</p>

<hr>

<p>讓我們來對其 profiling 一下<br>
使用內建 <a href="https://docs.python.org/3/library/profile.html">cProfile</a> 對其進行分析，需要注意的是 cProfile 僅能針對 main thread 進行 profile<br>
我參考了 <a href="https://stackoverflow.com/a/1922945">How can you profile a Python script?</a> 的作法 override <code class="language-plaintext highlighter-rouge">threading.Thread</code> 的 <code class="language-plaintext highlighter-rouge">start function</code><br>
這樣就可以對每個 thread profile 了(見下圖)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td>
<td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ProfiledThread</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="p">.</span><span class="n">Profile</span><span class="p">()</span>

      <span class="k">try</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">pr</span><span class="p">.</span><span class="n">runcall</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
      <span class="k">finally</span><span class="p">:</span>
          <span class="n">pstats</span><span class="p">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">pr</span><span class="p">).</span><span class="n">sort_stats</span><span class="p">(</span><span class="s">"time"</span><span class="p">).</span><span class="n">print_stats</span><span class="p">()</span>

<span class="c1"># usage
# threading.Thread(target=mysum, args=(int(start), int(end),))
</span><span class="n">ProfiledThread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">mysum</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="p">))</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>為什麼不 overwrite <code class="language-plaintext highlighter-rouge">run</code>? 因為 run 就真的只是單純的 run function，顯然我們在乎的效能瓶頸不在 run 的時候發生</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td>
<td class="rouge-code"><pre>         20 function calls in 0.005 seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        4    0.005    0.001    0.005    0.001 {method 'acquire' of '_thread.lock' objects}
        1    0.000    0.000    0.000    0.000 {built-in method _thread.start_new_thread}
        1    0.000    0.000    0.005    0.005 /usr/lib/python3.8/threading.py:270(wait)
        1    0.000    0.000    0.005    0.005 /usr/lib/python3.8/threading.py:834(start)
        1    0.000    0.000    0.005    0.005 /usr/lib/python3.8/threading.py:540(wait)
        1    0.000    0.000    0.000    0.000 /usr/lib/python3.8/threading.py:249(__exit__)
        1    0.000    0.000    0.000    0.000 /usr/lib/python3.8/threading.py:246(__enter__)
        1    0.000    0.000    0.000    0.000 /usr/lib/python3.8/threading.py:255(_release_save)
        1    0.000    0.000    0.000    0.000 /usr/lib/python3.8/threading.py:261(_is_owned)
        1    0.000    0.000    0.000    0.000 /usr/lib/python3.8/threading.py:258(_acquire_restore)
        1    0.000    0.000    0.000    0.000 {method '__enter__' of '_thread.lock' objects}
        1    0.000    0.000    0.000    0.000 {method 'disable' of '_lsprof.Profiler' objects}
        1    0.000    0.000    0.000    0.000 {method 'append' of 'collections.deque' objects}
        1    0.000    0.000    0.000    0.000 {built-in method _thread.allocate_lock}
        1    0.000    0.000    0.000    0.000 /usr/lib/python3.8/threading.py:513(is_set)
        1    0.000    0.000    0.000    0.000 {method 'release' of '_thread.lock' objects}
        1    0.000    0.000    0.000    0.000 {method '__exit__' of '_thread.lock' objects}
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>取其中一個 thread 的 profiling 結果來看<br>
我們可以很清楚的看到是 <strong><em>acquire lock</em></strong> 以及 <strong><em>wait</em></strong> 佔用了最多的時間</p>

<h2 id="what-does-thread-waiting-for">What does Thread Waiting for?</h2>

<p>讓我們來仔細看看 Cpython 實作程式碼是怎麼做的</p>

<p><a href="https://github.com/python/cpython/blob/3.8/Lib/threading.py#L34">Lib/threading.py#34</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td>
<td class="rouge-code"><pre><span class="n">_allocate_lock</span> <span class="o">=</span> <span class="n">_thread</span><span class="p">.</span><span class="n">allocate_lock</span>

<span class="p">...</span>

<span class="n">Lock</span> <span class="o">=</span> <span class="n">_allocate_lock</span>

<span class="p">...</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p><a href="https://github.com/python/cpython/blob/3.8/Lib/threading.py#L494">Lib/threading.py#494</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td>
<td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_cond</span> <span class="o">=</span> <span class="n">Condition</span><span class="p">(</span><span class="n">Lock</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">"""Block until the internal flag is true.
        If the internal flag is true on entry, return immediately. Otherwise,
        block until another thread calls set() to set the flag to true, or until
        the optional timeout occurs.
        When the timeout argument is present and not None, it should be a
        floating point number specifying a timeout for the operation in seconds
        (or fractions thereof).
        This method returns the internal flag on exit, so it will always return
        True except if a timeout is given and the operation times out.
        """</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">_cond</span><span class="p">:</span>
            <span class="n">signaled</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_flag</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">signaled</span><span class="p">:</span>
                <span class="n">signaled</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_cond</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">signaled</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p><a href="https://github.com/python/cpython/blob/3.8/Lib/threading.py#L834">Lib/threading.py#834</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td>
<td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Thread</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="p">...</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">_started</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>

    <span class="p">...</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Start the thread's activity.
        It must be called at most once per thread object. It arranges for the
        object's run() method to be invoked in a separate thread of control.
        This method will raise a RuntimeError if called more than once on the
        same thread object.
        """</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">"thread.__init__() not called"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">_started</span><span class="p">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="k">raise</span> <span class="nb">RuntimeError</span><span class="p">(</span><span class="s">"threads can only be started once"</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">_active_limbo_lock</span><span class="p">:</span>
            <span class="n">_limbo</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_start_new_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_bootstrap</span><span class="p">,</span> <span class="p">())</span>
        <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">_active_limbo_lock</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">_limbo</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>
            <span class="k">raise</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_started</span><span class="p">.</span><span class="n">wait</span><span class="p">()</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>當我們 start 一條新的 thread 的時候, 它會初始化一些東西(<code class="language-plaintext highlighter-rouge">self._bootstrap</code>)<br>
而當所有事情完成了之後，它會等待 event object 的 <code class="language-plaintext highlighter-rouge">_flag</code>(<img class="emoji" title=":arrow_right:" alt=":arrow_right:" src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png" height="20" width="20"> 當這個 flag 為 true 的時候意味著該條 thread 可以開始執行)<br>
乍看之下每條 thread 都各自擁有 event object，既然如此為什麼還需要 acquire lock?<br>
event object 的 condition lock 實際上是 low-level 的 threading lock <a href="https://docs.python.org/3/library/_thread.html#thread.allocate_lock">_thread.allocate_lock</a><br>
而官方文件指出，在單位時間內只有一條 thread 可以成功 acquire lock</p>

<blockquote>
  <p>only one thread at a time can acquire a lock — that’s their reason for existence</p>
</blockquote>

<h1 id="cpu-bound-vs-io-bound">CPU-bound vs. I/O-bound</h1>

<p>在計算機系統裡面 任務大多分為兩大類</p>

<ul>
  <li>CPU-bound
    <ul>
      <li>任務多以吃重 cpu 運算為主, e.g. 圖形運算，數學運算等等的</li>
    </ul>
  </li>
  <li>I/O-bound
    <ul>
      <li>任務多以吃重 i/o 為主, e.g. 在電腦中尋找特定檔案，資料庫讀寫，網路資料傳輸</li>
    </ul>
  </li>
</ul>

<h1 id="gil---global-interpreter-lock">GIL - Global Interpreter Lock</h1>

<p>既然 Cpython 的實作並不保證 thread-safe，那麼最簡單的作法是甚麼呢? 加上一道鎖(鑰匙) <code class="language-plaintext highlighter-rouge">lock</code></p>

<p>ㄟ等等 全域的 lock ?</p>

<p>沒錯，interpreter 為了確保資料的正確性，設計出了一種 <strong><em>類</em></strong> <a href="https://en.wikipedia.org/wiki/Mutual_exclusion">mutex</a> lock<br>
由當前執行的 thread 持有<br>
只有擁有 mutex lock 的 thread 可以操作 python object<br>
也就是上面實驗得出的結果(單位時間內只有一條 thread 可以操作)</p>

<blockquote>
  <p>/* A pthread mutex isn’t sufficient to model the Python lock type<br>
 * because, according to Draft 5 of the docs (P1003.4a/D5), both of the<br>
 * following are undefined:<br>
 * -&gt; a thread tries to lock a mutex it already has locked<br>
 * -&gt; a thread tries to unlock a mutex locked by a different thread<br>
 * pthread mutexes are designed for serializing threads over short pieces<br>
 * of code anyway, so wouldn’t be an appropriate implementation of<br>
 * Python’s locks regardless.<br>
 <a href="https://github.com/python/cpython/blob/313f92a57bc3887026ec16adb536bb2b7580ce47/Python/thread_pthread.h#L177">Cpython/Python/thread_pthread.h#177</a></p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">char</span>             <span class="n">locked</span><span class="p">;</span> <span class="cm">/* 0=unlocked, 1=locked */</span>
    <span class="cm">/* a &lt;cond, mutex&gt; pair to handle an acquire of a locked lock */</span>
    <span class="n">pthread_cond_t</span>   <span class="n">lock_released</span><span class="p">;</span>
    <span class="n">pthread_mutex_t</span>  <span class="n">mut</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pthread_lock</span><span class="p">;</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>原開發者在 pthread 的基礎上又多提供了 <code class="language-plaintext highlighter-rouge">locked</code> 變數，用以區別它是否被 locked 了</p>

<blockquote>
  <p>The Python interpreter is not fully thread-safe. In order to support multi-threaded Python programs, there’s a global lock, called the global interpreter lock or GIL - <a href="https://docs.python.org/3/c-api/init.html#thread-state-and-the-global-interpreter-lock">Thread State and the Global Interpreter Lock</a></p>
</blockquote>

<h2 id="when-will-gil-be-released">When will GIL be Released</h2>

<p>最直覺的想法，當當前 thread 執行結束之後就會 release GIL<br>
但如果你的計算要持續一段時間呢？</p>

<p>所以一般來說 GIL 會有兩種時機會自動釋放 GIL, <code class="language-plaintext highlighter-rouge">I/O</code> 與 <code class="language-plaintext highlighter-rouge">timeout</code></p>

<h3 id="io">I/O</h3>
<p>當你在做 I/O 的時候，你就不會動到 python object 了，所以就可以 release GIL</p>

<h3 id="timeout">timeout</h3>
<p>為了鼓勵 thread 可以自動 release GIL, python 內部有所謂的 timeout 機制<br>
預設的 timeout 時間是 <strong><em>0.005 second</em></strong>(你可以用 <code class="language-plaintext highlighter-rouge">sys.{get,set}switchinterval()</code> 來查詢以及設定 timeout 時間)<br>
當 timeout 到了的時候，它也不一定會理你(你可以用 <code class="language-plaintext highlighter-rouge">FORCE_SWITCHING</code> 來強制 scheduler 進行排程)<br>
那為什麼 timeout 到了不一定有用？</p>

<p>根據 <a href="https://github.com/python/cpython/blob/f4c03484da59049eb62a9bf7777b963e2267d187/Python/ceval_gil.h#L33">GIL implementation note</a>, <code class="language-plaintext highlighter-rouge">opcodes can take an arbitrary time to execute</code><br>
因為 python bytecode 並不能很好的反應到每一台機器的 machine code, 也因為 bytecode 可能包含 I/O 所以每個指令執行起來的時間都不盡相同<br>
上面我們有稍微提到，python 是執行在 PVM(Python Virtual Machine) 之上的，而這個 VM 他是採用 <strong>cooperative scheduling</strong> 的方式<br>
所以這就是為什麼當 timeout 的時候，thread 是有可能不理你的，cooperative scheduling 講究的是主動放棄 lock(以 python 來說是透過 <code class="language-plaintext highlighter-rouge">yield</code>)</p>

<p>另外就是如今 I/O 都有 buffering 的機制，即使 timeout 被 swap out，有了 buffer 的機制讓 I/O 的時間 <strong><em>短到可以再重新 acquire lock</em></strong>，造成其他 thread 等待 GIL 的時間越來越長(starving)</p>

<h1 id="why-do-we-need-threadinglock-if-we-have-gil">Why do we Need threading.Lock if we have GIL</h1>

<p>我在做實驗的時候，發現了一個很神奇的現象<br>
就是如果我不把 result 這個變數用 <code class="language-plaintext highlighter-rouge">threading.Lock</code> 鎖起來 好像…也不會錯阿？</p>

<p>稍微想了一下既然 GIL 的目的是確保同一個時間只有一條 thread 在使用 python interpreter(或者說 同一時間只有一條 thread 可以存取 python object)<br>
那 “同一時間” 不就保證它一次只會有一個人存取了……嗎 <img class="emoji" title=":question:" alt=":question:" src="https://github.githubassets.com/images/icons/emoji/unicode/2753.png" height="20" width="20"></p>

<p>如果有仔細看上面的 <a href="#atomic-operation">Atomic Operation</a> 你就會意識到事情才沒有那麼簡單<br>
因為如果說 python bytecode 執行到一半被 interrupt，GIL 交給另外一條 thread 那你的計算結果就會出錯了</p>

<p>另一個直觀的方法是開多一點 thread 下去跑答案就會錯了(我是開 100 條 thread)</p>

<blockquote>
  <p>GIL 單位時間內只有一條 thread 可以擁有，但不代表它不會中途被搶走</p>
</blockquote>

<h1 id="how-about-real-threading">How about Real Threading</h1>

<p>既然 <a href="https://docs.python.org/3/library/threading.html">threading</a> 是 concurrency 的一種，如果你要真正的 threading 你就必須要使用 <a href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing</a><br>
multiprocessing 實際上使用了一個巧妙的技巧去避開 GIL 的限制，既然 mutex lock 只有一把，那我 fork 出一個 subprocess 我不就也有一把鑰匙了嗎?<br>
而事實上也的確如此，透過 fork 一個 child process 出來就能夠實現 <strong><em>真正的多工了</em></strong></p>

<p>考慮以下程式碼</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
<td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">spin</span><span class="p">():</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"child thread: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"main thread: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">getpid</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
      <span class="n">proc</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">spin</span><span class="p">))</span>
      <span class="n">proc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
      <span class="n">proc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">join</span><span class="p">()</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/multiprocessing2.png" alt=""><br>
為了驗證他的 parent-child 關係，我們打開 <a href="https://htop.dev/">htop</a> 進行驗證<br>
<img src="/assets/img/posts/multiprocessing.png" alt=""><br>
透過 tree view 我們可以確認其 parent-child 的關係 證明了 multiprocessing 是透過 subprocess 的方式做到 parallel 的</p>

<p>但 multiprocessing 缺點也很明顯，解決了 race condition 造成的資料不正確，卻讓 share data 更困難了<br>
作業系統課堂中有學過，process 之間是不會共享資料的<br>
如果多個 process 要溝通必須要透過 InterProcess Communication(IPC) 的機制去執行，而他大致上分為兩種</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">shared memory</code>: 透過建立一個 公有區域，將資料放置於其中，透過拿取(read)、寫入(write)以進行溝通(c.f. <a href="https://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem">Producer–consumer problem</a>)</li>
  <li>
<code class="language-plaintext highlighter-rouge">message passing</code>: 建立溝通渠道(pipe)以進行溝通</li>
</ul>

<h1 id="eliminate-gil">Eliminate GIL</h1>

<p>如果要完全避開討人厭的 GIL<br>
現今除了 Cpython 的實作之外，也是有其他實作像是 Jython, IronPython 等等的可以使用</p>

<p>不過也是有人提出了可以完全去除 GIL 的實作，就列出來當作參考<br>
<a href="https://github.com/colesbury/nogil">colesbury/nogil</a></p>

<h2 id="pep-703">PEP-703</h2>
<p>在 2023 年初，python 內部提出了 <a href="https://peps.python.org/pep-0703">PEP-703</a><br>
旨在消滅 GIL, 而這項 proposal 已經被正式被接受了</p>

<p>消滅 GIL 是好事嗎？<br>
開發者現在必須要手動的控制各種 lock 的狀態避免 race condition<br>
給了更大的彈性，能夠更好的處理多執行緒<br>
同一時間，在撰寫上也必須要更加的小心了</p>

<p>根據 <a href="https://peps.python.org/pep-0703/#container-thread-safety">PEP-703 Container Thread Safety</a> 中所述</p>

<blockquote>
  <p>This PEP proposes using per-object locks to provide many of the same protections that the GIL provides. <br>
For example, every list, dictionary, and set will have an associated lightweight lock. <br>
All operations that modify the object must hold the object’s lock. <br>
Most operations that read from the object should acquire the object’s lock as well; <br>
the few read operations that can proceed without holding a lock are described below.</p>
</blockquote>

<p>想當然，沒有全局的 lock, 區域的 lock 的引入勢必是必要的<br>
他們是說這個是一個 lightweight lock 就是<br>
不過對於效能的影響性大嗎？</p>

<blockquote>
  <p>一個簡單的概念就是盡量讓 critical section 小</p>
</blockquote>

<p>根據 <a href="https://peps.python.org/pep-0703/#performance">PEP-703 Performance</a> 的結果</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: left">Intel Skylake</th>
      <th style="text-align: left">AMD Zen 3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">One thread</td>
      <td style="text-align: left">6%</td>
      <td style="text-align: left">5%</td>
    </tr>
    <tr>
      <td style="text-align: left">Multiple threads</td>
      <td style="text-align: left">8%</td>
      <td style="text-align: left">7%</td>
    </tr>
  </tbody>
</table>

<p>它其實是增加 overhead 的！<br>
因為引入了 per-object locks 的結果所以算是可以預期的</p>

<p>但為什麼多執行緒的情況下反而更糟呢？</p>

<blockquote>
  <p>For thread-safety reasons, <br>
an application running with multiple threads will only specialize a given bytecode once; <br>
this is why the overhead for programs that use multiple threads is larger compared to programs that only use one thread.</p>
</blockquote>

<p>何謂 specialize?<br>
根據 <a href="https://peps.python.org/pep-0659/">PEP-659</a></p>

<blockquote>
  <p>At runtime, Python will try to look for common patterns and type stability in the executing code. <br>
Python will then replace the current operation with a more specialized one.</p>
</blockquote>

<p>基本上因為 python 是動態語言，而 cpython 內部實作有針對那些常見的 pattern 做了處理，將它替換成 <strong>specialized</strong> 的實作<br>
想當然是為了優化的那類東西</p>

<p>而因為多執行緒的解放<br>
同一段 code 的優化就不再只有單一解答<br>
而是根據不同的 thread 處理的情況來做特別優化的處理(你怎麼拆 task 會導致優化出不同結果)<br>
所以官方的 benchmark 結果，多執行緒下更慢</p>

<h1 id="reference">Reference</h1>

<ul>
  <li><a href="https://python.land/python-concurrency/the-python-gil">The Python GIL (Global Interpreter Lock)</a></li>
  <li><a href="https://docs.python.org/3/c-api/init.html#thread-state-and-the-global-interpreter-lock">Thread State and the Global Interpreter Lock</a></li>
  <li><a href="https://speakerdeck.com/dabeaz/understanding-the-python-gil">Understanding the Python GIL</a></li>
  <li><a href="https://www.loginradius.com/blog/async/concurrency-vs-parallelism/">Concurrency vs Parallelism: What’s the Difference?</a></li>
  <li><a href="https://stackoverflow.com/a/1922945">How can you profile a Python script?</a></li>
  <li><a href="https://pythonspeed.com/articles/custom-python-profiler/">Not just CPU: writing custom profilers for Python</a></li>
  <li><a href="https://stackoverflow.com/questions/40072873/why-do-we-need-locks-for-threads-if-we-have-gil">Why do we need locks for threads, if we have GIL?</a></li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#atomic-operation" class="page__taxonomy-item p-category" rel="tag">atomic operation</a><span class="sep">, </span>
    
      <a href="/tags/#concurrency" class="page__taxonomy-item p-category" rel="tag">concurrency</a><span class="sep">, </span>
    
      <a href="/tags/#gil" class="page__taxonomy-item p-category" rel="tag">gil</a><span class="sep">, </span>
    
      <a href="/tags/#parallelism" class="page__taxonomy-item p-category" rel="tag">parallelism</a><span class="sep">, </span>
    
      <a href="/tags/#python" class="page__taxonomy-item p-category" rel="tag">python</a><span class="sep">, </span>
    
      <a href="/tags/#race-condition" class="page__taxonomy-item p-category" rel="tag">race condition</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#random" class="page__taxonomy-item p-category" rel="tag">random</a>
    
    </span>
  </p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%E9%97%9C%E6%96%BC+Python+%E4%BD%A0%E8%A9%B2%E7%9F%A5%E9%81%93%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B+-+GIL%28Global+Interpreter+Lock%29%20https%3A%2F%2Fambersuncreates.com%2Frandom%2Fpython-gil%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fambersuncreates.com%2Frandom%2Fpython-gil%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fambersuncreates.com%2Frandom%2Fpython-gil%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/git/git-reset/" class="pagination--pager" title="Git 進階使用 - Git Reset
">Previous</a>
    
    
      <a href="/website/website-restful-api/" class="pagination--pager" title="網頁程式設計三兩事 - RESTful API
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/kubernetes/kubernetes-traffic/" rel="permalink">Kubernetes 從零開始 - 在分散式的世界實現 Zero Downtime 路由管理
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-10-16">2025-10-16</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2024-05-14">
            2024-05-14
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/kubernetes/kubernetes-traffic/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/kubernetes/kubernetes-traffic/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/kubernetes/kubernetes-traffic/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">Proxy
Proxy 是一個中間人，負責處理 client 與 server 之間的溝通請求
相比於 client 直接與 server 溝通，Proxy 的優勢在於可以進行流量控制、負載平衡、安全性控制等
他可以分為兩類 Forward Proxy 以及 Reverse Proxy

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/kubernetes/kubernetes-scale/" rel="permalink">Kubernetes 從零開始 - 部署策略 101
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          27 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-09-24">2025-09-24</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2024-05-14">
            2024-05-14
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/kubernetes/kubernetes-scale/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/kubernetes/kubernetes-scale/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/kubernetes/kubernetes-scale/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">Scaling Workloads
只有單台機器服務的情況下，多數是不足的
因為你需要考量到，比如說服務突然的不可用(軟體錯誤、硬體故障等等的)，或者是流量真的大到一台機器處理不來的情況
這時候你就會需要用到 “scaling” 的概念

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/database/database-delayed-queue/" rel="permalink">資料庫 - Delayed Queue 的設計與考量
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-08-18">2025-08-18</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2024-05-14">
            2024-05-14
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/database/database-delayed-queue/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/database/database-delayed-queue/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/database/database-delayed-queue/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">What is Delayed Queue?
Delayed Queue 是一種特殊的 message queue
與一般的 message queue 不同，Delayed Queue 裡面的資料並不會被立即取出
你可以對每個 message 設定一個延遲時間
只有當時間到了之後，資料才可以被 consumer...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/random/syslog/" rel="permalink">玩轉 Syslog 第一次就上手
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          5 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-06-23">2025-06-23</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2024-05-14">
            2024-05-14
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/random/syslog/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/random/syslog/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/random/syslog/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">Introduction to Syslog
任何運行中的系統都會有 Log，主要是為了方便除錯、監控以及分析等等的
可以說沒有 Log 的系統是沒有辦法運作的

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

<script type="text/javascript">
  let viewHeight = window. innerHeight;
  let codeblocks = document.getElementsByClassName("highlight");

  Array.from(codeblocks).forEach(value => {
      if (value.scrollHeight > viewHeight) {
          value.setAttribute("style", "height:100vh;overflow-y:auto;");
      }
  })
</script>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
          <li><a href="https://github.com/ambersun1234" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">© 2025 Shawn Hsu. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q9EYCKB89S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Q9EYCKB89S', { 'anonymize_ip': false});
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://ambersuncreates.com/random/python-gil/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/random/python-gil"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://https-ambersun1234-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>


  


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
    },
    "HTML-CSS": {
      scale: 80
    }
  });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> 




  </body>
</html>
