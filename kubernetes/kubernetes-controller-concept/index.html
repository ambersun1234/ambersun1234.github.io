<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Kubernetes 從零開始 - Informer 架構以及 Controller Pattern | Shawn Hsu</title>
<meta name="description" content="Kubernetes controller 是一個管理 cluster 狀態的重要元件，透過 controller 你可以管理自己的 custom resource。本文將介紹 controller 的基本概念以及其原理。">


  <meta name="author" content="Shawn Hsu">
  
  <meta property="article:author" content="Shawn Hsu">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Shawn Hsu">
<meta property="og:title" content="Kubernetes 從零開始 - Informer 架構以及 Controller Pattern">
<meta property="og:url" content="https://ambersuncreates.com/kubernetes/kubernetes-controller-concept/">


  <meta property="og:description" content="Kubernetes controller 是一個管理 cluster 狀態的重要元件，透過 controller 你可以管理自己的 custom resource。本文將介紹 controller 的基本概念以及其原理。">


<meta property="og:image" content="/assets/img/og/kubernetes-controller-concept.png">




  <meta property="article:published_time" content="2025-02-07T00:00:00+08:00">



  <meta property="article:modified_time" content="2025-11-23T22:32:20+08:00">



  

  


<link rel="canonical" href="https://ambersuncreates.com/kubernetes/kubernetes-controller-concept/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Shawn Hsu",
      "url": "https://ambersuncreates.com/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Shawn Hsu Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3411784157543420"
     crossorigin="anonymous"></script>

<!-- google ads -->
<script async src="https://fundingchoicesmessages.google.com/i/pub-3411784157543420?ers=1" nonce="DTHVC27nOex6L5olJXhYMg"></script><script nonce="DTHVC27nOex6L5olJXhYMg">(function() {function signalGooglefcPresent() {if (!window.frames['googlefcPresent']) {if (document.body) {const iframe = document.createElement('iframe'); iframe.style = 'width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;'; iframe.style.display = 'none'; iframe.name = 'googlefcPresent'; document.body.appendChild(iframe);} else {setTimeout(signalGooglefcPresent, 0);}}}signalGooglefcPresent();})();</script>
<script>(function(){'use strict';function aa(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}var ba="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};
  function ca(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");}var da=ca(this);function k(a,b){if(b)a:{var c=da;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))break a;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&ba(c,a,{configurable:!0,writable:!0,value:b})}}
  function ea(a){return a.raw=a}function m(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];if(b)return b.call(a);if("number"==typeof a.length)return{next:aa(a)};throw Error(String(a)+" is not an iterable or ArrayLike");}function fa(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c}var ha="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},n;
  if("function"==typeof Object.setPrototypeOf)n=Object.setPrototypeOf;else{var q;a:{var ia={a:!0},ja={};try{ja.__proto__=ia;q=ja.a;break a}catch(a){}q=!1}n=q?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var ka=n;
  function r(a,b){a.prototype=ha(b.prototype);a.prototype.constructor=a;if(ka)ka(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.A=b.prototype}function la(){for(var a=Number(this),b=[],c=a;c<arguments.length;c++)b[c-a]=arguments[c];return b}k("Number.MAX_SAFE_INTEGER",function(){return 9007199254740991});
  k("Number.isFinite",function(a){return a?a:function(b){return"number"!==typeof b?!1:!isNaN(b)&&Infinity!==b&&-Infinity!==b}});k("Number.isInteger",function(a){return a?a:function(b){return Number.isFinite(b)?b===Math.floor(b):!1}});k("Number.isSafeInteger",function(a){return a?a:function(b){return Number.isInteger(b)&&Math.abs(b)<=Number.MAX_SAFE_INTEGER}});
  k("Math.trunc",function(a){return a?a:function(b){b=Number(b);if(isNaN(b)||Infinity===b||-Infinity===b||0===b)return b;var c=Math.floor(Math.abs(b));return 0>b?-c:c}});k("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}});k("Array.prototype.includes",function(a){return a?a:function(b,c){var d=this;d instanceof String&&(d=String(d));var e=d.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=d[c];if(f===b||Object.is(f,b))return!0}return!1}});
  k("String.prototype.includes",function(a){return a?a:function(b,c){if(null==this)throw new TypeError("The 'this' value for String.prototype.includes must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype.includes must not be a regular expression");return-1!==this.indexOf(b,c||0)}});/*
  
   Copyright The Closure Library Authors.
   SPDX-License-Identifier: Apache-2.0
  */
  var t=this||self;function v(a){return a};var w,x;a:{for(var ma=["CLOSURE_FLAGS"],y=t,z=0;z<ma.length;z++)if(y=y[ma[z]],null==y){x=null;break a}x=y}var na=x&&x[610401301];w=null!=na?na:!1;var A,oa=t.navigator;A=oa?oa.userAgentData||null:null;function B(a){return w?A?A.brands.some(function(b){return(b=b.brand)&&-1!=b.indexOf(a)}):!1:!1}function C(a){var b;a:{if(b=t.navigator)if(b=b.userAgent)break a;b=""}return-1!=b.indexOf(a)};function D(){return w?!!A&&0<A.brands.length:!1}function E(){return D()?B("Chromium"):(C("Chrome")||C("CriOS"))&&!(D()?0:C("Edge"))||C("Silk")};var pa=D()?!1:C("Trident")||C("MSIE");!C("Android")||E();E();C("Safari")&&(E()||(D()?0:C("Coast"))||(D()?0:C("Opera"))||(D()?0:C("Edge"))||(D()?B("Microsoft Edge"):C("Edg/"))||D()&&B("Opera"));var qa={},F=null;var ra="undefined"!==typeof Uint8Array,sa=!pa&&"function"===typeof btoa;function G(){return"function"===typeof BigInt};var H=0,I=0;function ta(a){var b=0>a;a=Math.abs(a);var c=a>>>0;a=Math.floor((a-c)/4294967296);b&&(c=m(ua(c,a)),b=c.next().value,a=c.next().value,c=b);H=c>>>0;I=a>>>0}function va(a,b){b>>>=0;a>>>=0;if(2097151>=b)var c=""+(4294967296*b+a);else G()?c=""+(BigInt(b)<<BigInt(32)|BigInt(a)):(c=(a>>>24|b<<8)&16777215,b=b>>16&65535,a=(a&16777215)+6777216*c+6710656*b,c+=8147497*b,b*=2,1E7<=a&&(c+=Math.floor(a/1E7),a%=1E7),1E7<=c&&(b+=Math.floor(c/1E7),c%=1E7),c=b+wa(c)+wa(a));return c}
  function wa(a){a=String(a);return"0000000".slice(a.length)+a}function ua(a,b){b=~b;a?a=~a+1:b+=1;return[a,b]};var J;J="function"===typeof Symbol&&"symbol"===typeof Symbol()?Symbol():void 0;var xa=J?function(a,b){a[J]|=b}:function(a,b){void 0!==a.g?a.g|=b:Object.defineProperties(a,{g:{value:b,configurable:!0,writable:!0,enumerable:!1}})},K=J?function(a){return a[J]|0}:function(a){return a.g|0},L=J?function(a){return a[J]}:function(a){return a.g},M=J?function(a,b){a[J]=b;return a}:function(a,b){void 0!==a.g?a.g=b:Object.defineProperties(a,{g:{value:b,configurable:!0,writable:!0,enumerable:!1}});return a};function ya(a,b){M(b,(a|0)&-14591)}function za(a,b){M(b,(a|34)&-14557)}
  function Aa(a){a=a>>14&1023;return 0===a?536870912:a};var N={},Ba={};function Ca(a){return!(!a||"object"!==typeof a||a.g!==Ba)}function Da(a){return null!==a&&"object"===typeof a&&!Array.isArray(a)&&a.constructor===Object}function P(a,b,c){if(!Array.isArray(a)||a.length)return!1;var d=K(a);if(d&1)return!0;if(!(b&&(Array.isArray(b)?b.includes(c):b.has(c))))return!1;M(a,d|1);return!0}Object.freeze(new function(){});Object.freeze(new function(){});var Ea=/^-?([1-9][0-9]*|0)(\.[0-9]+)?$/;var Q;function Fa(a,b){Q=b;a=new a(b);Q=void 0;return a}
  function R(a,b,c){null==a&&(a=Q);Q=void 0;if(null==a){var d=96;c?(a=[c],d|=512):a=[];b&&(d=d&-16760833|(b&1023)<<14)}else{if(!Array.isArray(a))throw Error();d=K(a);if(d&64)return a;d|=64;if(c&&(d|=512,c!==a[0]))throw Error();a:{c=a;var e=c.length;if(e){var f=e-1;if(Da(c[f])){d|=256;b=f-(+!!(d&512)-1);if(1024<=b)throw Error();d=d&-16760833|(b&1023)<<14;break a}}if(b){b=Math.max(b,e-(+!!(d&512)-1));if(1024<b)throw Error();d=d&-16760833|(b&1023)<<14}}}M(a,d);return a};function Ga(a){switch(typeof a){case "number":return isFinite(a)?a:String(a);case "boolean":return a?1:0;case "object":if(a)if(Array.isArray(a)){if(P(a,void 0,0))return}else if(ra&&null!=a&&a instanceof Uint8Array){if(sa){for(var b="",c=0,d=a.length-10240;c<d;)b+=String.fromCharCode.apply(null,a.subarray(c,c+=10240));b+=String.fromCharCode.apply(null,c?a.subarray(c):a);a=btoa(b)}else{void 0===b&&(b=0);if(!F){F={};c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");d=["+/=",
  "+/","-_=","-_.","-_"];for(var e=0;5>e;e++){var f=c.concat(d[e].split(""));qa[e]=f;for(var g=0;g<f.length;g++){var h=f[g];void 0===F[h]&&(F[h]=g)}}}b=qa[b];c=Array(Math.floor(a.length/3));d=b[64]||"";for(e=f=0;f<a.length-2;f+=3){var l=a[f],p=a[f+1];h=a[f+2];g=b[l>>2];l=b[(l&3)<<4|p>>4];p=b[(p&15)<<2|h>>6];h=b[h&63];c[e++]=g+l+p+h}g=0;h=d;switch(a.length-f){case 2:g=a[f+1],h=b[(g&15)<<2]||d;case 1:a=a[f],c[e]=b[a>>2]+b[(a&3)<<4|g>>4]+h+d}a=c.join("")}return a}}return a};function Ha(a,b,c){a=Array.prototype.slice.call(a);var d=a.length,e=b&256?a[d-1]:void 0;d+=e?-1:0;for(b=b&512?1:0;b<d;b++)a[b]=c(a[b]);if(e){b=a[b]={};for(var f in e)Object.prototype.hasOwnProperty.call(e,f)&&(b[f]=c(e[f]))}return a}function Ia(a,b,c,d,e){if(null!=a){if(Array.isArray(a))a=P(a,void 0,0)?void 0:e&&K(a)&2?a:Ja(a,b,c,void 0!==d,e);else if(Da(a)){var f={},g;for(g in a)Object.prototype.hasOwnProperty.call(a,g)&&(f[g]=Ia(a[g],b,c,d,e));a=f}else a=b(a,d);return a}}
  function Ja(a,b,c,d,e){var f=d||c?K(a):0;d=d?!!(f&32):void 0;a=Array.prototype.slice.call(a);for(var g=0;g<a.length;g++)a[g]=Ia(a[g],b,c,d,e);c&&c(f,a);return a}function Ka(a){return a.s===N?a.toJSON():Ga(a)};function La(a,b,c){c=void 0===c?za:c;if(null!=a){if(ra&&a instanceof Uint8Array)return b?a:new Uint8Array(a);if(Array.isArray(a)){var d=K(a);if(d&2)return a;b&&(b=0===d||!!(d&32)&&!(d&64||!(d&16)));return b?M(a,(d|34)&-12293):Ja(a,La,d&4?za:c,!0,!0)}a.s===N&&(c=a.h,d=L(c),a=d&2?a:Fa(a.constructor,Ma(c,d,!0)));return a}}function Ma(a,b,c){var d=c||b&2?za:ya,e=!!(b&32);a=Ha(a,b,function(f){return La(f,e,d)});xa(a,32|(c?2:0));return a};function Na(a,b){a=a.h;return Oa(a,L(a),b)}function Oa(a,b,c,d){if(-1===c)return null;if(c>=Aa(b)){if(b&256)return a[a.length-1][c]}else{var e=a.length;if(d&&b&256&&(d=a[e-1][c],null!=d))return d;b=c+(+!!(b&512)-1);if(b<e)return a[b]}}function Pa(a,b,c,d,e){var f=Aa(b);if(c>=f||e){var g=b;if(b&256)e=a[a.length-1];else{if(null==d)return;e=a[f+(+!!(b&512)-1)]={};g|=256}e[c]=d;c<f&&(a[c+(+!!(b&512)-1)]=void 0);g!==b&&M(a,g)}else a[c+(+!!(b&512)-1)]=d,b&256&&(a=a[a.length-1],c in a&&delete a[c])}
  function Qa(a,b){var c=Ra;var d=void 0===d?!1:d;var e=a.h;var f=L(e),g=Oa(e,f,b,d);if(null!=g&&"object"===typeof g&&g.s===N)c=g;else if(Array.isArray(g)){var h=K(g),l=h;0===l&&(l|=f&32);l|=f&2;l!==h&&M(g,l);c=new c(g)}else c=void 0;c!==g&&null!=c&&Pa(e,f,b,c,d);e=c;if(null==e)return e;a=a.h;f=L(a);f&2||(g=e,c=g.h,h=L(c),g=h&2?Fa(g.constructor,Ma(c,h,!1)):g,g!==e&&(e=g,Pa(a,f,b,e,d)));return e}function Sa(a,b){a=Na(a,b);return null==a||"string"===typeof a?a:void 0}
  function Ta(a,b){var c=void 0===c?0:c;a=Na(a,b);if(null!=a)if(b=typeof a,"number"===b?Number.isFinite(a):"string"!==b?0:Ea.test(a))if("number"===typeof a){if(a=Math.trunc(a),!Number.isSafeInteger(a)){ta(a);b=H;var d=I;if(a=d&2147483648)b=~b+1>>>0,d=~d>>>0,0==b&&(d=d+1>>>0);b=4294967296*d+(b>>>0);a=a?-b:b}}else if(b=Math.trunc(Number(a)),Number.isSafeInteger(b))a=String(b);else{if(b=a.indexOf("."),-1!==b&&(a=a.substring(0,b)),!("-"===a[0]?20>a.length||20===a.length&&-922337<Number(a.substring(0,7)):
  19>a.length||19===a.length&&922337>Number(a.substring(0,6)))){if(16>a.length)ta(Number(a));else if(G())a=BigInt(a),H=Number(a&BigInt(4294967295))>>>0,I=Number(a>>BigInt(32)&BigInt(4294967295));else{b=+("-"===a[0]);I=H=0;d=a.length;for(var e=b,f=(d-b)%6+b;f<=d;e=f,f+=6)e=Number(a.slice(e,f)),I*=1E6,H=1E6*H+e,4294967296<=H&&(I+=Math.trunc(H/4294967296),I>>>=0,H>>>=0);b&&(b=m(ua(H,I)),a=b.next().value,b=b.next().value,H=a,I=b)}a=H;b=I;b&2147483648?G()?a=""+(BigInt(b|0)<<BigInt(32)|BigInt(a>>>0)):(b=
  m(ua(a,b)),a=b.next().value,b=b.next().value,a="-"+va(a,b)):a=va(a,b)}}else a=void 0;return null!=a?a:c}function S(a,b){a=Sa(a,b);return null!=a?a:""};function T(a,b,c){this.h=R(a,b,c)}T.prototype.toJSON=function(){return Ua(this,Ja(this.h,Ka,void 0,void 0,!1),!0)};T.prototype.s=N;T.prototype.toString=function(){return Ua(this,this.h,!1).toString()};
  function Ua(a,b,c){var d=a.constructor.v,e=L(c?a.h:b);a=b.length;if(!a)return b;var f;if(Da(c=b[a-1])){a:{var g=c;var h={},l=!1,p;for(p in g)if(Object.prototype.hasOwnProperty.call(g,p)){var u=g[p];if(Array.isArray(u)){var jb=u;if(P(u,d,+p)||Ca(u)&&0===u.size)u=null;u!=jb&&(l=!0)}null!=u?h[p]=u:l=!0}if(l){for(var O in h){g=h;break a}g=null}}g!=c&&(f=!0);a--}for(p=+!!(e&512)-1;0<a;a--){O=a-1;c=b[O];O-=p;if(!(null==c||P(c,d,O)||Ca(c)&&0===c.size))break;var kb=!0}if(!f&&!kb)return b;b=Array.prototype.slice.call(b,
  0,a);g&&b.push(g);return b};function Va(a){return function(b){if(null==b||""==b)b=new a;else{b=JSON.parse(b);if(!Array.isArray(b))throw Error(void 0);xa(b,32);b=Fa(a,b)}return b}};function Wa(a){this.h=R(a)}r(Wa,T);var Xa=Va(Wa);var U;function V(a){this.g=a}V.prototype.toString=function(){return this.g+""};var Ya={};function Za(a){if(void 0===U){var b=null;var c=t.trustedTypes;if(c&&c.createPolicy){try{b=c.createPolicy("goog#html",{createHTML:v,createScript:v,createScriptURL:v})}catch(d){t.console&&t.console.error(d.message)}U=b}else U=b}a=(b=U)?b.createScriptURL(a):a;return new V(a,Ya)};function $a(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)};function ab(a,b){b=String(b);"application/xhtml+xml"===a.contentType&&(b=b.toLowerCase());return a.createElement(b)}function bb(a){this.g=a||t.document||document};/*
  
   SPDX-License-Identifier: Apache-2.0
  */
  function cb(a,b){a.src=b instanceof V&&b.constructor===V?b.g:"type_error:TrustedResourceUrl";var c,d;(c=(b=null==(d=(c=(a.ownerDocument&&a.ownerDocument.defaultView||window).document).querySelector)?void 0:d.call(c,"script[nonce]"))?b.nonce||b.getAttribute("nonce")||"":"")&&a.setAttribute("nonce",c)};function db(a){a=void 0===a?document:a;return a.createElement("script")};function eb(a,b,c,d,e,f){try{var g=a.g,h=db(g);h.async=!0;cb(h,b);g.head.appendChild(h);h.addEventListener("load",function(){e();d&&g.head.removeChild(h)});h.addEventListener("error",function(){0<c?eb(a,b,c-1,d,e,f):(d&&g.head.removeChild(h),f())})}catch(l){f()}};var fb=t.atob("aHR0cHM6Ly93d3cuZ3N0YXRpYy5jb20vaW1hZ2VzL2ljb25zL21hdGVyaWFsL3N5c3RlbS8xeC93YXJuaW5nX2FtYmVyXzI0ZHAucG5n"),gb=t.atob("WW91IGFyZSBzZWVpbmcgdGhpcyBtZXNzYWdlIGJlY2F1c2UgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlIGlzIGludGVyZmVyaW5nIHdpdGggdGhpcyBwYWdlLg=="),hb=t.atob("RGlzYWJsZSBhbnkgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlLCB0aGVuIHJlbG9hZCB0aGlzIHBhZ2Uu");function ib(a,b,c){this.i=a;this.u=b;this.o=c;this.g=null;this.j=[];this.m=!1;this.l=new bb(this.i)}
  function lb(a){if(a.i.body&&!a.m){var b=function(){mb(a);t.setTimeout(function(){nb(a,3)},50)};eb(a.l,a.u,2,!0,function(){t[a.o]||b()},b);a.m=!0}}
  function mb(a){for(var b=W(1,5),c=0;c<b;c++){var d=X(a);a.i.body.appendChild(d);a.j.push(d)}b=X(a);b.style.bottom="0";b.style.left="0";b.style.position="fixed";b.style.width=W(100,110).toString()+"%";b.style.zIndex=W(2147483544,2147483644).toString();b.style.backgroundColor=ob(249,259,242,252,219,229);b.style.boxShadow="0 0 12px #888";b.style.color=ob(0,10,0,10,0,10);b.style.display="flex";b.style.justifyContent="center";b.style.fontFamily="Roboto, Arial";c=X(a);c.style.width=W(80,85).toString()+
  "%";c.style.maxWidth=W(750,775).toString()+"px";c.style.margin="24px";c.style.display="flex";c.style.alignItems="flex-start";c.style.justifyContent="center";d=ab(a.l.g,"IMG");d.className=$a();d.src=fb;d.alt="Warning icon";d.style.height="24px";d.style.width="24px";d.style.paddingRight="16px";var e=X(a),f=X(a);f.style.fontWeight="bold";f.textContent=gb;var g=X(a);g.textContent=hb;Y(a,e,f);Y(a,e,g);Y(a,c,d);Y(a,c,e);Y(a,b,c);a.g=b;a.i.body.appendChild(a.g);b=W(1,5);for(c=0;c<b;c++)d=X(a),a.i.body.appendChild(d),
  a.j.push(d)}function Y(a,b,c){for(var d=W(1,5),e=0;e<d;e++){var f=X(a);b.appendChild(f)}b.appendChild(c);c=W(1,5);for(d=0;d<c;d++)e=X(a),b.appendChild(e)}function W(a,b){return Math.floor(a+Math.random()*(b-a))}function ob(a,b,c,d,e,f){return"rgb("+W(Math.max(a,0),Math.min(b,255)).toString()+","+W(Math.max(c,0),Math.min(d,255)).toString()+","+W(Math.max(e,0),Math.min(f,255)).toString()+")"}function X(a){a=ab(a.l.g,"DIV");a.className=$a();return a}
  function nb(a,b){0>=b||null!=a.g&&0!==a.g.offsetHeight&&0!==a.g.offsetWidth||(pb(a),mb(a),t.setTimeout(function(){nb(a,b-1)},50))}function pb(a){for(var b=m(a.j),c=b.next();!c.done;c=b.next())(c=c.value)&&c.parentNode&&c.parentNode.removeChild(c);a.j=[];(b=a.g)&&b.parentNode&&b.parentNode.removeChild(b);a.g=null};function qb(a,b,c,d,e){function f(l){document.body?g(document.body):0<l?t.setTimeout(function(){f(l-1)},e):b()}function g(l){l.appendChild(h);t.setTimeout(function(){h?(0!==h.offsetHeight&&0!==h.offsetWidth?b():a(),h.parentNode&&h.parentNode.removeChild(h)):a()},d)}var h=rb(c);f(3)}function rb(a){var b=document.createElement("div");b.className=a;b.style.width="1px";b.style.height="1px";b.style.position="absolute";b.style.left="-10000px";b.style.top="-10000px";b.style.zIndex="-10000";return b};function Ra(a){this.h=R(a)}r(Ra,T);function sb(a){this.h=R(a)}r(sb,T);var tb=Va(sb);function ub(a){var b=la.apply(1,arguments);if(0===b.length)return Za(a[0]);for(var c=a[0],d=0;d<b.length;d++)c+=encodeURIComponent(b[d])+a[d+1];return Za(c)};function vb(a){if(!a)return null;a=Sa(a,4);var b;null===a||void 0===a?b=null:b=Za(a);return b};var wb=ea([""]),xb=ea([""]);function yb(a,b){this.m=a;this.o=new bb(a.document);this.g=b;this.j=S(this.g,1);this.u=vb(Qa(this.g,2))||ub(wb);this.i=!1;b=vb(Qa(this.g,13))||ub(xb);this.l=new ib(a.document,b,S(this.g,12))}yb.prototype.start=function(){zb(this)};
  function zb(a){Ab(a);eb(a.o,a.u,3,!1,function(){a:{var b=a.j;var c=t.btoa(b);if(c=t[c]){try{var d=Xa(t.atob(c))}catch(e){b=!1;break a}b=b===Sa(d,1)}else b=!1}b?Z(a,S(a.g,14)):(Z(a,S(a.g,8)),lb(a.l))},function(){qb(function(){Z(a,S(a.g,7));lb(a.l)},function(){return Z(a,S(a.g,6))},S(a.g,9),Ta(a.g,10),Ta(a.g,11))})}function Z(a,b){a.i||(a.i=!0,a=new a.m.XMLHttpRequest,a.open("GET",b,!0),a.send())}function Ab(a){var b=t.btoa(a.j);a.m[b]&&Z(a,S(a.g,5))};(function(a,b){t[a]=function(){var c=la.apply(0,arguments);t[a]=function(){};b.call.apply(b,[null].concat(c instanceof Array?c:fa(m(c))))}})("__h82AlnkH6D91__",function(a){"function"===typeof window.atob&&(new yb(window,tb(window.atob(a)))).start()});}).call(this);
  
  window.__h82AlnkH6D91__("WyJwdWItMzQxMTc4NDE1NzU0MzQyMCIsW251bGwsbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9iL3B1Yi0zNDExNzg0MTU3NTQzNDIwIl0sbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9lbC9BR1NLV3hXcFo2SEZhZ2tXV3BBeDkyVm5FUm1HelA4Sng3NDBjbG82QTd1U1BzMjMtb1J6aTl0R2tJZC0ySTZkbU9kVExldXJ5VU5pdDJmWVl6cVN3ZXFSaHFtT1d3XHUwMDNkXHUwMDNkP3RlXHUwMDNkVE9LRU5fRVhQT1NFRCIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFVub2h4aTRwNDRvRHN5UjNjSzBTTlVWdlhldmoySHp3dHBPMk52dlF4SXpPc1RuT1E4ZXV1Qzc4UExTRzROMFplT28xRWF6MG5hYjVHNElnMGJ5M1RqTkFcdTAwM2RcdTAwM2Q/YWJcdTAwM2QxXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFU0c2VpaDRuem1aQ2VKc0s0OUpFdHNBT3ZIZkNGaE9yMXFDN3N5bzRSaHBmamQzay02OGlaakhUT0UybWlxTEx6SnpZYUFPZHhTYWVRMC1LMGRZc0VabWdcdTAwM2RcdTAwM2Q/YWJcdTAwM2QyXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFdROU1sNExITHNkMVg0RzJualpOUXBhVE1GVzVTU2RUb0hUVF9oU1F6OVI3cm1RSVZsR3kzOFgyMng0dDZSVHJLdTVRaUlrdkl0ZFd2TFJ1Mnl2SEVaTXdcdTAwM2RcdTAwM2Q/c2JmXHUwMDNkMiIsImRpdi1ncHQtYWQiLDIwLDEwMCwiY0hWaUxUTTBNVEUzT0RReE5UYzFORE0wTWpBXHUwMDNkIixbbnVsbCxudWxsLG51bGwsImh0dHBzOi8vd3d3LmdzdGF0aWMuY29tLzBlbW4vZi9wL3B1Yi0zNDExNzg0MTU3NTQzNDIwLmpzP3VzcXBcdTAwM2RDQkkiXSwiaHR0cHM6Ly9mdW5kaW5nY2hvaWNlc21lc3NhZ2VzLmdvb2dsZS5jb20vZWwvQUdTS1d4V3YwN0dzbGhnVi1oUV85a0wzV0FhN0hmUXo3dXhKTWFBLUtHQ3VMOUhrWmRVWEFneHNmcVdIYUJrZlhBZkF1TUdyM2hFTmVMeVhZZDItS25ublNQODdwZ1x1MDAzZFx1MDAzZCJd");</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="shortcut icon" href="/assets/img/favicon.ico">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Shawn Hsu
          <span class="site-subtitle">Shawn Hsu's personal study blog | Software Engineer | Backend | Cloud Native | Blockchain</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#kubernetes" itemprop="item"><span itemprop="name">Kubernetes</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Kubernetes 從零開始 - Informer 架構以及 Controller Pattern</li>
      
    
  </ol>
</nav>

  


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const sidebarNav = document.querySelector("nav.toc");
    if (!sidebarNav) {
      return;
    }

    // Find the actual scrollable container
    let scrollContainer = null;

    // Check if the nav itself is scrollable
    if (sidebarNav.scrollHeight > sidebarNav.offsetHeight) {
      scrollContainer = sidebarNav;
    } else {
      // Look for scrollable children
      const tocMenu = sidebarNav.querySelector(".toc__menu");
      if (tocMenu && tocMenu.scrollHeight > tocMenu.offsetHeight) {
        scrollContainer = tocMenu;
      } else {
        // Look for any scrollable child
        const children = sidebarNav.children;
        for (let child of children) {
          if (child.scrollHeight > child.offsetHeight) {
            scrollContainer = child;
            break;
          }
        }
      }
    }

    if (!scrollContainer) {
      return;
    }

    let isUserScrolling = false;
    let autoScrollEnabled = true;
    let scrollTimeout;
    let pageScrollTimeout;
    let periodicCheckInterval;

    // Function to check if element is visible in container
    const isElementVisible = (element) => {
      const containerTop = scrollContainer.scrollTop;
      const containerHeight = scrollContainer.offsetHeight;
      const elementTop = element.offsetTop;
      const elementHeight = element.offsetHeight;

      const isVisible =
        elementTop >= containerTop &&
        elementTop + elementHeight <= containerTop + containerHeight;

      return isVisible;
    };

    // Function to find the current active heading based on scroll position
    const findCurrentActiveHeading = () => {
      const headings = document.querySelectorAll(
        "h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]"
      );
      const scrollY = window.scrollY;
      const offset = 100; // Offset to trigger activation

      let currentHeading = null;

      // Find the heading that's currently at the top of the viewport
      for (let i = 0; i < headings.length; i++) {
        const heading = headings[i];
        const headingTop = heading.offsetTop;

        if (headingTop <= scrollY + offset) {
          currentHeading = heading;
        } else {
          break;
        }
      }

      return currentHeading;
    };

    // Function to find the TOC element that corresponds to a heading
    const findTocElementForHeading = (heading) => {
      if (!heading || !heading.id) return null;

      const tocLinks = document.querySelectorAll("nav.toc a");
      for (const link of tocLinks) {
        if (link.getAttribute("href") === `#${heading.id}`) {
          return link.closest("li");
        }
      }
      return null;
    };

    // Function to scroll TOC to show active element
    const scrollTocToActive = () => {
      // Don't auto-scroll if user is manually scrolling or auto-scroll is disabled
      if (isUserScrolling || !autoScrollEnabled) {
        return;
      }

      // Always use scroll position to find the current heading
      const currentHeading = findCurrentActiveHeading();
      if (!currentHeading) {
        return;
      }

      const activeElement = findTocElementForHeading(currentHeading);
      if (!activeElement) {
        return;
      }

      // Check if active element is visible
      if (!isElementVisible(activeElement)) {
        // Get the current scroll position and container dimensions
        const currentScrollTop = scrollContainer.scrollTop;
        const containerHeight = scrollContainer.offsetHeight;
        const elementTop = activeElement.offsetTop;
        const elementHeight = activeElement.offsetHeight;

        // Calculate the position to center the active element in the visible area
        const targetScrollTop =
          elementTop - containerHeight / 2 + elementHeight / 2;

        // Ensure we don't scroll beyond the bounds
        const maxScrollTop = scrollContainer.scrollHeight - containerHeight;
        const finalScrollTop = Math.max(
          0,
          Math.min(targetScrollTop, maxScrollTop)
        );

        // Scroll to the target position
        scrollContainer.scrollTo({
          top: finalScrollTop,
          behavior: "smooth",
        });
      }
    };

    // Function to enable auto-scroll
    const enableAutoScroll = () => {
      if (!autoScrollEnabled) {
        autoScrollEnabled = true;
        // Resume periodic checks
        startPeriodicCheck();
      }
    };

    // Function to disable auto-scroll
    const disableAutoScroll = () => {
      if (autoScrollEnabled) {
        autoScrollEnabled = false;
        // Stop periodic checks
        if (periodicCheckInterval) {
          clearInterval(periodicCheckInterval);
          periodicCheckInterval = null;
        }
      }
    };

    // Function to start periodic check
    const startPeriodicCheck = () => {
      if (!periodicCheckInterval) {
        periodicCheckInterval = setInterval(() => {
          scrollTocToActive();
        }, 5000); // Increased interval to 5 seconds
      }
    };

    // Handle TOC scrolling
    scrollContainer.addEventListener("scroll", () => {
      isUserScrolling = true;
      disableAutoScroll(); // Disable auto-scroll when user scrolls TOC

      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }

      scrollTimeout = setTimeout(() => {
        isUserScrolling = false;
        // Don't automatically re-enable auto-scroll here
        // It will be re-enabled when user interacts with main page
      }, 500);
    });

    // Handle page scrolling
    window.addEventListener("scroll", () => {
      enableAutoScroll(); // Re-enable auto-scroll when user scrolls main page

      if (pageScrollTimeout) {
        clearTimeout(pageScrollTimeout);
      }

      pageScrollTimeout = setTimeout(() => {
        scrollTocToActive();
      }, 100);
    });

    // Handle clicks on main page content
    document.addEventListener("click", (event) => {
      // Only enable auto-scroll if click is not on TOC
      if (!sidebarNav.contains(event.target)) {
        enableAutoScroll();
      }
    });

    // Handle keyboard navigation
    document.addEventListener("keydown", () => {
      enableAutoScroll();
    });

    // Initial scroll to active element
    setTimeout(() => {
      scrollTocToActive();
    }, 1000);

    // Start periodic check
    startPeriodicCheck();
  });
</script>


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://ambersuncreates.com/" itemprop="url">Shawn Hsu</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>For it isn’t by size that you win or fail</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Taipei, Taiwan</span>
        </li>
      

      
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/ambersun1234" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/ambersun1234" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
      

      

      
        <li>
          <a href="mailto:ambersun1019.shawn@gmail.com" rel="me" class="u-email">
            <meta itemprop="email" content="ambersun1019.shawn@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Kubernetes 從零開始 - Informer 架構以及 Controller Pattern">
    <meta itemprop="description" content="Kubernetes ObjectKubernetes object 並不是指 Pod 或者是 Deployment 這種 Resource複習一下，Resource 是所有你可以透過 Kubernetes 使用的物件(操作 kubectl 或Kubernetes API)而 object 是這些 Resource 的 instance">
    <meta itemprop="datePublished" content="2025-02-07T00:00:00+08:00">
    <meta itemprop="dateModified" content="2025-11-23T22:32:20+08:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://ambersuncreates.com/kubernetes/kubernetes-controller-concept/" class="u-url" itemprop="url">Kubernetes 從零開始 - Informer 架構以及 Controller Pattern
</a>
          </h1>
          


  <p class="page__meta">
    

    

    
      
      

      

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-02-07">2025-02-07</time>
      </span>

      
        &nbsp;&nbsp;&nbsp;
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-11-23">
            2025-11-23
          </time>
        </span>

        &nbsp;&nbsp;&nbsp;

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/kubernetes/kubernetes-controller-concept/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/kubernetes/kubernetes-controller-concept/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/kubernetes/kubernetes-controller-concept/").innerHTML = text;
      }
    })
</script>

        </header>
      

      <section class="page__content e-content" itemprop="text" style="margin-top: 2em">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#kubernetes-object">Kubernetes Object</a><ul><li><a href="#kubernetes-object-state">Kubernetes Object State</a></li><li><a href="#imperative-vs-declarative">Imperative vs. Declarative</a></li></ul></li><li><a href="#introduction-to-kubernetes-controller-and-state-management">Introduction to Kubernetes Controller and State Management</a><ul><li><a href="#controller-pattern">Controller Pattern</a><ul><li><a href="#reflector">Reflector</a><ul><li><a href="#example">Example</a></li><li><a href="#list-and-watch">List and Watch</a></li><li><a href="#resync">Resync</a></li></ul></li><li><a href="#informer">Informer</a></li><li><a href="#indexer">Indexer</a></li></ul></li></ul></li><li><a href="#control-loop">Control Loop</a></li><li><a href="#controller-types">Controller Types</a><ul><li><a href="#controller-conflict-on-objects">Controller Conflict on Objects?</a></li></ul></li><li><a href="#references">References</a></li></ul>

            </nav>

            <br>

            <div class="sidebar__top_down" style="display: flex;">
              <div>
                <nav style="padding: 0 0.5em;">
                  <a href="#site-nav"> <i class="fas fa-angle-double-up fa-2x"></i></a>
                </nav>
              </div>

              <div>
                <nav style="padding: 0 0.5em;">
                  <a href="#footer"> <i class="fas fa-angle-double-down fa-2x"></i></a>
                </nav>
              </div>
            </div>

            
          </aside>
        
        <h1 id="kubernetes-object">Kubernetes Object</h1>
<p>Kubernetes object 並不是指 <code class="language-plaintext highlighter-rouge">Pod</code> 或者是 <code class="language-plaintext highlighter-rouge">Deployment</code> 這種 <strong>Resource</strong><br />
複習一下，Resource 是所有你可以透過 Kubernetes 使用的物件(操作 <a href="https://kubernetes.io/docs/reference/kubectl/">kubectl</a> 或<a href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/">Kubernetes API</a>)<br />
而 object 是這些 Resource 的 instance</p>

<blockquote>
  <p>有關 Resource 可以參考 <a href="../../kubernetes/kubernetes-workloads">Kubernetes 從零開始 - 高階抽象 Workload Resources | Shawn Hsu</a></p>
</blockquote>

<h2 id="kubernetes-object-state">Kubernetes Object State</h2>
<p>所謂的狀態是儲存在 Object 裡面的<br />
object 的 <code class="language-plaintext highlighter-rouge">spec</code> 以及 <code class="language-plaintext highlighter-rouge">status</code> 分別代表了 desired state 以及 current state<br />
spec 的內容可以透過一個特殊的檔案指定(稱為 <code class="language-plaintext highlighter-rouge">manifest</code>， 格式為 json 或 yaml)<br />
並透過操作 <a href="https://kubernetes.io/docs/reference/kubectl/">kubectl</a> 或 <a href="https://kubernetes.io/docs/concepts/overview/kubernetes-api/">Kubernetes API</a> 來建立 object</p>

<blockquote>
  <p>其中 status 是由 Controller 更新的，不是由我們手動指定的</p>
</blockquote>

<p>考慮建立一個 nginx pod<br />
並且查看他的 yaml 檔案<br />
你就會看到類似以下的東西，這就是 object 的 <code class="language-plaintext highlighter-rouge">status</code></p>

<p>可以看到 pod status 從最初的 <code class="language-plaintext highlighter-rouge">PodScheduled</code> 一直到 <code class="language-plaintext highlighter-rouge">PodReadyToStartContainers</code><br />
同時你也可以得知內部 container 的狀態<br />
Controller 會根據這些狀態來管理 object</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>kubectl run mynginx <span class="nt">--image</span><span class="o">=</span>nginx
<span class="nv">$ </span>kubectl get pods mynginx <span class="nt">-o</span> yaml
status:
  conditions:
  - lastProbeTime: null
    lastTransitionTime: <span class="s2">"2024-10-25T14:14:04Z"</span>
    status: <span class="s2">"True"</span>
    <span class="nb">type</span>: PodReadyToStartContainers
  - lastProbeTime: null
    lastTransitionTime: <span class="s2">"2024-10-25T14:13:44Z"</span>
    status: <span class="s2">"True"</span>
    <span class="nb">type</span>: Initialized
  - lastProbeTime: null
    lastTransitionTime: <span class="s2">"2024-10-25T14:14:04Z"</span>
    status: <span class="s2">"True"</span>
    <span class="nb">type</span>: Ready
  - lastProbeTime: null
    lastTransitionTime: <span class="s2">"2024-10-25T14:14:04Z"</span>
    status: <span class="s2">"True"</span>
    <span class="nb">type</span>: ContainersReady
  - lastProbeTime: null
    lastTransitionTime: <span class="s2">"2024-10-25T14:13:44Z"</span>
    status: <span class="s2">"True"</span>
    <span class="nb">type</span>: PodScheduled
  containerStatuses:
  - containerID: containerd://0ab6c6781723446e4869f1fd96b1d62b78a95dea327e45d276d010a5236f9ac8
    image: docker.io/library/nginx:latest
    imageID: docker.io/library/nginx@sha256:28402db69fec7c17e179ea87882667f1e054391138f77ffaf0c3eb388efc3ffb
    lastState: <span class="o">{}</span>
    name: mynginx
    ready: <span class="nb">true
    </span>restartCount: 0
    started: <span class="nb">true
    </span>state:
      running:
        startedAt: <span class="s2">"2024-10-25T14:14:04Z"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="imperative-vs-declarative">Imperative vs. Declarative</h2>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Imperative Management</code>: 手把手教學，告訴 K8s 怎麼做</li>
  <li><code class="language-plaintext highlighter-rouge">Declarative Management</code>: 告訴 K8s 我們想要什麼，K8s 會幫我們達成</li>
</ul>

<p>Kubernetes 大多數的操作都是透過 declarative 的方式<br />
比如說你指定 deployment replica 的數量就是告訴 desired state<br />
然後 Kubernetes 就會幫你達成這個狀態<br />
注意到很可能 cluster 永遠沒辦法達到你想要的狀態，但它會盡力達到</p>

<p>當然你也可以透過 imperative 的方式來操作，但是這樣的話，你就要自己手動管理狀態了</p>

<blockquote>
  <p>ref: <a href="https://stackoverflow.com/questions/47369351/kubectl-apply-vs-kubectl-create">kubectl apply vs kubectl create?</a></p>
</blockquote>

<h1 id="introduction-to-kubernetes-controller-and-state-management">Introduction to Kubernetes Controller and State Management</h1>
<p>在 <a href="../../kubernetes/kubernetes-basic">Kubernetes 從零開始 - 無痛初探 K8s! | Shawn Hsu</a> 中有提到<br />
K8s 是透過 Controller 管理 cluster 狀態的<br />
我們告訴 K8s 我們想要的狀態，然後 K8s 會幫我們達成這個狀態(i.e. <a href="#imperative-vs-declarative">Declaration Management</a>)</p>

<p>Controller 並不會直接操作 pod，而是透過 <a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/">Kubernetes API Server</a> 來管理 cluster 狀態<br />
比如說，建立或刪除 pod，甚至是更新 object 的狀態(e.g. <code class="language-plaintext highlighter-rouge">Finished</code>)</p>

<blockquote>
  <p>不會直接操作 pod 但透過 API Server 建立/刪除？<br />
舉例來說如果 replica 5 的 deployment 少了一個，那麼的確是要建立一個新的對吧？<br />
間接的操作 pod ，是這個意思</p>
</blockquote>

<h2 id="controller-pattern">Controller Pattern</h2>
<p><img src="https://github.com/kubernetes/sample-controller/raw/master/docs/images/client-go-controller-interaction.jpeg" alt="" /></p>
<blockquote>
  <p>ref: <a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md">client-go under the hood</a></p>
</blockquote>

<p>以上架構圖就是官方給的 Controller 的架構</p>

<p>具體來說，<a href="#reflector">Reflector</a> 會監聽 object 的變化<br />
將 event 放到 <code class="language-plaintext highlighter-rouge">delta-FIFO queue</code> 裡面<br />
並透過 <a href="#informer">Informer</a> 處理這些 event，將 object 儲存到 thread-safe store 裡面<br />
並且同時將 object 的 key dispatch 到 <code class="language-plaintext highlighter-rouge">workqueue</code> 裡面<br />
然後你的 Custom Controller 從 <code class="language-plaintext highlighter-rouge">workqueue</code> 裡面拿到 reference 並使用 <code class="language-plaintext highlighter-rouge">Lister</code> 來取得完整的 object 資訊(查詢 thread-safe store)</p>

<p>為了一次只處理固定數量的 work，所有 component 之間的溝通都是透過 <code class="language-plaintext highlighter-rouge">workqueue</code> 來做的<br />
有了 queue 擋在中間，可以保證同一個 item 不會同時被多個 Controller 處理</p>

<blockquote>
  <p>有關 queue 的討論，可以參考 <a href="../../database/database-message-queue">資料庫 - 從 Apache Kafka 認識 Message Queue | Shawn Hsu</a></p>
</blockquote>

<h3 id="reflector">Reflector</h3>
<p>Reflector 會聽 object 的變化並將變化的 object 放到 <code class="language-plaintext highlighter-rouge">delta-FIFO queue</code> 裡面<br />
問題來了 他要怎麼聽這些所謂的變化呢？</p>

<p>Kubernetes API Server 提供了一個方式讓你監聽特定的 object，稱為 <code class="language-plaintext highlighter-rouge">Watch</code><br />
每個 <a href="#kubernetes-object">Kubernetes Object</a> 都會有一個 <code class="language-plaintext highlighter-rouge">resourceVersion</code> 的欄位，你可以把它想像成是一個 unique 的 ID<br />
這個 ID 是對應到底層的 storage 的識別符號，這個 ID 會隨著 object 的變化而變化 所以不是固定值</p>

<blockquote>
  <p>Watch 會持續監聽，List 則不會</p>
</blockquote>

<p>你可以用這個 ID 來監聽 object 的變化<br />
有點類似 linked list 的概念，你只要知道開頭，就可以知道後續的資料位置<br />
所以監聽的概念也是一樣的，只要知道某個 object 目前的 <code class="language-plaintext highlighter-rouge">resourceVersion</code>，你就可以知道後續的位置，進而監聽它</p>

<h4 id="example">Example</h4>
<p>啟動一個 proxy 到 Kubernetes API Server</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>kubectl proxy <span class="nt">--port</span> 8888
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>port 可以隨意指定</p>
</blockquote>

<p>取得目前的 <code class="language-plaintext highlighter-rouge">resourceVersion</code></p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>curl http://localhost:8888/api/v1/namespaces/default/pods | <span class="nb">grep </span>resourceVersion
<span class="s2">"resourceVersion"</span>: <span class="s2">"135966"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>然後你就可以持續監聽後續 object 的變化(RV <code class="language-plaintext highlighter-rouge">135966</code> 以後的資料)</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>curl http://localhost:8888/api/v1/namespaces/default/pods<span class="se">\?</span><span class="nv">watch</span><span class="o">=</span>1<span class="se">\&amp;</span><span class="nv">resourceVersion</span><span class="o">=</span>135966
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>curl 使用的時候記得跳脫特殊字元</p>
</blockquote>

<p>為了可以觀察到變化，你可以嘗試建幾個 pod 玩一下好方便觀察</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>kubectl run mynginx <span class="nt">--image</span><span class="o">=</span>nginx
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>所有的監聽歷史資料都是儲存在 <a href="https://etcd.io/">etcd</a> 裡面<br />
想當然空間不會是無限的，預設只會保留 5 分鐘的資料</p>
</blockquote>

<h4 id="list-and-watch">List and Watch</h4>
<p>根據 <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/3157-watch-list#proposal">KEP 3157</a><br />
kube-apiserver 是非常脆弱的，它很容易受到記憶體壓力的影響導致服務中斷<br />
而這股記憶體壓力來自於所謂的 <em>LIST request</em>(也就是 <a href="#reflector">Reflector</a> 之前的行為)<br />
你不需要很多的 <em>LIST request</em> 就可以讓 kube-apiserver 過載(大概 16 個 <em>LIST request</em> 足以)<br />
而它會間接導致整個 node 裡面的服務都中斷，包含 kubelet</p>

<p>他們發現，<em>LIST request</em> 的作法需要從 <code class="language-plaintext highlighter-rouge">etcd</code> 裡面拿到資料<br />
並經過一系列的處理才能送回給 client(包含 unmarshal, convert, prepare response)<br />
記憶體的用量是無法預估的(因為會受到 page size, filter 等等的影響)<br />
而這些記憶體連 Golang 本身的 GC 都無法處理</p>

<p>為了要讓記憶體的用量變得可控<br />
於是提出了使用 streaming 的方式，從 $O(watchers \times pageSize \times objectSize \times 5)$ 降到 $O(watchers \times constant)$<br />
並且為了減少 <code class="language-plaintext highlighter-rouge">etcd</code> 的壓力，資料來源會從 <strong>Watch Cache</strong> 拿<br />
只有在必要的時候與 <code class="language-plaintext highlighter-rouge">etcd</code> 同步資料</p>

<blockquote>
  <p>注意到 <em>LIST request</em> 並沒有要移除</p>
</blockquote>

<p>所以改進的方法就明顯了<br />
從 <strong>Watch Cache</strong> 拿資料，但一樣用 <em>LIST request</em> 嗎？<br />
但如果繼續用 <em>List Request</em>，問題並不會解決，記憶體的問題只會從 <code class="language-plaintext highlighter-rouge">etcd</code> 轉移到 <strong>Watch Cache</strong> 而已<br />
所以是用 <em>WATCH request</em> 搭配上 streaming 的方式來處理(模擬 <em>LIST request</em> 的行為)</p>

<p>所以你可以看到，reflector 的部分預設是用 streaming<br />
然後有一個 fallback 的機制</p>

<p><a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/reflector.go#L391">tools/cache/reflector.go</a></p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="c">// ListAndWatchWithContext first lists all items and get the resource version at the moment of call,</span>
<span class="c">// and then use the resource version to watch.</span>
<span class="c">// It returns error if ListAndWatchWithContext didn't even try to initialize watch.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Reflector</span><span class="p">)</span> <span class="n">ListAndWatchWithContext</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="n">logger</span> <span class="o">:=</span> <span class="n">klog</span><span class="o">.</span><span class="n">FromContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">3</span><span class="p">)</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Listing and watching"</span><span class="p">,</span> <span class="s">"type"</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">typeDescription</span><span class="p">,</span> <span class="s">"reflector"</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">var</span> <span class="n">err</span> <span class="kt">error</span>
    <span class="k">var</span> <span class="n">w</span> <span class="n">watch</span><span class="o">.</span><span class="n">Interface</span>
    <span class="n">fallbackToList</span> <span class="o">:=</span> <span class="o">!</span><span class="n">r</span><span class="o">.</span><span class="n">useWatchList</span>

    <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">w</span><span class="o">.</span><span class="n">Stop</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">useWatchList</span> <span class="p">{</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">watchList</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="c">// stopCh was closed</span>
            <span class="k">return</span> <span class="no">nil</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"The watchlist request ended with an error, falling back to the standard LIST/WATCH semantics because making progress is better than deadlocking"</span><span class="p">)</span>
            <span class="n">fallbackToList</span> <span class="o">=</span> <span class="no">true</span>
            <span class="c">// ensure that we won't accidentally pass some garbage down the watch.</span>
            <span class="n">w</span> <span class="o">=</span> <span class="no">nil</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">fallbackToList</span> <span class="p">{</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">err</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="m">2</span><span class="p">)</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Caches populated"</span><span class="p">,</span> <span class="s">"type"</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">typeDescription</span><span class="p">,</span> <span class="s">"reflector"</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">watchWithResync</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>為了模擬 <em>LIST request</em> 的行為，<em>WATCH request</em> 會使用所謂的 <a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#watch-bookmarks">BOOKMARK</a> event<br />
bookmark event 是一種特殊的 event，他用來表示目前的資料版本已經跟你提供的 resourceVersion(RV) 一致<br />
在 <code class="language-plaintext highlighter-rouge">watchList</code> 裡面扮演著重要的角色</p>

<p>還記得我們說用 <em>WATCH request</em> 模擬 <em>LIST request</em> 的行為嗎？<br />
主要的流程還是沒變，我需要先拿到歷史資料，拿完之後再繼續監聽新資料<br />
當你接收到 bookmark event 的時候，表示所有歷史資料已經拿完了(最新的 RV 可以從 <code class="language-plaintext highlighter-rouge">etcd</code> 拿到，確保是 up-to-date 的)，你的 <strong>Watch Cache</strong> 已經完全跟上了<br />
最後，因為我們是使用 <em>WATCH request</em>，所以後續的 event 就會是新資料<br />
沒有新的 API call</p>

<h4 id="resync">Resync</h4>
<p>在 <code class="language-plaintext highlighter-rouge">ListAndWatchWithContext</code> 中，你會發現 Watch 不單只是 watch，還有 <em>Resync</em> 的機制</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">watchWithResync</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>我百思不得其解 Resync 的意義在哪<br />
是為了處理斷線資料遺失的問題嗎？ <em>WATCH request</em> 可以從上次的斷點繼續拉資料(i.e. RV) 所以不是<br />
回答這題之前，要先了解 <code class="language-plaintext highlighter-rouge">edge-based</code> 與 <code class="language-plaintext highlighter-rouge">level-based</code> 的差異</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">edge-based</code>: 專注於 “事件發生” 本身</li>
  <li><code class="language-plaintext highlighter-rouge">level-based</code>: 專注於 “狀態” 本身</li>
</ul>

<p><a href="https://stackoverflow.com/a/31095409">What does edge-based and level-based mean?</a> 留言的例子滿精準的<br />
如果你想要知道有多少的 Pod 是 READY 狀態</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">edge-based</code> 的做法會是當 Pod 變成 READY 的時候計算一次</li>
  <li><code class="language-plaintext highlighter-rouge">level-based</code> 則是從 <code class="language-plaintext highlighter-rouge">etcd</code> 拿到所有的 Pod 資料，然後計算一次</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">edge-based</code> 的缺點在於如果你漏掉一兩個事件，那結果會不正確<br />
<code class="language-plaintext highlighter-rouge">level-based</code> 則是你不知道哪時候所有的 Pod 會完成，所以你可能會需要處理很多次，比如說 10 秒檢查一次之類的<br />
對回去 <a href="#controller-pattern">Controller Pattern</a> 的實作，其實你會發現他是 <code class="language-plaintext highlighter-rouge">edge-based</code> 也是 <code class="language-plaintext highlighter-rouge">level-based</code> 的</p>

<p><code class="language-plaintext highlighter-rouge">edge-based</code> 我們已經看過 <em>WATCH request</em> 如何避免網路中斷等等事故的應對方法<br />
而 <code class="language-plaintext highlighter-rouge">level-based</code> 的方法就是 Controller 負責 <strong>Reconciliation</strong>，將 current state 往 desired state 推進(可參考 <a href="#control-loop">Control Loop</a>)</p>

<p>但終究是人寫的，Controller 可能有疏漏，導致 state 處理不妥當導致失敗<br />
那 <code class="language-plaintext highlighter-rouge">level-based</code> 的處理方法就是我再重新執行一次 <strong>Reconciliation</strong><br />
Controller 本身理論上要是 idempotent 的，所以沒問題</p>

<blockquote>
  <p>The resync period does more to compensate for problems in the controller code than to compensate for missed watch event.  We have had very few “I missed an event bug” (I can think of one in recent memory), but we have had many controllers which use the resync as a big “try again” button.<br />
ref: <a href="https://groups.google.com/g/kubernetes-sig-api-machinery/c/PbSCXdLDno0/m/v9gH3HXVDAAJ">What’s the right resync period value for informers?</a> By David Eads</p>
</blockquote>

<p>重新執行並不是 Controller 內部重新 enqueue 那種，我們說的是你寫錯的那種<br />
<code class="language-plaintext highlighter-rouge">Resync</code> 迫使你重新對 Resource 進行 Reconciliation<br />
將 thread-safe store 的資料重新塞入 delta-FIFO queue 裡面，允許失敗的事件能有再一次處理的機會</p>

<blockquote>
  <p>注意到 <code class="language-plaintext highlighter-rouge">Resync</code> 並不會重新拉所有的資料，只有 thread-safe store 內部的資料</p>
</blockquote>

<h3 id="informer">Informer</h3>
<p>Informer 本質上在做的事情是包含 <a href="#reflector">Reflector</a> 的功能(應該說 <a href="#reflector">Reflector</a> 是一個 tool 然後 Informer 才是真正使用的)<br />
當接收到 event 的時候(從 <code class="language-plaintext highlighter-rouge">delta-FIFO queue</code> 拿)，處理完 dispatch 到 <code class="language-plaintext highlighter-rouge">workqueue</code> 裡面<br />
並且交給 Controller 進行處理</p>

<h3 id="indexer">Indexer</h3>
<p>從 <a href="#informer">Informer</a> 傳遞給 Custom Controller 的資料只是單純的 object key<br />
你大概猜得到為什麼不丟整個 object，多半是因為效能問題<br />
寫入的部份是透過 Indexer 來做的</p>

<p>但只有 key 是不足以做 Reconciliation 的(因為資訊不足嘛)<br />
Indexer 的作用就像是資料庫的 Index 一樣，可以快速的找到 object<br />
所有相關的資料都是儲存在 thread-safe 的 store 裡面</p>

<p>存取的部份是透過 Lister(<a href="https://github.com/kubernetes/client-go/blob/master/tools/cache/listers.go">cache/lister</a>) 實現的<br />
所以這邊算是一個隱藏的 component</p>

<h1 id="control-loop">Control Loop</h1>
<p><img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*kTG2i9HYxGplJaBWF03HnA.png" alt="" /></p>
<blockquote>
  <p>ref: <a href="https://able8.medium.com/how-to-write-a-kubernetes-custom-controller-622841d1d3f6#:~:text=Kubernetes%20%E6%8E%A7%E5%88%B6%E5%99%A8%E6%98%AF%E4%B8%80%E4%B8%AA,%E7%8A%B6%E6%80%81%E6%9B%B4%E6%8E%A5%E8%BF%91%E6%9C%9F%E6%9C%9B%E7%8A%B6%E6%80%81%E3%80%82&amp;Kubernetes%20%E9%80%9A%E8%BF%87%E6%8E%A7%E5%88%B6%E5%99%A8%E6%A8%A1%E5%BC%8F,%E6%88%96%E8%80%85%E8%B5%84%E6%BA%90%E7%9A%84%E7%BC%96%E6%8E%92%E6%93%8D%E4%BD%9C%E3%80%82">如何编写自定义的 Kubernetes Controller</a></p>
</blockquote>

<p>具體來說，Controller 是怎麼做 <strong>狀態管理</strong> 的呢？<br />
前面提到 <a href="#kubernetes-object">Kubernetes Object</a> 裡面有存 desired state 以及 current state<br />
所以 Controller 就會不斷的監控 object 的狀態，並且根據 desired state 來更新 current state<br />
要做到不斷的監控，最簡單的方式就是一個迴圈，稱為 <code class="language-plaintext highlighter-rouge">control loop</code></p>

<p>這種不斷監控並更新狀態的方式，就是所謂的 <strong>Reconciliation</strong></p>

<blockquote>
  <p>理論上每個 Controller 都是獨立的 process, 但是為了方便管理，K8s 會將他們打包在一起</p>
</blockquote>

<h1 id="controller-types">Controller Types</h1>
<p>K8s 裡面，controller 其實不只有一種<br />
針對不同的 Resource，K8s 會有不同的內建的 Controller<br />
deployment 有自己的 <code class="language-plaintext highlighter-rouge">Deployment Controller</code>，job 也有自己的 <code class="language-plaintext highlighter-rouge">Job Controller</code> 等等的</p>

<blockquote>
  <p>有關 Resource 可以參考 <a href="../../kubernetes/kubernetes-workloads">Kubernetes 從零開始 - 高階抽象 Workload Resources | Shawn Hsu</a></p>
</blockquote>

<p><img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*4sus97eHHeaeFy0ui81ULg.png" alt="" /></p>
<blockquote>
  <p>ref: <a href="https://able8.medium.com/how-to-write-a-kubernetes-custom-controller-622841d1d3f6#:~:text=Kubernetes%20%E6%8E%A7%E5%88%B6%E5%99%A8%E6%98%AF%E4%B8%80%E4%B8%AA,%E7%8A%B6%E6%80%81%E6%9B%B4%E6%8E%A5%E8%BF%91%E6%9C%9F%E6%9C%9B%E7%8A%B6%E6%80%81%E3%80%82&amp;Kubernetes%20%E9%80%9A%E8%BF%87%E6%8E%A7%E5%88%B6%E5%99%A8%E6%A8%A1%E5%BC%8F,%E6%88%96%E8%80%85%E8%B5%84%E6%BA%90%E7%9A%84%E7%BC%96%E6%8E%92%E6%93%8D%E4%BD%9C%E3%80%82">如何编写自定义的 Kubernetes Controller</a></p>
</blockquote>

<h2 id="controller-conflict-on-objects">Controller Conflict on Objects?</h2>
<p>內建的 Controller 會監控特定的 object<br />
但是有一些 Controller 他們看的 object 是同一種的</p>

<p>比如說 deployment 跟 job 都會監控 pod<br />
會不會有一種可能他們的 Controller 會互相衝突呢？<br />
事實上不會，Controller 會根據 object 的 label 來區分</p>

<h1 id="references">References</h1>
<ul>
  <li><a href="https://stackoverflow.com/questions/52309496/difference-between-kubernetes-objects-and-resources">Difference between Kubernetes Objects and Resources</a></li>
  <li><a href="https://stackoverflow.com/questions/59950463/objects-resources-and-controllers-in-kubernetes">Objects, Resources and Controllers in Kubernetes</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/">Objects In Kubernetes</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/object-management/">Kubernetes Object Management</a></li>
  <li><a href="https://www.zhaohuabing.com/post/2023-03-09-how-to-create-a-k8s-controller/">Kubernetes Controller 机制详解（一）</a></li>
  <li><a href="https://stackoverflow.com/questions/66080942/what-k8s-bookmark-solves">What k8s bookmark solves?</a></li>
  <li><a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#watch-bookmarks">Watch bookmarks</a></li>
  <li><a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/3157-watch-list">KEP 3157</a></li>
  <li><a href="https://github.com/cloudnativeto/sig-kubernetes/issues/11">[提问]Informer 中为什么需要引入 Resync 机制？</a></li>
  <li><a href="https://www.youtube.com/watch?v=soyOjOH-Vjc">Informer, Cache and Queue | Kubernetes Informers vs Watch | Basics of client-go Kubernetes Part - 4</a></li>
  <li><a href="https://www.cnblogs.com/WisWang/p/13897782.html">kubernetes infomer 中的 resync</a></li>
  <li><a href="https://blog.csdn.net/susu_xi/article/details/132296062?spm=1001.2101.3001.10796">深入源码分析kubernetes informer机制（三）Resync</a></li>
  <li><a href="https://groups.google.com/g/kubernetes-sig-api-machinery/c/PbSCXdLDno0">What’s the right resync period value for informers?</a></li>
  <li><a href="https://stackoverflow.com/questions/31041766/what-does-edge-based-and-level-based-mean">What does edge-based and level-based mean?</a></li>
  <li><a href="https://github.com/kubernetes-sigs/controller-runtime/issues/521">What’s the right resync period value for informers?</a></li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#bookmark-event" class="page__taxonomy-item p-category" rel="tag">bookmark event</a><span class="sep">, </span>
    
      <a href="/tags/#client-go" class="page__taxonomy-item p-category" rel="tag">client-go</a><span class="sep">, </span>
    
      <a href="/tags/#control-loop" class="page__taxonomy-item p-category" rel="tag">control loop</a><span class="sep">, </span>
    
      <a href="/tags/#controller-pattern" class="page__taxonomy-item p-category" rel="tag">controller pattern</a><span class="sep">, </span>
    
      <a href="/tags/#crd" class="page__taxonomy-item p-category" rel="tag">crd</a><span class="sep">, </span>
    
      <a href="/tags/#etcd" class="page__taxonomy-item p-category" rel="tag">etcd</a><span class="sep">, </span>
    
      <a href="/tags/#indexer" class="page__taxonomy-item p-category" rel="tag">indexer</a><span class="sep">, </span>
    
      <a href="/tags/#informer" class="page__taxonomy-item p-category" rel="tag">informer</a><span class="sep">, </span>
    
      <a href="/tags/#kubernetes-api-server" class="page__taxonomy-item p-category" rel="tag">kubernetes api server</a><span class="sep">, </span>
    
      <a href="/tags/#kubernetes-controller" class="page__taxonomy-item p-category" rel="tag">kubernetes controller</a><span class="sep">, </span>
    
      <a href="/tags/#kubernetes-object" class="page__taxonomy-item p-category" rel="tag">kubernetes object</a><span class="sep">, </span>
    
      <a href="/tags/#kubernetes-operator" class="page__taxonomy-item p-category" rel="tag">kubernetes operator</a><span class="sep">, </span>
    
      <a href="/tags/#kubernetes-resource" class="page__taxonomy-item p-category" rel="tag">kubernetes resource</a><span class="sep">, </span>
    
      <a href="/tags/#lister" class="page__taxonomy-item p-category" rel="tag">lister</a><span class="sep">, </span>
    
      <a href="/tags/#operator-pattern" class="page__taxonomy-item p-category" rel="tag">operator pattern</a><span class="sep">, </span>
    
      <a href="/tags/#reconcile" class="page__taxonomy-item p-category" rel="tag">reconcile</a><span class="sep">, </span>
    
      <a href="/tags/#reflector" class="page__taxonomy-item p-category" rel="tag">reflector</a><span class="sep">, </span>
    
      <a href="/tags/#resync" class="page__taxonomy-item p-category" rel="tag">resync</a><span class="sep">, </span>
    
      <a href="/tags/#state" class="page__taxonomy-item p-category" rel="tag">state</a><span class="sep">, </span>
    
      <a href="/tags/#workqueue" class="page__taxonomy-item p-category" rel="tag">workqueue</a><span class="sep">, </span>
    
      <a href="/tags/#wrangler" class="page__taxonomy-item p-category" rel="tag">wrangler</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#kubernetes" class="page__taxonomy-item p-category" rel="tag">kubernetes</a>
    
    </span>
  </p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Kubernetes+%E5%BE%9E%E9%9B%B6%E9%96%8B%E5%A7%8B+-+Informer+%E6%9E%B6%E6%A7%8B%E4%BB%A5%E5%8F%8A+Controller+Pattern%20https%3A%2F%2Fambersuncreates.com%2Fkubernetes%2Fkubernetes-controller-concept%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fambersuncreates.com%2Fkubernetes%2Fkubernetes-controller-concept%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fambersuncreates.com%2Fkubernetes%2Fkubernetes-controller-concept%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/devops/devops-mock/" class="pagination--pager" title="DevOps - 詳解 Mock 概念以及如何 Mock HTTP Request
">Previous</a>
    
    
      <a href="/algorithm/alogrithm-priority-queue/" class="pagination--pager" title="神奇的演算法 - 為什麼你的 Priority Queue 那麼慢！
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/database/database-filter/" rel="permalink">資料庫 - 機率型資料結構 Bloom Filter 在 Cache 中的應用
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2026-01-19">2026-01-19</time>
      </span>

      
        &nbsp;&nbsp;&nbsp;
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-11-23">
            2025-11-23
          </time>
        </span>

        &nbsp;&nbsp;&nbsp;

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/database/database-filter/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/database/database-filter/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/database/database-filter/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">Cache Issues
就像我們在 資料庫 - Cache Strategies 與常見的 Solutions | Shawn Hsu 當中提到的
如果碰到惡意攻擊，查詢不在 cache 也不在 database 裡面的資料，那麼所有的請求都會直接到 database，然後又會直接被打爆
所以其實在這種狀況底下...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/random/golang-gc/" rel="permalink">多開 Goroutine 的效能瓶頸以及 Garbage Collection 對其的影響
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2026-01-15">2026-01-15</time>
      </span>

      
        &nbsp;&nbsp;&nbsp;
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-11-23">
            2025-11-23
          </time>
        </span>

        &nbsp;&nbsp;&nbsp;

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/random/golang-gc/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/random/golang-gc/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/random/golang-gc/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">Preface
Goroutine 作為 Golang 的一大特色
其輕量且快速的特性，使得其的開銷相比 process 以及 thread 要來的低上許多
因此人們往往會將 Goroutine 用在非同步的操作上，比如說 I/O 或者是 CPU-bound 的操作
用以達到併發的效果

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/kubernetes/kubernetes-workloads/" rel="permalink">Kubernetes 從零開始 - Pod 高級抽象 Workload Resources
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-11-23">2025-11-23</time>
      </span>

      
        &nbsp;&nbsp;&nbsp;
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-11-23">
            2025-11-23
          </time>
        </span>

        &nbsp;&nbsp;&nbsp;

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/kubernetes/kubernetes-workloads/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/kubernetes/kubernetes-workloads/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/kubernetes/kubernetes-workloads/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">High Level Abstraction
之前提到 Pod 是 Kubernetes 當中部署的最小單位，因為其設計關係(比如說容易被 reschedule 以及被刪除等等)，是比較不適合直接操作的
因此 Kubernetes 提供了更高層次的抽象，讓我們可以更方便的管理 Pod
本文將會走過一遍這些更高階的...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/kubernetes/kubernetes-volume/" rel="permalink">Kubernetes 從零開始 - 你的 Volume 到底 Mount 到哪裡去了？
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          8 minute read
        
      </span>

      &nbsp;&nbsp;&nbsp;

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-11-13">2025-11-13</time>
      </span>

      
        &nbsp;&nbsp;&nbsp;
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-11-23">
            2025-11-23
          </time>
        </span>

        &nbsp;&nbsp;&nbsp;

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/kubernetes/kubernetes-volume/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/kubernetes/kubernetes-volume/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/kubernetes/kubernetes-volume/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">Introduction to Kubernetes Volume
從 Docker 的年代開始，掛載 host 的檔案系統不是什麼新鮮事
而 mount 的方式也很直覺，直接指定 host 的檔案路徑，你就能夠在 container 裡面存取相關的資料
到了 Kubernetes，也是有一樣的概念，但是 mou...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

<script type="text/javascript">
  let viewHeight = window. innerHeight;
  let codeblocks = document.getElementsByClassName("highlight");

  Array.from(codeblocks).forEach(value => {
      if (value.scrollHeight > viewHeight) {
          value.setAttribute("style", "height:100vh;overflow-y:auto;");
      }
  })
</script>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
          <li><a href="https://github.com/ambersun1234" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2026 Shawn Hsu. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q9EYCKB89S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Q9EYCKB89S', { 'anonymize_ip': false});
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://ambersuncreates.com/kubernetes/kubernetes-controller-concept/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/kubernetes/kubernetes-controller-concept"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://https-ambersun1234-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
    },
    "HTML-CSS": {
      scale: 80
    }
  });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> 




  </body>
</html>
