<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Kubernetes 從零開始 - 部署策略 101 | Shawn Hsu</title>
<meta name="description" content="隨著軟體服務日漸複雜，你需要清楚的了解不同的部署策略會如何影響你的服務，他是否會造成 downtime，他會不會導致錯誤的資料以及發生致命錯誤時，你該如何應對。部署策略需要配合好軟體層級的架構設計，兩者缺一不可。本篇文章將帶你認識不同的部署策略，優缺點以及如何實作。">


  <meta name="author" content="Shawn Hsu">
  
  <meta property="article:author" content="Shawn Hsu">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Shawn Hsu">
<meta property="og:title" content="Kubernetes 從零開始 - 部署策略 101">
<meta property="og:url" content="https://ambersuncreates.com/kubernetes/kubernetes-scale/">


  <meta property="og:description" content="隨著軟體服務日漸複雜，你需要清楚的了解不同的部署策略會如何影響你的服務，他是否會造成 downtime，他會不會導致錯誤的資料以及發生致命錯誤時，你該如何應對。部署策略需要配合好軟體層級的架構設計，兩者缺一不可。本篇文章將帶你認識不同的部署策略，優缺點以及如何實作。">


<meta property="og:image" content="/assets/img/og/kubernetes-scale.png">




  <meta property="article:published_time" content="2025-09-24T00:00:00+08:00">



  <meta property="article:modified_time" content="2025-10-10T21:45:50+08:00">



  

  


<link rel="canonical" href="https://ambersuncreates.com/kubernetes/kubernetes-scale/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Shawn Hsu",
      "url": "https://ambersuncreates.com/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Shawn Hsu Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3411784157543420"
     crossorigin="anonymous"></script>

<!-- google ads -->
<script async src="https://fundingchoicesmessages.google.com/i/pub-3411784157543420?ers=1" nonce="DTHVC27nOex6L5olJXhYMg"></script><script nonce="DTHVC27nOex6L5olJXhYMg">(function() {function signalGooglefcPresent() {if (!window.frames['googlefcPresent']) {if (document.body) {const iframe = document.createElement('iframe'); iframe.style = 'width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;'; iframe.style.display = 'none'; iframe.name = 'googlefcPresent'; document.body.appendChild(iframe);} else {setTimeout(signalGooglefcPresent, 0);}}}signalGooglefcPresent();})();</script>
<script>(function(){'use strict';function aa(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}}var ba="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(a==Array.prototype||a==Object.prototype)return a;a[b]=c.value;return a};
  function ca(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var c=a[b];if(c&&c.Math==Math)return c}throw Error("Cannot find global object");}var da=ca(this);function k(a,b){if(b)a:{var c=da;a=a.split(".");for(var d=0;d<a.length-1;d++){var e=a[d];if(!(e in c))break a;c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&ba(c,a,{configurable:!0,writable:!0,value:b})}}
  function ea(a){return a.raw=a}function m(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];if(b)return b.call(a);if("number"==typeof a.length)return{next:aa(a)};throw Error(String(a)+" is not an iterable or ArrayLike");}function fa(a){for(var b,c=[];!(b=a.next()).done;)c.push(b.value);return c}var ha="function"==typeof Object.create?Object.create:function(a){function b(){}b.prototype=a;return new b},n;
  if("function"==typeof Object.setPrototypeOf)n=Object.setPrototypeOf;else{var q;a:{var ia={a:!0},ja={};try{ja.__proto__=ia;q=ja.a;break a}catch(a){}q=!1}n=q?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}var ka=n;
  function r(a,b){a.prototype=ha(b.prototype);a.prototype.constructor=a;if(ka)ka(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.A=b.prototype}function la(){for(var a=Number(this),b=[],c=a;c<arguments.length;c++)b[c-a]=arguments[c];return b}k("Number.MAX_SAFE_INTEGER",function(){return 9007199254740991});
  k("Number.isFinite",function(a){return a?a:function(b){return"number"!==typeof b?!1:!isNaN(b)&&Infinity!==b&&-Infinity!==b}});k("Number.isInteger",function(a){return a?a:function(b){return Number.isFinite(b)?b===Math.floor(b):!1}});k("Number.isSafeInteger",function(a){return a?a:function(b){return Number.isInteger(b)&&Math.abs(b)<=Number.MAX_SAFE_INTEGER}});
  k("Math.trunc",function(a){return a?a:function(b){b=Number(b);if(isNaN(b)||Infinity===b||-Infinity===b||0===b)return b;var c=Math.floor(Math.abs(b));return 0>b?-c:c}});k("Object.is",function(a){return a?a:function(b,c){return b===c?0!==b||1/b===1/c:b!==b&&c!==c}});k("Array.prototype.includes",function(a){return a?a:function(b,c){var d=this;d instanceof String&&(d=String(d));var e=d.length;c=c||0;for(0>c&&(c=Math.max(c+e,0));c<e;c++){var f=d[c];if(f===b||Object.is(f,b))return!0}return!1}});
  k("String.prototype.includes",function(a){return a?a:function(b,c){if(null==this)throw new TypeError("The 'this' value for String.prototype.includes must not be null or undefined");if(b instanceof RegExp)throw new TypeError("First argument to String.prototype.includes must not be a regular expression");return-1!==this.indexOf(b,c||0)}});/*
  
   Copyright The Closure Library Authors.
   SPDX-License-Identifier: Apache-2.0
  */
  var t=this||self;function v(a){return a};var w,x;a:{for(var ma=["CLOSURE_FLAGS"],y=t,z=0;z<ma.length;z++)if(y=y[ma[z]],null==y){x=null;break a}x=y}var na=x&&x[610401301];w=null!=na?na:!1;var A,oa=t.navigator;A=oa?oa.userAgentData||null:null;function B(a){return w?A?A.brands.some(function(b){return(b=b.brand)&&-1!=b.indexOf(a)}):!1:!1}function C(a){var b;a:{if(b=t.navigator)if(b=b.userAgent)break a;b=""}return-1!=b.indexOf(a)};function D(){return w?!!A&&0<A.brands.length:!1}function E(){return D()?B("Chromium"):(C("Chrome")||C("CriOS"))&&!(D()?0:C("Edge"))||C("Silk")};var pa=D()?!1:C("Trident")||C("MSIE");!C("Android")||E();E();C("Safari")&&(E()||(D()?0:C("Coast"))||(D()?0:C("Opera"))||(D()?0:C("Edge"))||(D()?B("Microsoft Edge"):C("Edg/"))||D()&&B("Opera"));var qa={},F=null;var ra="undefined"!==typeof Uint8Array,sa=!pa&&"function"===typeof btoa;function G(){return"function"===typeof BigInt};var H=0,I=0;function ta(a){var b=0>a;a=Math.abs(a);var c=a>>>0;a=Math.floor((a-c)/4294967296);b&&(c=m(ua(c,a)),b=c.next().value,a=c.next().value,c=b);H=c>>>0;I=a>>>0}function va(a,b){b>>>=0;a>>>=0;if(2097151>=b)var c=""+(4294967296*b+a);else G()?c=""+(BigInt(b)<<BigInt(32)|BigInt(a)):(c=(a>>>24|b<<8)&16777215,b=b>>16&65535,a=(a&16777215)+6777216*c+6710656*b,c+=8147497*b,b*=2,1E7<=a&&(c+=Math.floor(a/1E7),a%=1E7),1E7<=c&&(b+=Math.floor(c/1E7),c%=1E7),c=b+wa(c)+wa(a));return c}
  function wa(a){a=String(a);return"0000000".slice(a.length)+a}function ua(a,b){b=~b;a?a=~a+1:b+=1;return[a,b]};var J;J="function"===typeof Symbol&&"symbol"===typeof Symbol()?Symbol():void 0;var xa=J?function(a,b){a[J]|=b}:function(a,b){void 0!==a.g?a.g|=b:Object.defineProperties(a,{g:{value:b,configurable:!0,writable:!0,enumerable:!1}})},K=J?function(a){return a[J]|0}:function(a){return a.g|0},L=J?function(a){return a[J]}:function(a){return a.g},M=J?function(a,b){a[J]=b;return a}:function(a,b){void 0!==a.g?a.g=b:Object.defineProperties(a,{g:{value:b,configurable:!0,writable:!0,enumerable:!1}});return a};function ya(a,b){M(b,(a|0)&-14591)}function za(a,b){M(b,(a|34)&-14557)}
  function Aa(a){a=a>>14&1023;return 0===a?536870912:a};var N={},Ba={};function Ca(a){return!(!a||"object"!==typeof a||a.g!==Ba)}function Da(a){return null!==a&&"object"===typeof a&&!Array.isArray(a)&&a.constructor===Object}function P(a,b,c){if(!Array.isArray(a)||a.length)return!1;var d=K(a);if(d&1)return!0;if(!(b&&(Array.isArray(b)?b.includes(c):b.has(c))))return!1;M(a,d|1);return!0}Object.freeze(new function(){});Object.freeze(new function(){});var Ea=/^-?([1-9][0-9]*|0)(\.[0-9]+)?$/;var Q;function Fa(a,b){Q=b;a=new a(b);Q=void 0;return a}
  function R(a,b,c){null==a&&(a=Q);Q=void 0;if(null==a){var d=96;c?(a=[c],d|=512):a=[];b&&(d=d&-16760833|(b&1023)<<14)}else{if(!Array.isArray(a))throw Error();d=K(a);if(d&64)return a;d|=64;if(c&&(d|=512,c!==a[0]))throw Error();a:{c=a;var e=c.length;if(e){var f=e-1;if(Da(c[f])){d|=256;b=f-(+!!(d&512)-1);if(1024<=b)throw Error();d=d&-16760833|(b&1023)<<14;break a}}if(b){b=Math.max(b,e-(+!!(d&512)-1));if(1024<b)throw Error();d=d&-16760833|(b&1023)<<14}}}M(a,d);return a};function Ga(a){switch(typeof a){case "number":return isFinite(a)?a:String(a);case "boolean":return a?1:0;case "object":if(a)if(Array.isArray(a)){if(P(a,void 0,0))return}else if(ra&&null!=a&&a instanceof Uint8Array){if(sa){for(var b="",c=0,d=a.length-10240;c<d;)b+=String.fromCharCode.apply(null,a.subarray(c,c+=10240));b+=String.fromCharCode.apply(null,c?a.subarray(c):a);a=btoa(b)}else{void 0===b&&(b=0);if(!F){F={};c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");d=["+/=",
  "+/","-_=","-_.","-_"];for(var e=0;5>e;e++){var f=c.concat(d[e].split(""));qa[e]=f;for(var g=0;g<f.length;g++){var h=f[g];void 0===F[h]&&(F[h]=g)}}}b=qa[b];c=Array(Math.floor(a.length/3));d=b[64]||"";for(e=f=0;f<a.length-2;f+=3){var l=a[f],p=a[f+1];h=a[f+2];g=b[l>>2];l=b[(l&3)<<4|p>>4];p=b[(p&15)<<2|h>>6];h=b[h&63];c[e++]=g+l+p+h}g=0;h=d;switch(a.length-f){case 2:g=a[f+1],h=b[(g&15)<<2]||d;case 1:a=a[f],c[e]=b[a>>2]+b[(a&3)<<4|g>>4]+h+d}a=c.join("")}return a}}return a};function Ha(a,b,c){a=Array.prototype.slice.call(a);var d=a.length,e=b&256?a[d-1]:void 0;d+=e?-1:0;for(b=b&512?1:0;b<d;b++)a[b]=c(a[b]);if(e){b=a[b]={};for(var f in e)Object.prototype.hasOwnProperty.call(e,f)&&(b[f]=c(e[f]))}return a}function Ia(a,b,c,d,e){if(null!=a){if(Array.isArray(a))a=P(a,void 0,0)?void 0:e&&K(a)&2?a:Ja(a,b,c,void 0!==d,e);else if(Da(a)){var f={},g;for(g in a)Object.prototype.hasOwnProperty.call(a,g)&&(f[g]=Ia(a[g],b,c,d,e));a=f}else a=b(a,d);return a}}
  function Ja(a,b,c,d,e){var f=d||c?K(a):0;d=d?!!(f&32):void 0;a=Array.prototype.slice.call(a);for(var g=0;g<a.length;g++)a[g]=Ia(a[g],b,c,d,e);c&&c(f,a);return a}function Ka(a){return a.s===N?a.toJSON():Ga(a)};function La(a,b,c){c=void 0===c?za:c;if(null!=a){if(ra&&a instanceof Uint8Array)return b?a:new Uint8Array(a);if(Array.isArray(a)){var d=K(a);if(d&2)return a;b&&(b=0===d||!!(d&32)&&!(d&64||!(d&16)));return b?M(a,(d|34)&-12293):Ja(a,La,d&4?za:c,!0,!0)}a.s===N&&(c=a.h,d=L(c),a=d&2?a:Fa(a.constructor,Ma(c,d,!0)));return a}}function Ma(a,b,c){var d=c||b&2?za:ya,e=!!(b&32);a=Ha(a,b,function(f){return La(f,e,d)});xa(a,32|(c?2:0));return a};function Na(a,b){a=a.h;return Oa(a,L(a),b)}function Oa(a,b,c,d){if(-1===c)return null;if(c>=Aa(b)){if(b&256)return a[a.length-1][c]}else{var e=a.length;if(d&&b&256&&(d=a[e-1][c],null!=d))return d;b=c+(+!!(b&512)-1);if(b<e)return a[b]}}function Pa(a,b,c,d,e){var f=Aa(b);if(c>=f||e){var g=b;if(b&256)e=a[a.length-1];else{if(null==d)return;e=a[f+(+!!(b&512)-1)]={};g|=256}e[c]=d;c<f&&(a[c+(+!!(b&512)-1)]=void 0);g!==b&&M(a,g)}else a[c+(+!!(b&512)-1)]=d,b&256&&(a=a[a.length-1],c in a&&delete a[c])}
  function Qa(a,b){var c=Ra;var d=void 0===d?!1:d;var e=a.h;var f=L(e),g=Oa(e,f,b,d);if(null!=g&&"object"===typeof g&&g.s===N)c=g;else if(Array.isArray(g)){var h=K(g),l=h;0===l&&(l|=f&32);l|=f&2;l!==h&&M(g,l);c=new c(g)}else c=void 0;c!==g&&null!=c&&Pa(e,f,b,c,d);e=c;if(null==e)return e;a=a.h;f=L(a);f&2||(g=e,c=g.h,h=L(c),g=h&2?Fa(g.constructor,Ma(c,h,!1)):g,g!==e&&(e=g,Pa(a,f,b,e,d)));return e}function Sa(a,b){a=Na(a,b);return null==a||"string"===typeof a?a:void 0}
  function Ta(a,b){var c=void 0===c?0:c;a=Na(a,b);if(null!=a)if(b=typeof a,"number"===b?Number.isFinite(a):"string"!==b?0:Ea.test(a))if("number"===typeof a){if(a=Math.trunc(a),!Number.isSafeInteger(a)){ta(a);b=H;var d=I;if(a=d&2147483648)b=~b+1>>>0,d=~d>>>0,0==b&&(d=d+1>>>0);b=4294967296*d+(b>>>0);a=a?-b:b}}else if(b=Math.trunc(Number(a)),Number.isSafeInteger(b))a=String(b);else{if(b=a.indexOf("."),-1!==b&&(a=a.substring(0,b)),!("-"===a[0]?20>a.length||20===a.length&&-922337<Number(a.substring(0,7)):
  19>a.length||19===a.length&&922337>Number(a.substring(0,6)))){if(16>a.length)ta(Number(a));else if(G())a=BigInt(a),H=Number(a&BigInt(4294967295))>>>0,I=Number(a>>BigInt(32)&BigInt(4294967295));else{b=+("-"===a[0]);I=H=0;d=a.length;for(var e=b,f=(d-b)%6+b;f<=d;e=f,f+=6)e=Number(a.slice(e,f)),I*=1E6,H=1E6*H+e,4294967296<=H&&(I+=Math.trunc(H/4294967296),I>>>=0,H>>>=0);b&&(b=m(ua(H,I)),a=b.next().value,b=b.next().value,H=a,I=b)}a=H;b=I;b&2147483648?G()?a=""+(BigInt(b|0)<<BigInt(32)|BigInt(a>>>0)):(b=
  m(ua(a,b)),a=b.next().value,b=b.next().value,a="-"+va(a,b)):a=va(a,b)}}else a=void 0;return null!=a?a:c}function S(a,b){a=Sa(a,b);return null!=a?a:""};function T(a,b,c){this.h=R(a,b,c)}T.prototype.toJSON=function(){return Ua(this,Ja(this.h,Ka,void 0,void 0,!1),!0)};T.prototype.s=N;T.prototype.toString=function(){return Ua(this,this.h,!1).toString()};
  function Ua(a,b,c){var d=a.constructor.v,e=L(c?a.h:b);a=b.length;if(!a)return b;var f;if(Da(c=b[a-1])){a:{var g=c;var h={},l=!1,p;for(p in g)if(Object.prototype.hasOwnProperty.call(g,p)){var u=g[p];if(Array.isArray(u)){var jb=u;if(P(u,d,+p)||Ca(u)&&0===u.size)u=null;u!=jb&&(l=!0)}null!=u?h[p]=u:l=!0}if(l){for(var O in h){g=h;break a}g=null}}g!=c&&(f=!0);a--}for(p=+!!(e&512)-1;0<a;a--){O=a-1;c=b[O];O-=p;if(!(null==c||P(c,d,O)||Ca(c)&&0===c.size))break;var kb=!0}if(!f&&!kb)return b;b=Array.prototype.slice.call(b,
  0,a);g&&b.push(g);return b};function Va(a){return function(b){if(null==b||""==b)b=new a;else{b=JSON.parse(b);if(!Array.isArray(b))throw Error(void 0);xa(b,32);b=Fa(a,b)}return b}};function Wa(a){this.h=R(a)}r(Wa,T);var Xa=Va(Wa);var U;function V(a){this.g=a}V.prototype.toString=function(){return this.g+""};var Ya={};function Za(a){if(void 0===U){var b=null;var c=t.trustedTypes;if(c&&c.createPolicy){try{b=c.createPolicy("goog#html",{createHTML:v,createScript:v,createScriptURL:v})}catch(d){t.console&&t.console.error(d.message)}U=b}else U=b}a=(b=U)?b.createScriptURL(a):a;return new V(a,Ya)};function $a(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)};function ab(a,b){b=String(b);"application/xhtml+xml"===a.contentType&&(b=b.toLowerCase());return a.createElement(b)}function bb(a){this.g=a||t.document||document};/*
  
   SPDX-License-Identifier: Apache-2.0
  */
  function cb(a,b){a.src=b instanceof V&&b.constructor===V?b.g:"type_error:TrustedResourceUrl";var c,d;(c=(b=null==(d=(c=(a.ownerDocument&&a.ownerDocument.defaultView||window).document).querySelector)?void 0:d.call(c,"script[nonce]"))?b.nonce||b.getAttribute("nonce")||"":"")&&a.setAttribute("nonce",c)};function db(a){a=void 0===a?document:a;return a.createElement("script")};function eb(a,b,c,d,e,f){try{var g=a.g,h=db(g);h.async=!0;cb(h,b);g.head.appendChild(h);h.addEventListener("load",function(){e();d&&g.head.removeChild(h)});h.addEventListener("error",function(){0<c?eb(a,b,c-1,d,e,f):(d&&g.head.removeChild(h),f())})}catch(l){f()}};var fb=t.atob("aHR0cHM6Ly93d3cuZ3N0YXRpYy5jb20vaW1hZ2VzL2ljb25zL21hdGVyaWFsL3N5c3RlbS8xeC93YXJuaW5nX2FtYmVyXzI0ZHAucG5n"),gb=t.atob("WW91IGFyZSBzZWVpbmcgdGhpcyBtZXNzYWdlIGJlY2F1c2UgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlIGlzIGludGVyZmVyaW5nIHdpdGggdGhpcyBwYWdlLg=="),hb=t.atob("RGlzYWJsZSBhbnkgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlLCB0aGVuIHJlbG9hZCB0aGlzIHBhZ2Uu");function ib(a,b,c){this.i=a;this.u=b;this.o=c;this.g=null;this.j=[];this.m=!1;this.l=new bb(this.i)}
  function lb(a){if(a.i.body&&!a.m){var b=function(){mb(a);t.setTimeout(function(){nb(a,3)},50)};eb(a.l,a.u,2,!0,function(){t[a.o]||b()},b);a.m=!0}}
  function mb(a){for(var b=W(1,5),c=0;c<b;c++){var d=X(a);a.i.body.appendChild(d);a.j.push(d)}b=X(a);b.style.bottom="0";b.style.left="0";b.style.position="fixed";b.style.width=W(100,110).toString()+"%";b.style.zIndex=W(2147483544,2147483644).toString();b.style.backgroundColor=ob(249,259,242,252,219,229);b.style.boxShadow="0 0 12px #888";b.style.color=ob(0,10,0,10,0,10);b.style.display="flex";b.style.justifyContent="center";b.style.fontFamily="Roboto, Arial";c=X(a);c.style.width=W(80,85).toString()+
  "%";c.style.maxWidth=W(750,775).toString()+"px";c.style.margin="24px";c.style.display="flex";c.style.alignItems="flex-start";c.style.justifyContent="center";d=ab(a.l.g,"IMG");d.className=$a();d.src=fb;d.alt="Warning icon";d.style.height="24px";d.style.width="24px";d.style.paddingRight="16px";var e=X(a),f=X(a);f.style.fontWeight="bold";f.textContent=gb;var g=X(a);g.textContent=hb;Y(a,e,f);Y(a,e,g);Y(a,c,d);Y(a,c,e);Y(a,b,c);a.g=b;a.i.body.appendChild(a.g);b=W(1,5);for(c=0;c<b;c++)d=X(a),a.i.body.appendChild(d),
  a.j.push(d)}function Y(a,b,c){for(var d=W(1,5),e=0;e<d;e++){var f=X(a);b.appendChild(f)}b.appendChild(c);c=W(1,5);for(d=0;d<c;d++)e=X(a),b.appendChild(e)}function W(a,b){return Math.floor(a+Math.random()*(b-a))}function ob(a,b,c,d,e,f){return"rgb("+W(Math.max(a,0),Math.min(b,255)).toString()+","+W(Math.max(c,0),Math.min(d,255)).toString()+","+W(Math.max(e,0),Math.min(f,255)).toString()+")"}function X(a){a=ab(a.l.g,"DIV");a.className=$a();return a}
  function nb(a,b){0>=b||null!=a.g&&0!==a.g.offsetHeight&&0!==a.g.offsetWidth||(pb(a),mb(a),t.setTimeout(function(){nb(a,b-1)},50))}function pb(a){for(var b=m(a.j),c=b.next();!c.done;c=b.next())(c=c.value)&&c.parentNode&&c.parentNode.removeChild(c);a.j=[];(b=a.g)&&b.parentNode&&b.parentNode.removeChild(b);a.g=null};function qb(a,b,c,d,e){function f(l){document.body?g(document.body):0<l?t.setTimeout(function(){f(l-1)},e):b()}function g(l){l.appendChild(h);t.setTimeout(function(){h?(0!==h.offsetHeight&&0!==h.offsetWidth?b():a(),h.parentNode&&h.parentNode.removeChild(h)):a()},d)}var h=rb(c);f(3)}function rb(a){var b=document.createElement("div");b.className=a;b.style.width="1px";b.style.height="1px";b.style.position="absolute";b.style.left="-10000px";b.style.top="-10000px";b.style.zIndex="-10000";return b};function Ra(a){this.h=R(a)}r(Ra,T);function sb(a){this.h=R(a)}r(sb,T);var tb=Va(sb);function ub(a){var b=la.apply(1,arguments);if(0===b.length)return Za(a[0]);for(var c=a[0],d=0;d<b.length;d++)c+=encodeURIComponent(b[d])+a[d+1];return Za(c)};function vb(a){if(!a)return null;a=Sa(a,4);var b;null===a||void 0===a?b=null:b=Za(a);return b};var wb=ea([""]),xb=ea([""]);function yb(a,b){this.m=a;this.o=new bb(a.document);this.g=b;this.j=S(this.g,1);this.u=vb(Qa(this.g,2))||ub(wb);this.i=!1;b=vb(Qa(this.g,13))||ub(xb);this.l=new ib(a.document,b,S(this.g,12))}yb.prototype.start=function(){zb(this)};
  function zb(a){Ab(a);eb(a.o,a.u,3,!1,function(){a:{var b=a.j;var c=t.btoa(b);if(c=t[c]){try{var d=Xa(t.atob(c))}catch(e){b=!1;break a}b=b===Sa(d,1)}else b=!1}b?Z(a,S(a.g,14)):(Z(a,S(a.g,8)),lb(a.l))},function(){qb(function(){Z(a,S(a.g,7));lb(a.l)},function(){return Z(a,S(a.g,6))},S(a.g,9),Ta(a.g,10),Ta(a.g,11))})}function Z(a,b){a.i||(a.i=!0,a=new a.m.XMLHttpRequest,a.open("GET",b,!0),a.send())}function Ab(a){var b=t.btoa(a.j);a.m[b]&&Z(a,S(a.g,5))};(function(a,b){t[a]=function(){var c=la.apply(0,arguments);t[a]=function(){};b.call.apply(b,[null].concat(c instanceof Array?c:fa(m(c))))}})("__h82AlnkH6D91__",function(a){"function"===typeof window.atob&&(new yb(window,tb(window.atob(a)))).start()});}).call(this);
  
  window.__h82AlnkH6D91__("WyJwdWItMzQxMTc4NDE1NzU0MzQyMCIsW251bGwsbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9iL3B1Yi0zNDExNzg0MTU3NTQzNDIwIl0sbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9lbC9BR1NLV3hXcFo2SEZhZ2tXV3BBeDkyVm5FUm1HelA4Sng3NDBjbG82QTd1U1BzMjMtb1J6aTl0R2tJZC0ySTZkbU9kVExldXJ5VU5pdDJmWVl6cVN3ZXFSaHFtT1d3XHUwMDNkXHUwMDNkP3RlXHUwMDNkVE9LRU5fRVhQT1NFRCIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFVub2h4aTRwNDRvRHN5UjNjSzBTTlVWdlhldmoySHp3dHBPMk52dlF4SXpPc1RuT1E4ZXV1Qzc4UExTRzROMFplT28xRWF6MG5hYjVHNElnMGJ5M1RqTkFcdTAwM2RcdTAwM2Q/YWJcdTAwM2QxXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFU0c2VpaDRuem1aQ2VKc0s0OUpFdHNBT3ZIZkNGaE9yMXFDN3N5bzRSaHBmamQzay02OGlaakhUT0UybWlxTEx6SnpZYUFPZHhTYWVRMC1LMGRZc0VabWdcdTAwM2RcdTAwM2Q/YWJcdTAwM2QyXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFdROU1sNExITHNkMVg0RzJualpOUXBhVE1GVzVTU2RUb0hUVF9oU1F6OVI3cm1RSVZsR3kzOFgyMng0dDZSVHJLdTVRaUlrdkl0ZFd2TFJ1Mnl2SEVaTXdcdTAwM2RcdTAwM2Q/c2JmXHUwMDNkMiIsImRpdi1ncHQtYWQiLDIwLDEwMCwiY0hWaUxUTTBNVEUzT0RReE5UYzFORE0wTWpBXHUwMDNkIixbbnVsbCxudWxsLG51bGwsImh0dHBzOi8vd3d3LmdzdGF0aWMuY29tLzBlbW4vZi9wL3B1Yi0zNDExNzg0MTU3NTQzNDIwLmpzP3VzcXBcdTAwM2RDQkkiXSwiaHR0cHM6Ly9mdW5kaW5nY2hvaWNlc21lc3NhZ2VzLmdvb2dsZS5jb20vZWwvQUdTS1d4V3YwN0dzbGhnVi1oUV85a0wzV0FhN0hmUXo3dXhKTWFBLUtHQ3VMOUhrWmRVWEFneHNmcVdIYUJrZlhBZkF1TUdyM2hFTmVMeVhZZDItS25ublNQODdwZ1x1MDAzZFx1MDAzZCJd");</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="shortcut icon" href="/assets/img/favicon.ico">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Shawn Hsu
          <span class="site-subtitle">Shawn Hsu's personal study blog | Software Engineer | Backend | Cloud Native | Blockchain</span>
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li>
<li class="masthead__menu-item">
              <a href="/archive/">Archive</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories/">Categories</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Tags</a>
            </li>
</ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#kubernetes" itemprop="item"><span itemprop="name">Kubernetes</span></a>
          <meta itemprop="position" content="2">
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">Kubernetes 從零開始 - 部署策略 101</li>
      
    
  </ol>
</nav>

  


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const sidebarNav = document.querySelector("nav.toc");
    if (!sidebarNav) {
      return;
    }

    // Find the actual scrollable container
    let scrollContainer = null;

    // Check if the nav itself is scrollable
    if (sidebarNav.scrollHeight > sidebarNav.offsetHeight) {
      scrollContainer = sidebarNav;
    } else {
      // Look for scrollable children
      const tocMenu = sidebarNav.querySelector(".toc__menu");
      if (tocMenu && tocMenu.scrollHeight > tocMenu.offsetHeight) {
        scrollContainer = tocMenu;
      } else {
        // Look for any scrollable child
        const children = sidebarNav.children;
        for (let child of children) {
          if (child.scrollHeight > child.offsetHeight) {
            scrollContainer = child;
            break;
          }
        }
      }
    }

    if (!scrollContainer) {
      return;
    }

    let isUserScrolling = false;
    let autoScrollEnabled = true;
    let scrollTimeout;
    let pageScrollTimeout;
    let periodicCheckInterval;

    // Function to check if element is visible in container
    const isElementVisible = (element) => {
      const containerTop = scrollContainer.scrollTop;
      const containerHeight = scrollContainer.offsetHeight;
      const elementTop = element.offsetTop;
      const elementHeight = element.offsetHeight;

      const isVisible =
        elementTop >= containerTop &&
        elementTop + elementHeight <= containerTop + containerHeight;

      return isVisible;
    };

    // Function to find the current active heading based on scroll position
    const findCurrentActiveHeading = () => {
      const headings = document.querySelectorAll(
        "h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]"
      );
      const scrollY = window.scrollY;
      const offset = 100; // Offset to trigger activation

      let currentHeading = null;

      // Find the heading that's currently at the top of the viewport
      for (let i = 0; i < headings.length; i++) {
        const heading = headings[i];
        const headingTop = heading.offsetTop;

        if (headingTop <= scrollY + offset) {
          currentHeading = heading;
        } else {
          break;
        }
      }

      return currentHeading;
    };

    // Function to find the TOC element that corresponds to a heading
    const findTocElementForHeading = (heading) => {
      if (!heading || !heading.id) return null;

      const tocLinks = document.querySelectorAll("nav.toc a");
      for (const link of tocLinks) {
        if (link.getAttribute("href") === `#${heading.id}`) {
          return link.closest("li");
        }
      }
      return null;
    };

    // Function to scroll TOC to show active element
    const scrollTocToActive = () => {
      // Don't auto-scroll if user is manually scrolling or auto-scroll is disabled
      if (isUserScrolling || !autoScrollEnabled) {
        return;
      }

      // Always use scroll position to find the current heading
      const currentHeading = findCurrentActiveHeading();
      if (!currentHeading) {
        return;
      }

      const activeElement = findTocElementForHeading(currentHeading);
      if (!activeElement) {
        return;
      }

      // Check if active element is visible
      if (!isElementVisible(activeElement)) {
        // Get the current scroll position and container dimensions
        const currentScrollTop = scrollContainer.scrollTop;
        const containerHeight = scrollContainer.offsetHeight;
        const elementTop = activeElement.offsetTop;
        const elementHeight = activeElement.offsetHeight;

        // Calculate the position to center the active element in the visible area
        const targetScrollTop =
          elementTop - containerHeight / 2 + elementHeight / 2;

        // Ensure we don't scroll beyond the bounds
        const maxScrollTop = scrollContainer.scrollHeight - containerHeight;
        const finalScrollTop = Math.max(
          0,
          Math.min(targetScrollTop, maxScrollTop)
        );

        // Scroll to the target position
        scrollContainer.scrollTo({
          top: finalScrollTop,
          behavior: "smooth",
        });
      }
    };

    // Function to enable auto-scroll
    const enableAutoScroll = () => {
      if (!autoScrollEnabled) {
        autoScrollEnabled = true;
        // Resume periodic checks
        startPeriodicCheck();
      }
    };

    // Function to disable auto-scroll
    const disableAutoScroll = () => {
      if (autoScrollEnabled) {
        autoScrollEnabled = false;
        // Stop periodic checks
        if (periodicCheckInterval) {
          clearInterval(periodicCheckInterval);
          periodicCheckInterval = null;
        }
      }
    };

    // Function to start periodic check
    const startPeriodicCheck = () => {
      if (!periodicCheckInterval) {
        periodicCheckInterval = setInterval(() => {
          scrollTocToActive();
        }, 5000); // Increased interval to 5 seconds
      }
    };

    // Handle TOC scrolling
    scrollContainer.addEventListener("scroll", () => {
      isUserScrolling = true;
      disableAutoScroll(); // Disable auto-scroll when user scrolls TOC

      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }

      scrollTimeout = setTimeout(() => {
        isUserScrolling = false;
        // Don't automatically re-enable auto-scroll here
        // It will be re-enabled when user interacts with main page
      }, 500);
    });

    // Handle page scrolling
    window.addEventListener("scroll", () => {
      enableAutoScroll(); // Re-enable auto-scroll when user scrolls main page

      if (pageScrollTimeout) {
        clearTimeout(pageScrollTimeout);
      }

      pageScrollTimeout = setTimeout(() => {
        scrollTocToActive();
      }, 100);
    });

    // Handle clicks on main page content
    document.addEventListener("click", (event) => {
      // Only enable auto-scroll if click is not on TOC
      if (!sidebarNav.contains(event.target)) {
        enableAutoScroll();
      }
    });

    // Handle keyboard navigation
    document.addEventListener("keydown", () => {
      enableAutoScroll();
    });

    // Initial scroll to active element
    setTimeout(() => {
      scrollTocToActive();
    }, 1000);

    // Start periodic check
    startPeriodicCheck();
  });
</script>


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://ambersuncreates.com/" itemprop="url">Shawn Hsu</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>For it isn’t by size that you win or fail</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Taipei, Taiwan</span>
        </li>
      

      
        
          
        
          
        
          
        
          
            <li><a href="https://github.com/ambersun1234" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
          
            <li><a href="https://www.linkedin.com/in/ambersun1234" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
      

      

      
        <li>
          <a href="mailto:ambersun1019.shawn@gmail.com" rel="me" class="u-email">
            <meta itemprop="email" content="ambersun1019.shawn@gmail.com">
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Kubernetes 從零開始 - 部署策略 101">
    <meta itemprop="description" content="Scaling Workloads只有單台機器服務的情況下，多數是不足的因為你需要考量到，比如說服務突然的不可用(軟體錯誤、硬體故障等等的)，或者是流量真的大到一台機器處理不來的情況這時候你就會需要用到 “scaling” 的概念">
    <meta itemprop="datePublished" content="2025-09-24T00:00:00+08:00">
    <meta itemprop="dateModified" content="2025-10-10T21:45:50+08:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="https://ambersuncreates.com/kubernetes/kubernetes-scale/" class="u-url" itemprop="url">Kubernetes 從零開始 - 部署策略 101
</a>
          </h1>
          


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          29 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-09-24">2025-09-24</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-10-10">
            2025-10-10
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/kubernetes/kubernetes-scale/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/kubernetes/kubernetes-scale/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/kubernetes/kubernetes-scale/").innerHTML = text;
      }
    })
</script>

        </header>
      

      <section class="page__content e-content" itemprop="text" style="margin-top: 2em">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title">
<i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu">
<li>
<a href="#scaling-workloads">Scaling Workloads</a><ul>
<li><a href="#manual-scaling">Manual Scaling</a></li>
<li>
<a href="#auto-scaling">Auto Scaling</a><ul>
<li>
<a href="#horizontal-pod-autoscalerhpa">Horizontal Pod Autoscaler(HPA)</a><ul>
<li>
<a href="#the-scaling-behavior">The Scaling Behavior</a><ul>
<li><a href="#tolerance">Tolerance</a></li>
<li><a href="#stabilization-window">Stabilization Window</a></li>
<li><a href="#scaling-policy">Scaling Policy</a></li>
</ul>
</li>
<li>
<a href="#metric-data">Metric Data</a><ul><li><a href="#metrics-apis">Metrics APIs</a></li></ul>
</li>
<li><a href="#summary">Summary</a></li>
</ul>
</li>
<li>
<a href="#vertical-pod-autoscalervpa">Vertical Pod Autoscaler(VPA)</a><ul>
<li><a href="#vpa-operate-mode">VPA Operate Mode</a></li>
<li><a href="#resize-container-resources">Resize Container Resources</a></li>
</ul>
</li>
<li><a href="#event-driven-autoscaling">Event Driven Autoscaling</a></li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#different-deployment-strategies">Different Deployment Strategies</a><ul>
<li><a href="#recreate-and-rolling-update">Recreate and Rolling Update</a></li>
<li><a href="#canary-deployment">Canary Deployment</a></li>
<li><a href="#blue-green-deployment">Blue Green Deployment</a></li>
<li><a href="#ab-testing">A/B Testing</a></li>
<li><a href="#shadow-deployment">Shadow Deployment</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</li>
<li>
<a href="#how-kubernetes-handle-deployment-strategy">How Kubernetes Handle Deployment Strategy</a><ul><li>
<a href="#argo-rollouts">Argo Rollouts</a><ul>
<li><a href="#architecture">Architecture</a></li>
<li>
<a href="#rollout-crd">Rollout CRD</a><ul>
<li><a href="#blue-green-and-canary-deployment">Blue Green and Canary Deployment</a></li>
<li><a href="#hpa-and-vpa">HPA and VPA</a></li>
</ul>
</li>
</ul>
</li></ul>
</li>
<li><a href="#references">References</a></li>
</ul>

            </nav>

            <br>

            <div class="sidebar__top_down" style="display: flex;">
              <div>
                <nav style="padding: 0 0.5em;">
                  <a href="#site-nav"> <i class="fas fa-angle-double-up fa-2x"></i></a>
                </nav>
              </div>

              <div>
                <nav style="padding: 0 0.5em;">
                  <a href="#footer"> <i class="fas fa-angle-double-down fa-2x"></i></a>
                </nav>
              </div>
            </div>

            
          </aside>
        
        <h1 id="scaling-workloads">Scaling Workloads</h1>
<p>只有單台機器服務的情況下，多數是不足的<br>
因為你需要考量到，比如說服務突然的不可用(軟體錯誤、硬體故障等等的)，或者是流量真的大到一台機器處理不來的情況<br>
這時候你就會需要用到 “scaling” 的概念</p>

<p>在 <a href="../../database/database-distributed-database">資料庫 - 初探分散式資料庫 | Shawn Hsu</a> 中，我們有大概的看過一些概念</p>
<ul>
  <li>
<a href="#horizontal-pod-autoscalerhpa">scale out</a>
    <ul>
      <li>透過將 application 分散到不同的機器上面，解決單台機器硬體資源不足的問題</li>
    </ul>
  </li>
  <li>
<a href="#vertical-pod-autoscalervpa">scale up</a>
    <ul>
      <li>單純的增加單台機器上的硬體資源如 CPU, Memory 等等</li>
    </ul>
  </li>
</ul>

<p>如今的系統架構，基本上都使用 <a href="#horizontal-pod-autoscalerhpa">scale out</a> 的概念居多<br>
原因在於說，單台機器的硬體資源是有上限的，你的 CPU 跟 Memory 不可能無限增加，相反的，多台機器可以解決這個問題(你可以無限增加機器數量，把它連起來就好)</p>

<blockquote>
  <p><a href="https://pm2.keymetrics.io/">Node.js PM2</a> 的 cluster mode 也是利用了 scaling 的概念</p>
</blockquote>

<blockquote>
  <p>scale out 要注意的是，你的服務最好是 stateless 的<br>
stateful 其實也可以，只是資料一致性等等會是個滿大的問題<br>
而 HTTP server 基本上都是 stateless 的，所以你可以很輕鬆的 scale out</p>
</blockquote>

<blockquote>
  <p>還有一個很常見的誤區，monolithic 架構是可以 scale 的<br>
不是只有 microservice 架構可以 scale</p>
</blockquote>

<h2 id="manual-scaling">Manual Scaling</h2>
<p>有一個真實的例子是這樣子的<br>
行銷團隊預計在晚上的時候向使用者推播一個新消息<br>
然後訊息內容裡面包含一個到官網的連結，告訴使用者說官網全新改版</p>

<p>所以其實我們可以預期說，在晚上的時候網站的流量應該會增加，是比平常還要多的那種程度<br>
讓機器自己 scale 肯定是沒有問題的，但是我們都忽略了一個至關重要的細節<br>
也就是雲端自己把機器建立起來，執行起來是需要花時間的<br>
這個等待時間是致命的</p>

<p>因為可能第二台機器上線了，然後因為這個 delay，使用者早就看完並離開，流量又下去了<br>
然後他什麼也沒做就又被迫下線，然後使用者體驗到的是一個卡到爆的網站<br>
可能行銷帶來的效益就不是那麼足夠了</p>

<p>也因此，針對這種 <strong>已知會有流量增加的</strong> 的情況，比較好的方式是事先手動增加服務容量<br>
換句話說，在行銷團隊要發送推播的時候，工程團隊就必須先手動調整好伺服器的設定，用以應對接下來的流量<br>
這樣使用者體驗到的就會是流暢的服務</p>

<h2 id="auto-scaling">Auto Scaling</h2>
<p>相比之下，auto scaling 能夠自己根據目前不同的負載自動的調整所需要的資源</p>

<blockquote>
  <p>如果單純的 scale workloads 還無法滿足需求，那就需要進行 node 的 scale 了<br>
可以參考 <a href="https://kubernetes.io/docs/concepts/cluster-administration/node-autoscaling/">Node Autoscaling</a></p>
</blockquote>

<h3 id="horizontal-pod-autoscalerhpa">Horizontal Pod Autoscaler(HPA)</h3>
<p>在 Kubernetes 中，<code class="language-plaintext highlighter-rouge">scale out</code> 是透過 <code class="language-plaintext highlighter-rouge">Horizontal Pod Autoscaler(HPA)</code> 來實現的</p>

<p>HPA 是透過所謂的 control loop 去不定時的監控底下的資源(預設是 15 秒掃一次，但可以用 <code class="language-plaintext highlighter-rouge">--horizontal-pod-autoscaler-sync-period</code> 來調整)<br>
具體來說是，在 <code class="language-plaintext highlighter-rouge">HorizontalPodAutoscaler</code> CRD 裡面，指定說你要監聽的 resource 是哪一個(apiVersion, kind 跟 name)<br>
然後就看該 resource 的 metrics 做調整</p>

<blockquote>
  <p>對於那種不支援 scale 的 resource 如 <strong>DemonSet</strong> 是沒辦法使用 HPA 的</p>
</blockquote>

<p>更具體一點來說，他是根據 metrics 決定 replica 的數量的</p>

\[desiredReplicas = \lceil currentReplicas \times \frac{currentMetric}{desiredMetric} \rceil\]

<p>這個公式中，透過計算 metric 的比值決定你需不需要調整 replica 的數量<br>
完美的情況下，這個比值應該為 <strong><em>1</em></strong>，所以 desiredReplicas 會等於 currentReplicas<br>
而因為 metric 的資料是即時且不斷變化的，replica 數量會被一直調整<br>
造成所謂的 thrashing 現象(或稱 flapping)</p>

<blockquote>
  <p>flapping 的問題可以透過設定 <a href="#stabilization-window">Stabilization Window</a> 以及 <a href="#tolerance">Tolerance</a> 來調整</p>
</blockquote>

<h4 id="the-scaling-behavior">The Scaling Behavior</h4>
<p>要如何 scale 是個好問題<br>
replica 的數量如果忽高忽低，對底層的 infra 來說是一種負擔，何況是對使用者<br>
因此，在 HPA 裡面，你可以細部調整 K8s 要如何 scale<br>
具體來說，有 <a href="#scaling-policy">Scaling Policy</a>, <a href="#stabilization-window">Stabilization Window</a> 以及 <a href="#tolerance">Tolerance</a> 可以調整</p>

<h5 id="tolerance">Tolerance</h5>
<p><code class="language-plaintext highlighter-rouge">tolerance</code> 本質上就是允許一定程度的上下浮動<br>
讓 replica 的數量不會太過敏感<br>
預設情況下是 <code class="language-plaintext highlighter-rouge">10%</code> 的誤差範圍，可以透過 <code class="language-plaintext highlighter-rouge">--horizontal-pod-autoscaler-tolerance</code> 來調整<br>
或是 CRD 裡面直接指定 tolerance(可以參考 <a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/#HorizontalPodAutoscalerSpec">HorizontalPodAutoscalerSpec</a>)</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="na">behavior</span><span class="pi">:</span>
  <span class="na">scaleUp</span><span class="pi">:</span>
    <span class="na">tolerance</span><span class="pi">:</span> <span class="m">0.05</span> <span class="c1"># 5% tolerance for scale up</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<h5 id="stabilization-window">Stabilization Window</h5>
<p><code class="language-plaintext highlighter-rouge">stabilization window</code> 也可以解決 flapping 的問題<br>
因為 metric 的資料不間斷變化會造成 Pod 的數量不斷的上下浮動<br>
既然數量會一直變化，其中的一個辦法是取一段時間區間，看說這段時間內，Pod 的數量如何<br>
HPA 的算法會在資料區間，取得 <strong><em>最高的 replica 數量</em></strong> 使用</p>

<p>為什麼是最高？</p>

<ul>
  <li>
    <p>如果流量一會高一會低，區間內最高值基本上就會是 <strong>持平</strong> 的趨勢<br>
也就是說 Pod 並不會突然的被刪掉又被加回來</p>
  </li>
  <li>
    <p>如果流量確實在減少，那麼計算出來的 desired replica count 肯定會隨著時間越來越少<br>
每一次的 evaluation 如果都取最高值，最終也會呈現 <strong>緩降</strong> 的趨勢<br>
如此一來便達到穩定的目的</p>
  </li>
</ul>

<blockquote>
  <p>stabilizationWindowSeconds 也可以設定 scaleUp 的狀況<br>
只是不太常這樣用，因為 scale up 就代表很緊急了(客訴滿天飛)，所以不需要穩定期</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="na">behavior</span><span class="pi">:</span>
  <span class="na">scaleDown</span><span class="pi">:</span>
    <span class="na">stabilizationWindowSeconds</span><span class="pi">:</span> <span class="m">300</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>可以在 CRD 裡面直接指定 stabilizationWindowSeconds(可以參考 <a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/#HorizontalPodAutoscalerSpec">HorizontalPodAutoscalerSpec</a>)</p>
</blockquote>

<h5 id="scaling-policy">Scaling Policy</h5>
<p>另外的 <code class="language-plaintext highlighter-rouge">scaling policy</code> 也同樣可以應用於 scaling 的調整<br>
有別於 <a href="#stabilization-window">Stabilization Window</a> 以及 <a href="#tolerance">Tolerance</a> 針對 replica 數量的決策<br>
policy 主要著墨在 “如何調整”</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="na">behavior</span><span class="pi">:</span>
  <span class="na">scaleDown</span><span class="pi">:</span>
    <span class="na">policies</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Pods</span>
      <span class="na">value</span><span class="pi">:</span> <span class="m">4</span>
      <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">60</span>
    <span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">Percent</span>
      <span class="na">value</span><span class="pi">:</span> <span class="m">10</span>
      <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">60</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>可以在 CRD 裡面直接指定 policies(可以參考 <a href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2/#HorizontalPodAutoscalerSpec">HorizontalPodAutoscalerSpec</a>)</p>
</blockquote>

<p>假設計算出來的 desired replica 是 100 但是當前只有 10<br>
意味著 90 個 Pod 要被啟動<br>
一次性啟動這麼多 Pod，雖然是合法的，但你其實不確定這會不會造成問題<br>
像我自己在本機跑 cluster 的時候，如果一次建立這麼多的 Pod，我是有感覺到電腦忽然變卡<br>
而這種穩定性問題是需要被重視的</p>

<p>既然不建議一次啟動這麼多 Pod，分批也是可行的選項<br>
所以這其實就是 <code class="language-plaintext highlighter-rouge">scaling policy</code> 要做的事情<br>
透過定義 “如何” 調整，穩定的 scale 才是我們想要的</p>

<p>上述例子中</p>
<ul>
  <li>policy[0] 代表著 60 秒內只能調整 4 個 Pod</li>
  <li>policy[1] 代表著 60 秒內只能調整總體 10% 的 Pod</li>
</ul>

<p>你可以針對 <code class="language-plaintext highlighter-rouge">scaleUp</code> 以及 <code class="language-plaintext highlighter-rouge">scaleDown</code> 分別指定不同的 policy<br>
然後如果你有多個 policies，可以額外設定 <code class="language-plaintext highlighter-rouge">.spec.behavior.scaleUp.selectPolicy</code> 決定要怎麼挑<br>
是要在眾多 policies 中挑選 <strong><em>影響最大還是最小的</em></strong>(Min, Max)，又或者是禁用調整(Disabled)呢？</p>

<blockquote>
  <p>預設 selectPolicy 會挑影響最大的，也就是 <code class="language-plaintext highlighter-rouge">Max</code></p>
</blockquote>

<h4 id="metric-data">Metric Data</h4>
<p>稍早在 <a href="#horizontal-pod-autoscalerhpa">Horizontal Pod Autoscaler(HPA)</a> 提到，replica 數量是透過 metric 來決定的<br>
可是還是很抽象，究竟要監聽什麼呢？<br>
更具體的來說，你可以使用以下這些資源</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">Resource</code>
    <ul>
      <li>一個最基本的判斷方式就是使用 CPU, Memory 的資源去判斷需不需要 scale<br>
  每個 scale target 底層一定都是執行 Pod，每個 Pod 用的資源都不一樣，多個 Pod 的資源會被 <strong>平均起來</strong> 計算進而得出 current metric
        <blockquote>
          <p>不過，由於他會被平均起來，所以有可能總體是足夠的，但其中某個 Pod 累得半死也是有可能的</p>
        </blockquote>
      </li>
    </ul>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">ContainerResource</code>
    <ul>
      <li>為了避免 Pod 平均帶來的誤差，你也可以指定在 container level 計算<br>
  其他都跟 <code class="language-plaintext highlighter-rouge">Resource</code> 一樣，只不過是看 scale target 底下的 Pod 底下的 container<br>
  而且也都是會被平均起來算出 current metric</li>
    </ul>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">Pods</code>
    <ul>
      <li>我們稍早都是在看 CPU, Memory 的資源，那有沒有其他資源可以使用呢？<br>
  答案也是肯定的，只不過需要客製化(可以參考 <a href="#metrics-apis">Metrics APIs</a>)<br>
  計算方式也一樣，會被平均起來做比較</li>
    </ul>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">Object</code>
    <ul>
      <li>這種類型比較特別，他是監聽 <strong><em>single Kubernetes object</em></strong> 的 metric<br>
  文件上的例子是 Ingress 的 hits-per-second<br>
  在建立路由的時候，你的規則是定義在 Ingress Object 內，配合 <a href="#metrics-apis">Metrics APIs</a> 可以搭配查詢說有多少流量進來</li>
    </ul>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">External</code>
    <ul>
      <li>這種類型比較特別，他是監聽 <strong><em>external resource</em></strong> 的 metric<br>
  外部指的就是說，這個 metric 不是 Kubernetes 內建的，而是你自行定義的<br>
  比方說，consumer 的數是由 message queue 內部的資料數量決定，而當然他也是需要 <a href="#metrics-apis">Metrics APIs</a> 的配合</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>可以參考 <code class="language-plaintext highlighter-rouge">$ kubectl explain hpa.spec.metrics</code></p>
</blockquote>

<p>公式裡的 current metric 已經定義好了<br>
剩下的 desired metric 就相對簡單了</p>

\[desiredReplicas = \lceil currentReplicas \times \frac{currentMetric}{desiredMetric} \rceil\]

<p>就三種類型</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">averageUtilization</code>: 平均的數字(百分比)</li>
  <li>
<code class="language-plaintext highlighter-rouge">averageValue</code>: 平均的數字</li>
  <li>
<code class="language-plaintext highlighter-rouge">value</code>: 單純的數字，沒有平均過的數值(適用於 <code class="language-plaintext highlighter-rouge">Object</code> 這種，比方說計算 hits-per-second 的時候)</li>
</ul>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">Resource</code> 搭配 <code class="language-plaintext highlighter-rouge">averageUtilization</code> 會變成平均的平均嗎？<br>
是 current metric 先平均，得到 A 這個平均值，然後跟 desired metric 的平均值 B 相比較</p>
</blockquote>

<blockquote>
  <p>可以參考 <code class="language-plaintext highlighter-rouge">$ kubectl explain hpa.spec.metrics.{metric_type}.target</code></p>
</blockquote>

<h5 id="metrics-apis">Metrics APIs</h5>
<p>我們知道了要監聽什麼，監聽的資料從哪來又是個問題<br>
HPA controller 是透過 Metrics API 取得資料的<br>
而以下的設定是必要的</p>
<ol>
  <li>
<a href="https://kubernetes.io/docs/tasks/extend-kubernetes/configure-aggregation-layer/">API Aggregation Layer</a> 需要被啟用</li>
  <li>Metrics API 需要被啟用。基本上來說，分成三大種
    <ul>
      <li>
<code class="language-plaintext highlighter-rouge">resource metrics</code>: 基本上資料會從 <a href="https://github.com/kubernetes-sigs/metrics-server">metrics server</a> 取得，資料內容會是 K8s object 的資料</li>
      <li>
<code class="language-plaintext highlighter-rouge">custom metrics</code>: 但是如果你需要自己客製化資料，就是 custom metrics。注意到他還是使用 K8s object 的資料</li>
      <li>
<code class="language-plaintext highlighter-rouge">external metrics</code>: 客製化，但是是外部的資料</li>
    </ul>
  </li>
</ol>

<p>舉例來說 <a href="https://github.com/kubernetes-sigs/prometheus-adapter">kubernetes-sigs/prometheus-adapter</a> 裡面包含了 custom metrics 以及 external metrics 的實現</p>

<h4 id="summary">Summary</h4>
<p>HPA 的概念稍微複雜許多，你需要搞清楚不同資源下需要的設定檔是哪一種<br>
並且需要意識到在 scaling 的過程中可能產生的問題<br>
東西蠻多，需要多多消化</p>

<h3 id="vertical-pod-autoscalervpa">Vertical Pod Autoscaler(VPA)</h3>
<p>在 Kubernetes 中，<code class="language-plaintext highlighter-rouge">scale up</code>(調整 Pod 的資源，比如說 CPU 跟 Memory) 是透過 <code class="language-plaintext highlighter-rouge">Vertical Pod Autoscaler(VPA)</code> 來實現的<br>
VPA 並非內建的，是需要額外安裝的(<a href="https://github.com/kubernetes/autoscaler/tree/9f87b78df0f1d6e142234bb32e8acbd71295585a/vertical-pod-autoscaler">kubernetes/autoscaler</a>)</p>

<p>VPA 會需要額外的 <a href="https://github.com/kubernetes-sigs/metrics-server">metrics server</a> 取得目前的資源使用情況<br>
使用的部分，你會需要撰寫 <code class="language-plaintext highlighter-rouge">VerticalPodAutoscaler</code> 的 CRD 來實現<br>
然後再 CRD 內部，指定你要監聽的 Resource 是什麼，比如說這個例子會是 <code class="language-plaintext highlighter-rouge">hamster</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td>
<td class="rouge-code"><pre><span class="c1"># This config creates a deployment with two pods, each requesting 100 millicores</span>
<span class="c1"># and trying to utilize slightly above 500 millicores (repeatedly using CPU for</span>
<span class="c1"># 0.5s and sleeping 0.5s).</span>
<span class="c1"># It also creates a corresponding Vertical Pod Autoscaler that adjusts the</span>
<span class="c1"># requests.</span>
<span class="c1"># Note that the update mode is left unset, so it defaults to "Auto" mode.</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">autoscaling.k8s.io/v1"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VerticalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hamster-vpa</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="c1"># recommenders field can be unset when using the default recommender.</span>
  <span class="c1"># When using an alternative recommender, the alternative recommender's name</span>
  <span class="c1"># can be specified as the following in a list.</span>
  <span class="c1"># recommenders: </span>
  <span class="c1">#   - name: 'alternative'</span>
  <span class="na">targetRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">apps/v1"</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">hamster</span>
  <span class="na">resourcePolicy</span><span class="pi">:</span>
    <span class="na">containerPolicies</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">containerName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">*'</span>
        <span class="na">minAllowed</span><span class="pi">:</span>
          <span class="na">cpu</span><span class="pi">:</span> <span class="s">100m</span>
          <span class="na">memory</span><span class="pi">:</span> <span class="s">50Mi</span>
        <span class="na">maxAllowed</span><span class="pi">:</span>
          <span class="na">cpu</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">memory</span><span class="pi">:</span> <span class="s">500Mi</span>
        <span class="na">controlledResources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">cpu"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">memory"</span><span class="pi">]</span>
    <span class="na">updatePolicy</span><span class="pi">:</span>
      <span class="na">updateMode</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Auto"</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">hamster</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">hamster</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">hamster</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">securityContext</span><span class="pi">:</span>
        <span class="na">runAsNonRoot</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">runAsUser</span><span class="pi">:</span> <span class="m">65534</span> <span class="c1"># nobody</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">hamster</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">registry.k8s.io/ubuntu-slim:0.1</span>
          <span class="na">resources</span><span class="pi">:</span>
            <span class="na">requests</span><span class="pi">:</span>
              <span class="na">cpu</span><span class="pi">:</span> <span class="s">100m</span>
              <span class="na">memory</span><span class="pi">:</span> <span class="s">50Mi</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/bin/sh"</span><span class="pi">]</span>
          <span class="na">args</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">-c"</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">while</span><span class="nv"> </span><span class="s">true;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">timeout</span><span class="nv"> </span><span class="s">0.5s</span><span class="nv"> </span><span class="s">yes</span><span class="nv"> </span><span class="s">&gt;/dev/null;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">0.5s;</span><span class="nv"> </span><span class="s">done"</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>當你執行以上 Deployment 與 VPA 之後，過一陣子你會發現到，你的 Pod 的資源使用情況會被 VPA 調整<br>
注意到是 Pod 的 resources 被調整，而非 Deployment 的 resources 被調整</p>

<h4 id="vpa-operate-mode">VPA Operate Mode</h4>
<p>上述的例子中你可以看到 VPA 有所謂的運作模式</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Mode</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Off</code></td>
      <td style="text-align: left">VPA 不會調整 Pod 的資源</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Initial</code></td>
      <td style="text-align: left">VPA 會在 <strong>資源建立的當下</strong> 調整 Pod 的資源，之後不會調整</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Recreate</code></td>
      <td style="text-align: left">會動態的調整資源，不論是建立還是更新都是 <strong>重新建立</strong> 新的 Pod</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">Auto</code></td>
      <td style="text-align: left">目前是 Recreate Operate Mode</td>
    </tr>
  </tbody>
</table>

<p>重新建立 Pod 這個行為有可能會影響到你應用程式的執行，所以他其實沒有那麼的適合<br>
於是 Kubernetes VPA 團隊正在整合 <strong>In-place Pod Vertical Scaling</strong> 的技術<br>
旨在不重新建立 Pod 的情況下調整其資源</p>

<blockquote>
  <p>恩？ 整合？<br>
Kubernetes 本身已經有支援 Pod 的資源的 In-place 調整(可以參考 <a href="#resize-container-resources">Resize Container Resources</a>)<br>
也就是說其實 Pod 的資源的 In-place 調整已經支援了，只是 VPA 的整合還沒有完成</p>
</blockquote>

<h4 id="resize-container-resources">Resize Container Resources</h4>
<p>具體來說，Pod 的資源可以不需要重新啟動就可以調整資源<br>
事實上在 Kubernetes 早在 <code class="language-plaintext highlighter-rouge">1.27</code> 中引入了 <code class="language-plaintext highlighter-rouge">InPlacePodVerticalScaling</code> feature gate<br>
並於 <code class="language-plaintext highlighter-rouge">1.33</code> 正式進入 <code class="language-plaintext highlighter-rouge">beta</code> 階段</p>

<blockquote>
  <p>然後 kubectl 也需要至少 <code class="language-plaintext highlighter-rouge">v1.32</code> 才能使用 <code class="language-plaintext highlighter-rouge">--subresource=resize</code> 這個參數</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>kubectl get <span class="nt">--raw</span> /metrics | <span class="nb">grep </span>InPlacePodVerticalScaling
kubernetes_feature_enabled<span class="o">{</span><span class="nv">name</span><span class="o">=</span><span class="s2">"InPlacePodVerticalScaling"</span>,stage<span class="o">=</span><span class="s2">"ALPHA"</span><span class="o">}</span> 0
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>所以要怎麼 resize 資源呢？</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>kubectl patch pod resize-demo <span class="nt">--subresource</span> resize <span class="nt">--patch</span> <span class="se">\</span>
  <span class="s1">'{"spec":{"containers":[{"name":"pause", "resources":{"requests":{"cpu":"800m"}, "limits":{"cpu":"800m"}}}]}}'</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>或者是直接 <code class="language-plaintext highlighter-rouge">apply -f --subresource resize --server-side</code> 會比較直覺</p>
</blockquote>

<p>同一時間你會需要所謂的 resize policy<br>
一個新定義的欄位 <code class="language-plaintext highlighter-rouge">spec.containers[].resizePolicy</code></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td>
<td class="rouge-code"><pre><span class="na">resizePolicy</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">resourceName</span><span class="pi">:</span> <span class="s">cpu</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">NotRequired</span>
<span class="pi">-</span> <span class="na">resourceName</span><span class="pi">:</span> <span class="s">memory</span>
  <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">RestartContainer</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>以上兩個資源的 restartPolicy 不一樣的情況下<br>
會 fallback 成 <code class="language-plaintext highlighter-rouge">RestartContainer</code>，一個要重啟一個不要，那當然就是重啟囉(比較嚴格的 policy)</p>
</blockquote>

<p>目前來說，Kubernetes 1.34 含以前，你只能更改 <code class="language-plaintext highlighter-rouge">cpu</code> 以及 <code class="language-plaintext highlighter-rouge">memory</code> 的資源<br>
然後指定要不要進行重啟，如果沒指定，預設會是 <code class="language-plaintext highlighter-rouge">NotRequired</code><br>
會需要重啟的原因，比如說你的 application 需要重啟才能拿到更多 memory 之類的</p>

<blockquote>
  <p>而這個重啟很有意思的是，如果 Pod 等級的 <code class="language-plaintext highlighter-rouge">restartPolicy</code> 是 <code class="language-plaintext highlighter-rouge">Never</code><br>
在 <code class="language-plaintext highlighter-rouge">resizePolicy.restartPolicy</code> 就 <strong>只能指定為</strong> <code class="language-plaintext highlighter-rouge">NotRequired</code><br>
resize 要重啟但是 Pod 不重啟顯然這樣會衝突<br>
<br>
init container 這種沒辦法重啟的是無法使用 resize 功能的(但是 sidecar 可以，可參考 <a href="../../kubernetes/kubernetes-sidecar">Kubernetes 從零開始 - Sidecar 與 Lifecycle Hook 組合技 | Shawn Hsu</a>)</p>
</blockquote>

<p>不過這個 resize 的要求很大程度上是看目前的狀態而定<br>
不能說你要求了 1 個 CPU，結果現在只有 0.5 個 CPU，這樣是不行的<br>
你可以根據 Pod 回給你的狀態來確認這件事情</p>

<p>Pod status condition 的內容會有以下新增</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">PodResizePending</code> type
    <ul>
      <li>kubelet 已經確認了你的要求，但不能馬上滿足，根據 <code class="language-plaintext highlighter-rouge">message</code> 的內容你可以確切地知道為什麼會 pending</li>
      <li>
<code class="language-plaintext highlighter-rouge">message</code>
        <ul>
          <li>
<code class="language-plaintext highlighter-rouge">reason: Infeasible</code>: <img class="emoji" title=":arrow_right:" alt=":arrow_right:" src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png" height="20" width="20"> 你的要求根本不可能滿足(比方說你要求的 CPU 資源超過該節點的總量)</li>
          <li>
<code class="language-plaintext highlighter-rouge">reason: Deferred</code> <img class="emoji" title=":arrow_right:" alt=":arrow_right:" src="https://github.githubassets.com/images/icons/emoji/unicode/27a1.png" height="20" width="20"> 你的要求目前不可能滿足，但我可以重試(我把某某 Pod 刪掉就可以滿足你的需求之類的)</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">PodResizeInProgress</code> type
    <ul>
      <li>kubelet 已經確認你的要求並且正在調動資源，如果有出什麼意外，也會在 <code class="language-plaintext highlighter-rouge">message</code> 中告訴你</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/img/posts/resize1.png" alt=""></p>

<p>你會發現說，其實上面的狀態也不夠，因為完成是不會有狀態的，上述只會跟你講失敗的情況<br>
所以另外一個欄位 <code class="language-plaintext highlighter-rouge">status.observedGeneration</code> 被引入了(他是 <code class="language-plaintext highlighter-rouge">PodObservedGenerationTracking</code> feature gate，於 <code class="language-plaintext highlighter-rouge">1.33</code> 引入)<br>
generation 的目的是在於紀錄每一次的改動(i.e. <code class="language-plaintext highlighter-rouge">metadata.generation</code>)<br>
而 <code class="language-plaintext highlighter-rouge">status.observedGeneration</code> 則是紀錄 kubelet 已經確認並完成的 generation</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"><code class="language-plaintext highlighter-rouge">.metadata.generation</code></th>
      <th style="text-align: center">
<code class="language-plaintext highlighter-rouge">.status.observedGeneration</code> 以及 <code class="language-plaintext highlighter-rouge">.status.conditions[].observedGeneration</code>
</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><img src="/assets/img/posts/generation1.png" alt=""></td>
      <td style="text-align: center"><img src="/assets/img/posts/generation2.png" alt=""></td>
    </tr>
  </tbody>
</table>

<p>如果你更改的 resource 間接改動到 QOS class 也是不行的</p>

<p><img src="/assets/img/posts/qos.png" alt=""></p>

<blockquote>
  <p>簡單來說，Quality of Service(QOS) Class 會根據 <code class="language-plaintext highlighter-rouge">requests</code>, <code class="language-plaintext highlighter-rouge">limits</code> 以及 container 的數量來決定<br>
所以說你更改 resource 可能會間接改動到 QOS class</p>
</blockquote>

<blockquote>
  <p>可以用以下指令開一台 cluster 來測試</p>
  <div class="language-shell highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td>
<td class="rouge-code"><pre><span class="nv">$ </span>k3d cluster create mycluster <span class="se">\</span>
    <span class="nt">--image</span> rancher/k3s:v1.33.4-k3s1 <span class="se">\</span>
    <span class="nt">--k3s-arg</span> <span class="s1">'--kube-apiserver-arg=feature-gates=PodObservedGenerationTracking=true@server:*'</span> <span class="se">\</span>
    <span class="nt">--k3s-arg</span> <span class="s1">'--kube-apiserver-arg=feature-gates=InPlacePodVerticalScaling=true@server:*'</span> <span class="se">\</span>
    <span class="nt">--k3s-arg</span> <span class="s1">'--kubelet-arg=feature-gates=InPlacePodVerticalScaling=true@agent:*'</span> <span class="se">\</span>
    <span class="nt">--k3s-arg</span> <span class="s1">'--kubelet-arg=feature-gates=PodObservedGenerationTracking=true@agent:*'</span>
</pre></td>
</tr></tbody></table></code></pre></div>  </div>
</blockquote>

<h3 id="event-driven-autoscaling">Event Driven Autoscaling</h3>
<p>利用 <a href="https://github.com/kedacore/keda">Kubernetes-based Event Driven Autoscaling</a> 可以實現 event based 的自動擴展<br>
比方說可以根據 message queue 內的資料量、API 請求數量或是 <a href="https://github.com/kubernetes-sigs/metrics-server">metrics server</a> 提供的資訊等等所謂 <a href="https://keda.sh/docs/2.17/scalers/">Scalers</a> 來自動擴展</p>

<p>KEDA 並不是用來取代 <a href="#horizontal-pod-autoscalerhpa">HPA</a> 或是 <a href="#vertical-pod-autoscalervpa">VPA</a>，而是用來補足他們的不足<br>
這個工具能夠提供多樣化的 scaler 讓你根據不同的資源進行調節<br>
所以 KEDA 是沒辦法自己獨立運行的</p>

<p>更甚至你可以利用 KEDA 做到 off-peak hour 的調整<br>
就是比如說，在晚上的時候因為大家都在睡覺，所以上網的人可能會比較少，然後你就可以把資源降低<br>
KEDA 的 <a href="https://keda.sh/docs/2.17/scalers/cron/">Cron Scaler</a> 就滿適合的</p>

<blockquote>
  <p>Scaler 其實有很多種，包含我有看到 Redis, Kafka, PostgreSQL 等等的<br>
你甚至可以自己客製化 scaler</p>
</blockquote>

<h1 id="different-deployment-strategies">Different Deployment Strategies</h1>
<p>現在的服務基本上講究一個 zero downtime，要給使用者不間斷的服務<br>
而為了達成這個目標，部署策略就需要經過設計</p>

<p>最簡單的部署方式就是停機維護<br>
而停機維護是相對不友善的選擇，卻也是對開發者最友善的模式<br>
龐大的資料升級，資料庫遷移等等的，停機維護可以將所有的風險降到最低<br>
雖然仍然有辦法達成 zero downtime，但這部分的操作會需要團隊更細心的安排與規劃</p>

<blockquote>
  <p>有關 migration 可以參考 <a href="../../database/database-migration">資料庫 - 新手做 Data Migration 資料遷移 | Shawn Hsu</a></p>
</blockquote>

<p>比較保險的方式會是擁有多台機器逐台更新，也就是要求你的服務具備一定 scaling 的能力<br>
因為至少在你更新 A 機器的時候，BCD 依然可以服務使用者<br>
多台機器的情況下事情就變得有趣了，你會有不同的策略比如說 <a href="#canary-deployment">Canary Deployment</a> 或者 <a href="#blue-green-deployment">Blue Green Deployment</a></p>

<h2 id="recreate-and-rolling-update">Recreate and Rolling Update</h2>
<p>停機維護最主要是指你的系統沒辦法兼容兩個不同版本同時運行<br>
因為他有可能使用的 database schema 不同，同時運行會造成資料毀損等問題<br>
次要則是一些比如說底層作業系統更新、網路設備更新抑或是硬體設備維修更新等等<br>
雖然通常這會比較偏向 <code class="language-plaintext highlighter-rouge">排程維護更新</code> 的範疇，但廣義上仍然是屬於 <code class="language-plaintext highlighter-rouge">Recreate</code>(因為服務對使用者不可用)</p>

<p>與 <code class="language-plaintext highlighter-rouge">Recreate</code> 會造成所謂的 downtime 不同，<code class="language-plaintext highlighter-rouge">Rolling Update</code> 則是會確保系統一直是可用的狀態<br>
我們提到，多台機器逐步更新是這類操作的關鍵，因為有不同機器繼續撐著運行，在使用者的角度看來，系統依然是可用的<br>
使用 <code class="language-plaintext highlighter-rouge">Rolling Update</code> 需要確保你的系統有做好 “向後相容” 或 “向前相容” 的設計<br>
這樣才能確保在更新過程中，系統依然可以正常運行</p>

<p>在 Kubernetes 中，你可以透過設定 <code class="language-plaintext highlighter-rouge">spec.strategy.type</code> 來決定使用哪種策略</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">Recreate</code>: 先砍再建</li>
  <li>
<code class="language-plaintext highlighter-rouge">RollingUpdate</code>: 邊建邊砍
    <ul>
      <li>你也可以控制新舊 Pod 的數量，目的在於確保在更新過程中，系統依然可以正常運行
        <ul>
          <li>
<code class="language-plaintext highlighter-rouge">spec.strategy.rollingUpdate.maxSurge</code> 表示最多可以 <strong>比原本多出多少 Pod</strong>(預設 25%, 至多 125% 的 Pod 會是可用的)</li>
          <li>
<code class="language-plaintext highlighter-rouge">spec.strategy.rollingUpdate.maxUnavailable</code> 表示最多可以有多少 Pod <strong>不可用</strong>(預設 25%, 至少 75% 的 Pod 會是可用的)</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>預設的策略會是 <code class="language-plaintext highlighter-rouge">RollingUpdate</code></p>
</blockquote>

<p>他執行起來會長這樣<br>
你可以很清楚的看出他的差別，Rolling Update 的過程中，系統依然是可用的<br>
而 Recreate 的過程中，系統是不可用的(全部都下去)</p>

<blockquote>
  <p>Recreate 即使下線的時間很短，仍然會造成影響，因此也視為有 downtime</p>
</blockquote>

<p><img src="/assets/img/posts/rolling.gif" alt=""></p>

<p><img src="/assets/img/posts/recreate.gif" alt=""></p>

<h2 id="canary-deployment">Canary Deployment</h2>
<p>基本上 Rolling Update 是相對常見的策略<br>
逐步的更新你的服務，使得其永遠可用</p>

<blockquote>
  <p>Rolling Update 的 use case，比方説我公司內部開發機的更新就是直接 rolling 上去，反正掛了也是內部不可用而已</p>
</blockquote>

<p>但這個可用其實是相對薄弱的<br>
你的服務是起來的，並不代表他有好好工作<br>
比方說，服務內部有一個 bug, 他並不會讓服務直接掛掉，但是會造成結果錯誤<br>
這種時候如果 Liveness 以及 Readiness 沒有設定好，就會造成 silent error<br>
這並不是我們樂見的</p>

<blockquote>
  <p>有關 Liveness 以及 Readiness 可以參考 <a href="../../kubernetes/kubernetes-self-healing">Kubernetes 從零開始 - Self Healing 是如何運作的 | Shawn Hsu</a></p>
</blockquote>

<p>我們當然不希望全部都上了之後才發現有問題<br>
最簡單的就是分流囉，有多套版本的服務，一部分的人用新的，一部分的用舊的<br>
<code class="language-plaintext highlighter-rouge">少部分的人先使用新版本，如果都沒有問題，逐步開放至全部使用者</code> 是 Canary Deployment 的精髓<br>
所以同一時間會有不同版本的服務在線上，透過 <strong>分流機制</strong> 將部分使用者導向新版本<br>
為了避免 silent error 這種事情，分流可以很好的限縮錯誤範圍，當發現新版本有問題，影響也會是最小的</p>

<p>同一時間多版本在線上服務，一個重點是要確保服務本身是 <strong>向後相容的</strong><br>
不然你的資料會損毀，而這是最不想發生的狀況<br>
預先執行資料遷移是個選擇，或者是用 <a href="#blue-green-deployment">Blue Green Deployment</a> 來達成</p>

<blockquote>
  <p>有關 data migration 可以參考 <a href="../../database/database-migration">資料庫 - 新手做 Data Migration 資料遷移 | Shawn Hsu</a></p>
</blockquote>

<h2 id="blue-green-deployment">Blue Green Deployment</h2>
<p>他跟 <a href="#canary-deployment">Canary Deployment</a> 類似都是使用多版本的部署策略</p>

<p>差別在於，<code class="language-plaintext highlighter-rouge">Blue Green</code> 是一瞬間切換的<br>
他 <strong><em>並不是逐步更新</em></strong>，而是將流量瞬間切換到新版本的系統上<br>
所以你其實沒辦法小規模測試</p>

<p>因為不想要有多個資料來源，所以 <code class="language-plaintext highlighter-rouge">Blue Green</code> 事實上是維護兩套完全獨立的系統<br>
一套舊系統(<code class="language-plaintext highlighter-rouge">Blue</code>)，一套新系統(<code class="language-plaintext highlighter-rouge">Green</code>)，兩者獨立運行<br>
等到你確定新版本沒問題之後，更改路由設定，將全部的流量都導入新版本</p>

<!-- TODO ingress post -->

<p>你可能會問，兩套系統運行，那資料要怎麼同步？<br>
最終的目的都是減少 downtime, 而 Blue Green 的舊系統會繼續服務<br>
為了新系統切換的時候資料是近新的，所以通常會用 <em>Kafka</em> 之類的進行資料同步</p>

<blockquote>
  <p>有關 Kafka 可以參考 <a href="../../database/database-message-queue">資料庫 - 從 Apache Kafka 認識 Message Queue | Shawn Hsu</a></p>
</blockquote>

<blockquote>
  <p>有關 data migration 可以參考 <a href="../../database/database-migration">資料庫 - 新手做 Data Migration 資料遷移 | Shawn Hsu</a></p>
</blockquote>

<h2 id="ab-testing">A/B Testing</h2>
<p>另外一種部署策略我覺得是比較特殊的<br>
他的目的不在於發布新的系統，而是為了測試方面的部署策略</p>

<p>A/B Testing 的目的，是 <em>藉由部署不同的系統版本，窺探使用者的反應</em><br>
當然，還是有新版本的系統被部署，只是要注意他的本質是 <strong>測試</strong><br>
比方說，有新版本的 UI，你想要知道使用者對於新版本的 UI 的反應如何<br>
所以可以將 Ingress 的流量分切，讓小部分的人體驗新功能，搭配個問卷調查之類的</p>
<ul>
  <li>8 成的人依舊是使用舊版本</li>
  <li>而 2 成的人是使用新版本</li>
</ul>

<p>當你測試完成之後，再把流量復原然後就可以根據測試結果決定後續</p>

<h2 id="shadow-deployment">Shadow Deployment</h2>
<p>Shadow 類似於 <a href="#a-b-testing">A/B Testing</a>，只是他不需要分流<br>
他也是用於測試，只不過是將 production 流量複製一份出來測試<br>
這樣的好處就是你可以很直接的觀察新版本的表現，而 <em>完全不會影響到舊版本</em><br>
response 則會全部被丟棄</p>

<h2 id="conclusion">Conclusion</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Strategy</th>
      <th style="text-align: right"><a href="#recreate-and-rolling-update">Recreate</a></th>
      <th style="text-align: right"><a href="#recreate-and-rolling-update">Rolling Update</a></th>
      <th style="text-align: right"><a href="#blue-green-deployment">Blue Green Deployment</a></th>
      <th style="text-align: right"><a href="#canary-deployment">Canary Deployment</a></th>
      <th style="text-align: right"><a href="#a-b-testing">A/B Testing</a></th>
      <th style="text-align: right"><a href="#shadow-deployment">Shadow Deployment</a></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Purpose</td>
      <td style="text-align: right">部署</td>
      <td style="text-align: right">部署</td>
      <td style="text-align: right">部署</td>
      <td style="text-align: right">部署</td>
      <td style="text-align: right">測試</td>
      <td style="text-align: right">測試</td>
    </tr>
    <tr>
      <td style="text-align: left">Downtime</td>
      <td style="text-align: right"><img class="emoji" title=":heavy_check_mark:" alt=":heavy_check_mark:" src="https://github.githubassets.com/images/icons/emoji/unicode/2714.png" height="20" width="20"></td>
      <td style="text-align: right"><img class="emoji" title=":x:" alt=":x:" src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png" height="20" width="20"></td>
      <td style="text-align: right"><img class="emoji" title=":x:" alt=":x:" src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png" height="20" width="20"></td>
      <td style="text-align: right"><img class="emoji" title=":x:" alt=":x:" src="https://github.githubassets.com/images/icons/emoji/unicode/274c.png" height="20" width="20"></td>
      <td style="text-align: right"> </td>
      <td style="text-align: right"> </td>
    </tr>
    <tr>
      <td style="text-align: left">Risk Level</td>
      <td style="text-align: right">High</td>
      <td style="text-align: right">Medium</td>
      <td style="text-align: right">Low</td>
      <td style="text-align: right">Low</td>
      <td style="text-align: right">Low</td>
      <td style="text-align: right">Low</td>
    </tr>
    <tr>
      <td style="text-align: left">Rollback Difficulty</td>
      <td style="text-align: right">High</td>
      <td style="text-align: right">Medium</td>
      <td style="text-align: right">Low</td>
      <td style="text-align: right">Low</td>
      <td style="text-align: right">Low</td>
      <td style="text-align: right">Low</td>
    </tr>
    <tr>
      <td style="text-align: left">Release Unit</td>
      <td style="text-align: right">完整服務</td>
      <td style="text-align: right">單台機器</td>
      <td style="text-align: right">兩個不同環境</td>
      <td style="text-align: right">部分流量</td>
      <td style="text-align: right">部分流量</td>
      <td style="text-align: right">複製流量</td>
    </tr>
  </tbody>
</table>

<h1 id="how-kubernetes-handle-deployment-strategy">How Kubernetes Handle Deployment Strategy</h1>
<p>上述我們提到的部署策略中，有一些是同時部署兩個版本然後透過分流的方式達成<br>
在 Kubernetes 中，如果不考慮其他的工具，基本上依靠 Service 就可以做到八成像了</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">frontend</span>
<span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
<span class="nn">...</span>
<span class="na">labels</span><span class="pi">:</span>
  <span class="na">app</span><span class="pi">:</span> <span class="s">guestbook</span>
  <span class="na">tier</span><span class="pi">:</span> <span class="s">frontend</span>
  <span class="na">track</span><span class="pi">:</span> <span class="s">stable</span>
<span class="nn">...</span>
<span class="na">image</span><span class="pi">:</span> <span class="s">gb-frontend:v3</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">frontend-canary</span>
<span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
<span class="nn">...</span>
<span class="na">labels</span><span class="pi">:</span>
  <span class="na">app</span><span class="pi">:</span> <span class="s">guestbook</span>
  <span class="na">tier</span><span class="pi">:</span> <span class="s">frontend</span>
  <span class="na">track</span><span class="pi">:</span> <span class="s">canary</span>
<span class="nn">...</span>
<span class="na">image</span><span class="pi">:</span> <span class="s">gb-frontend:v4</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>上述兩個不同的 Deployment 分別對應到新舊版本的應用程式(v3 以及 v4)<br>
然後在 label 的部分，你可以看到他有共享相同的 label(i.e. <code class="language-plaintext highlighter-rouge">frontend</code> 以及 <code class="language-plaintext highlighter-rouge">guestbook</code>)<br>
在 Service 的部分就可以使用這些相同的 label 選取<br>
就能夠達成基本的分流，以 replica 的數量來判斷就是 <code class="language-plaintext highlighter-rouge">3:1</code> 的流量</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="na">selector</span><span class="pi">:</span>
   <span class="na">app</span><span class="pi">:</span> <span class="s">guestbook</span>
   <span class="na">tier</span><span class="pi">:</span> <span class="s">frontend</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<h2 id="argo-rollouts">Argo Rollouts</h2>
<p>就如同我們上述討論的，Kubernetes 內建的 Rollout 功能雖然強大但是仍然有許多改進空間<br>
比如說</p>
<ol>
  <li>沒辦法控制 Rollout 的速度</li>
  <li>Liveness 以及 Readiness 沒辦法做更深度且全面的檢查</li>
  <li>沒辦法依靠外部 Metrics 衡量更新</li>
</ol>

<p>基於以上考量點，實務上在正式環境內部還是有太多的隱患存在<br>
所以 <a href="https://argoproj.github.io/rollouts/">Argo Rollouts</a> 正是為了解決以上痛點而誕生的</p>

<p>本質上也是透過 Kubernetes Controller 以及 <a href="#rollout-crd">CRD</a> 來實現的<br>
比如說 <a href="#rollout-crd">Rollout CRD</a> 就是 Deployment 的包裝，並且額外提供了一些功能<br>
前面提到 <a href="#blue-green-deployment">Blue Green Deployment</a> 以及 <a href="#canary-deployment">Canary Deployment</a> 都是有支援的，但是也只支援這兩個</p>

<blockquote>
  <p>有關 CRD 可以參考 <a href="../../kubernetes/kubernetes-crd">Kubernetes 從零開始 - client-go 實操 CRD | Shawn Hsu</a></p>
</blockquote>

<blockquote>
  <p>有關 Kubernetes Controller 可以參考 <a href="../../kubernetes/kubernetes-controller-concept">Kubernetes 從零開始 - Informer 架構以及 Controller Pattern | Shawn Hsu</a></p>
</blockquote>

<h3 id="architecture">Architecture</h3>
<p><img src="https://argoproj.github.io/argo-rollouts/architecture-assets/argo-rollout-architecture.png" alt=""></p>
<blockquote>
  <p>ref: <a href="https://argoproj.github.io/argo-rollouts/architecture/">Architecture</a></p>
</blockquote>

<p>基本上如果你熟悉 Kubernetes Controller 的運作方式，就不難理解<br>
本質上，Controller 會監聽 <code class="language-plaintext highlighter-rouge">Rollout CRD</code> 的任何變化，並根據其內容調整相對應的資源<br>
前面提到，雖然說他是包裝 Deployment，但是 Controller 並不會對原生 Deployment 有任何反應</p>

<blockquote>
  <p>有關 Kubernetes Controller 可以參考 <a href="../../kubernetes/kubernetes-controller-concept">Kubernetes 從零開始 - Informer 架構以及 Controller Pattern | Shawn Hsu</a></p>
</blockquote>

<p>也跟 Deployment 一樣，底層 Argo Rollouts 會使用 ReplicaSet 來管理 Pod<br>
為了能方便管理不同的版本，一些額外的 metadata 以及 labels 會被套用上去<br>
並且需要搭配 Service 進行分流(Controller 會指派 unique hash 確保選擇到正確的 ReplicaSet)，Service Mesh 或者 Ingress 的 solution 如 <a href="https://traefik.io/traefik/">Traefik</a>、<a href="https://kubernetes.github.io/ingress-nginx/">Nginx Ingress Controller</a> 或 <a href="https://istio.io/">Istio</a> 等等也可以搭配使用</p>

<p>另外你也可以將 Metrics 整合進來，檢查 Rollout 的狀態</p>

<h3 id="rollout-crd">Rollout CRD</h3>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
</pre></td>
<td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">argoproj.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Rollout</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">example-rollout-canary</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="c1"># Number of desired pods.</span>
  <span class="c1"># Defaults to 1.</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">analysis</span><span class="pi">:</span>
    <span class="c1"># limits the number of successful analysis runs and experiments to be stored in a history</span>
    <span class="c1"># Defaults to 5.</span>
    <span class="na">successfulRunHistoryLimit</span><span class="pi">:</span> <span class="m">10</span>
    <span class="c1"># limits the number of unsuccessful analysis runs and experiments to be stored in a history.</span>
    <span class="c1"># Stages for unsuccessful: "Error", "Failed", "Inconclusive"</span>
    <span class="c1"># Defaults to 5.</span>
    <span class="na">unsuccessfulRunHistoryLimit</span><span class="pi">:</span> <span class="m">10</span>

  <span class="c1"># Label selector for pods. Existing ReplicaSets whose pods are selected by</span>
  <span class="c1"># this will be the ones affected by this rollout. It must match the pod</span>
  <span class="c1"># template's labels.</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">guestbook</span>

  <span class="c1"># WorkloadRef holds a references to a workload that provides Pod template</span>
  <span class="c1"># (e.g. Deployment). If used, then do not use Rollout template property.</span>
  <span class="na">workloadRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">rollout-ref-deployment</span>
    <span class="c1"># Specifies if the workload (Deployment) is scaled down after migrating to Rollout.</span>
    <span class="c1"># The possible options are:</span>
    <span class="c1"># "never": the Deployment is not scaled down</span>
    <span class="c1"># "onsuccess": the Deployment is scaled down after the Rollout becomes healthy</span>
    <span class="c1"># "progressively": as the Rollout is scaled up the Deployment is scaled down</span>
    <span class="c1"># If the Rollout fails the Deployment will be scaled back up.</span>
    <span class="na">scaleDown</span><span class="pi">:</span> <span class="s">never|onsuccess|progressively</span>

  <span class="c1"># Template describes the pods that will be created. Same as deployment.</span>
  <span class="c1"># If used, then do not use Rollout workloadRef property.</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">guestbook</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">argoproj/rollouts-demo:blue</span>

  <span class="c1"># Minimum number of seconds for which a newly created pod should be ready</span>
  <span class="c1"># without any of its container crashing, for it to be considered available.</span>
  <span class="c1"># Defaults to 0 (pod will be considered available as soon as it is ready)</span>
  <span class="na">minReadySeconds</span><span class="pi">:</span> <span class="m">30</span>

  <span class="c1"># The number of old ReplicaSets to retain.</span>
  <span class="c1"># Defaults to 10</span>
  <span class="na">revisionHistoryLimit</span><span class="pi">:</span> <span class="m">3</span>

  <span class="c1"># Pause allows a user to manually pause a rollout at any time. A rollout</span>
  <span class="c1"># will not advance through its steps while it is manually paused, but HPA</span>
  <span class="c1"># auto-scaling will still occur. Typically not explicitly set the manifest,</span>
  <span class="c1"># but controlled via tools (e.g. kubectl argo rollouts pause). If true at</span>
  <span class="c1"># initial creation of Rollout, replicas are not scaled up automatically</span>
  <span class="c1"># from zero unless manually promoted.</span>
  <span class="na">paused</span><span class="pi">:</span> <span class="no">true</span>

  <span class="c1"># The maximum time in seconds in which a rollout must make progress during</span>
  <span class="c1"># an update, before it is considered to be failed. Argo Rollouts will</span>
  <span class="c1"># continue to process failed rollouts and a condition with a</span>
  <span class="c1"># ProgressDeadlineExceeded reason will be surfaced in the rollout status.</span>
  <span class="c1"># Note that progress will not be estimated during the time a rollout is</span>
  <span class="c1"># paused.</span>
  <span class="c1"># Defaults to 600s</span>
  <span class="na">progressDeadlineSeconds</span><span class="pi">:</span> <span class="m">600</span>

  <span class="c1"># Whether to abort the update when ProgressDeadlineSeconds is exceeded.</span>
  <span class="c1"># Optional and default is false.</span>
  <span class="na">progressDeadlineAbort</span><span class="pi">:</span> <span class="no">false</span>

  <span class="c1"># UTC timestamp in which a Rollout should sequentially restart all of</span>
  <span class="c1"># its pods. Used by the `kubectl argo rollouts restart ROLLOUT` command.</span>
  <span class="c1"># The controller will ensure all pods have a creationTimestamp greater</span>
  <span class="c1"># than or equal to this value.</span>
  <span class="na">restartAt</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2020-03-30T21:19:35Z'</span>

  <span class="c1"># The rollback window provides a way to fast track deployments to</span>
  <span class="c1"># previously deployed versions.</span>
  <span class="c1"># Optional, and by default is not set.</span>
  <span class="na">rollbackWindow</span><span class="pi">:</span>
    <span class="na">revisions</span><span class="pi">:</span> <span class="m">3</span>

  <span class="na">strategy</span><span class="pi">:</span>
    <span class="c1"># Blue-green update strategy</span>
    <span class="na">blueGreen</span><span class="pi">:</span>
      <span class="c1"># Reference to service that the rollout modifies as the active service.</span>
      <span class="c1"># Required.</span>
      <span class="na">activeService</span><span class="pi">:</span> <span class="s">active-service</span>

      <span class="c1"># Pre-promotion analysis run which performs analysis before the service</span>
      <span class="c1"># cutover. +optional</span>
      <span class="na">prePromotionAnalysis</span><span class="pi">:</span>
        <span class="na">templates</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">templateName</span><span class="pi">:</span> <span class="s">success-rate</span>
        <span class="na">args</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">service-name</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">guestbook-svc.default.svc.cluster.local</span>

      <span class="c1"># Post-promotion analysis run which performs analysis after the service</span>
      <span class="c1"># cutover. +optional</span>
      <span class="na">postPromotionAnalysis</span><span class="pi">:</span>
        <span class="na">templates</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">templateName</span><span class="pi">:</span> <span class="s">success-rate</span>
        <span class="na">args</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">service-name</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">guestbook-svc.default.svc.cluster.local</span>

      <span class="c1"># Name of the service that the rollout modifies as the preview service.</span>
      <span class="c1"># +optional</span>
      <span class="na">previewService</span><span class="pi">:</span> <span class="s">preview-service</span>

      <span class="c1"># The number of replicas to run under the preview service before the</span>
      <span class="c1"># switchover. Once the rollout is resumed the new ReplicaSet will be fully</span>
      <span class="c1"># scaled up before the switch occurs +optional</span>
      <span class="na">previewReplicaCount</span><span class="pi">:</span> <span class="m">1</span>

      <span class="c1"># Indicates if the rollout should automatically promote the new ReplicaSet</span>
      <span class="c1"># to the active service or enter a paused state. If not specified, the</span>
      <span class="c1"># default value is true. +optional</span>
      <span class="na">autoPromotionEnabled</span><span class="pi">:</span> <span class="no">false</span>

      <span class="c1"># Automatically promotes the current ReplicaSet to active after the</span>
      <span class="c1"># specified pause delay in seconds after the ReplicaSet becomes ready.</span>
      <span class="c1"># If omitted, the Rollout enters and remains in a paused state until</span>
      <span class="c1"># manually resumed by resetting spec.Paused to false. +optional</span>
      <span class="na">autoPromotionSeconds</span><span class="pi">:</span> <span class="m">30</span>

      <span class="c1"># Adds a delay before scaling down the previous ReplicaSet. If omitted,</span>
      <span class="c1"># the Rollout waits 30 seconds before scaling down the previous ReplicaSet.</span>
      <span class="c1"># A minimum of 30 seconds is recommended to ensure IP table propagation</span>
      <span class="c1"># across the nodes in a cluster.</span>
      <span class="na">scaleDownDelaySeconds</span><span class="pi">:</span> <span class="m">30</span>

      <span class="c1"># Limits the number of old RS that can run at once before getting scaled</span>
      <span class="c1"># down. Defaults to nil</span>
      <span class="na">scaleDownDelayRevisionLimit</span><span class="pi">:</span> <span class="m">2</span>

      <span class="c1"># Add a delay in second before scaling down the preview replicaset</span>
      <span class="c1"># if update is aborted. 0 means not to scale down. Default is 30 second</span>
      <span class="na">abortScaleDownDelaySeconds</span><span class="pi">:</span> <span class="m">30</span>

      <span class="c1"># Anti Affinity configuration between desired and previous ReplicaSet.</span>
      <span class="c1"># Only one must be specified</span>
      <span class="na">antiAffinity</span><span class="pi">:</span>
        <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span> <span class="pi">{}</span>
        <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
          <span class="na">weight</span><span class="pi">:</span> <span class="m">1</span> <span class="c1"># Between 1 - 100</span>

      <span class="c1"># activeMetadata will be merged and updated in-place into the ReplicaSet's spec.template.metadata</span>
      <span class="c1"># of the active pods. +optional</span>
      <span class="na">activeMetadata</span><span class="pi">:</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">role</span><span class="pi">:</span> <span class="s">active</span>

      <span class="c1"># Metadata which will be attached to the preview pods only during their preview phase.</span>
      <span class="c1"># +optional</span>
      <span class="na">previewMetadata</span><span class="pi">:</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">role</span><span class="pi">:</span> <span class="s">preview</span>

    <span class="c1"># Canary update strategy</span>
    <span class="na">canary</span><span class="pi">:</span>
      <span class="c1"># Reference to a service which the controller will update to select</span>
      <span class="c1"># canary pods. Required for traffic routing.</span>
      <span class="na">canaryService</span><span class="pi">:</span> <span class="s">canary-service</span>

      <span class="c1"># Reference to a service which the controller will update to select</span>
      <span class="c1"># stable pods. Required for traffic routing.</span>
      <span class="na">stableService</span><span class="pi">:</span> <span class="s">stable-service</span>

      <span class="c1"># Metadata which will be attached to the canary pods. This metadata will</span>
      <span class="c1"># only exist during an update, since there are no canary pods in a fully</span>
      <span class="c1"># promoted rollout.</span>
      <span class="na">canaryMetadata</span><span class="pi">:</span>
        <span class="na">annotations</span><span class="pi">:</span>
          <span class="na">role</span><span class="pi">:</span> <span class="s">canary</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">role</span><span class="pi">:</span> <span class="s">canary</span>

      <span class="c1"># metadata which will be attached to the stable pods</span>
      <span class="na">stableMetadata</span><span class="pi">:</span>
        <span class="na">annotations</span><span class="pi">:</span>
          <span class="na">role</span><span class="pi">:</span> <span class="s">stable</span>
        <span class="na">labels</span><span class="pi">:</span>
          <span class="na">role</span><span class="pi">:</span> <span class="s">stable</span>

      <span class="c1"># The maximum number of pods that can be unavailable during the update.</span>
      <span class="c1"># Value can be an absolute number (ex: 5) or a percentage of total pods</span>
      <span class="c1"># at the start of update (ex: 10%). Absolute number is calculated from</span>
      <span class="c1"># percentage by rounding down. This can not be 0 if  MaxSurge is 0. By</span>
      <span class="c1"># default, a fixed value of 1 is used. Example: when this is set to 30%,</span>
      <span class="c1"># the old RC can be scaled down by 30% immediately when the rolling</span>
      <span class="c1"># update starts. Once new pods are ready, old RC can be scaled down</span>
      <span class="c1"># further, followed by scaling up the new RC, ensuring that at least 70%</span>
      <span class="c1"># of original number of pods are available at all times during the</span>
      <span class="c1"># update. +optional</span>
      <span class="na">maxUnavailable</span><span class="pi">:</span> <span class="m">1</span>

      <span class="c1"># The maximum number of pods that can be scheduled above the original</span>
      <span class="c1"># number of pods. Value can be an absolute number (ex: 5) or a</span>
      <span class="c1"># percentage of total pods at the start of the update (ex: 10%). This</span>
      <span class="c1"># can not be 0 if MaxUnavailable is 0. Absolute number is calculated</span>
      <span class="c1"># from percentage by rounding up. By default, a value of 1 is used.</span>
      <span class="c1"># Example: when this is set to 30%, the new RC can be scaled up by 30%</span>
      <span class="c1"># immediately when the rolling update starts. Once old pods have been</span>
      <span class="c1"># killed, new RC can be scaled up further, ensuring that total number</span>
      <span class="c1"># of pods running at any time during the update is at most 130% of</span>
      <span class="c1"># original pods. +optional</span>
      <span class="na">maxSurge</span><span class="pi">:</span> <span class="s1">'</span><span class="s">20%'</span>

      <span class="c1"># Adds a delay before scaling down the previous ReplicaSet when the</span>
      <span class="c1"># canary strategy is used with traffic routing (default 30 seconds).</span>
      <span class="c1"># A delay in scaling down the previous ReplicaSet is needed after</span>
      <span class="c1"># switching the stable service selector to point to the new ReplicaSet,</span>
      <span class="c1"># in order to give time for traffic providers to re-target the new pods.</span>
      <span class="c1"># This value is ignored with basic, replica-weighted canary without</span>
      <span class="c1"># traffic routing.</span>
      <span class="na">scaleDownDelaySeconds</span><span class="pi">:</span> <span class="m">30</span>

      <span class="c1"># The minimum number of pods that will be requested for each ReplicaSet</span>
      <span class="c1"># when using traffic routed canary. This is to ensure high availability</span>
      <span class="c1"># of each ReplicaSet. Defaults to 1. +optional</span>
      <span class="na">minPodsPerReplicaSet</span><span class="pi">:</span> <span class="m">2</span>

      <span class="c1"># Limits the number of old RS that can run at one time before getting</span>
      <span class="c1"># scaled down. Defaults to nil</span>
      <span class="na">scaleDownDelayRevisionLimit</span><span class="pi">:</span> <span class="m">2</span>

      <span class="c1"># Background analysis to run during a rollout update. Skipped upon</span>
      <span class="c1"># initial deploy of a rollout. +optional</span>
      <span class="na">analysis</span><span class="pi">:</span>
        <span class="na">templates</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">templateName</span><span class="pi">:</span> <span class="s">success-rate</span>
        <span class="na">args</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">service-name</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">guestbook-svc.default.svc.cluster.local</span>

          <span class="c1"># valueFrom.podTemplateHashValue is a convenience to supply the</span>
          <span class="c1"># rollouts-pod-template-hash value of either the Stable ReplicaSet</span>
          <span class="c1"># or the Latest ReplicaSet</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">stable-hash</span>
            <span class="na">valueFrom</span><span class="pi">:</span>
              <span class="na">podTemplateHashValue</span><span class="pi">:</span> <span class="s">Stable</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">latest-hash</span>
            <span class="na">valueFrom</span><span class="pi">:</span>
              <span class="na">podTemplateHashValue</span><span class="pi">:</span> <span class="s">Latest</span>

          <span class="c1"># valueFrom.fieldRef allows metadata about the rollout to be</span>
          <span class="c1"># supplied as arguments to analysis.</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">region</span>
            <span class="na">valueFrom</span><span class="pi">:</span>
              <span class="na">fieldRef</span><span class="pi">:</span>
                <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">metadata.labels['region']</span>

      <span class="c1"># Steps define sequence of steps to take during an update of the</span>
      <span class="c1"># canary. Skipped upon initial deploy of a rollout. +optional</span>
      <span class="na">steps</span><span class="pi">:</span>
        <span class="c1"># Sets the ratio of canary ReplicaSet to 20%</span>
        <span class="pi">-</span> <span class="na">setWeight</span><span class="pi">:</span> <span class="m">20</span>

        <span class="c1"># Pauses the rollout for an hour. Supported units: s, m, h</span>
        <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span>
            <span class="na">duration</span><span class="pi">:</span> <span class="s">1h</span>

        <span class="c1"># Pauses indefinitely until manually resumed</span>
        <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span> <span class="pi">{}</span>

        <span class="c1"># set canary scale to an explicit count without changing traffic weight</span>
        <span class="c1"># (supported only with trafficRouting)</span>
        <span class="pi">-</span> <span class="na">setCanaryScale</span><span class="pi">:</span>
            <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>

        <span class="c1"># set canary scale to spec.Replica * (setweight / maxTrafficWeight) without changing traffic weight</span>
        <span class="c1"># if maxTrafficWeight unspecified, it defaults to 100</span>
        <span class="c1"># (supported only with trafficRouting)</span>
        <span class="pi">-</span> <span class="na">setCanaryScale</span><span class="pi">:</span>
            <span class="na">weight</span><span class="pi">:</span> <span class="m">25</span>

        <span class="c1"># set canary scale to match the canary traffic weight (default behavior)</span>
        <span class="pi">-</span> <span class="na">setCanaryScale</span><span class="pi">:</span>
            <span class="na">matchTrafficWeight</span><span class="pi">:</span> <span class="no">true</span>

        <span class="c1"># The percentage or number of replica pods within the applications ReplicaSet</span>
        <span class="c1"># that are available and ready when a rollout is ready to be promoted. Useful if your application</span>
        <span class="c1"># configured an HPA to help handle different loads of traffic, but you still want quick promotions.</span>
        <span class="c1"># Defaults to 100% if replicaProgressThreshold is not specified.</span>
        <span class="c1"># The 'type' field should be either "Percent" | "Pod"</span>
        <span class="c1"># Current percentage that is checked against the input percent value is calculated by the following:</span>
        <span class="c1"># CURRENT PERCENTAGE = available replicas / desired replicas for the current step</span>
        <span class="c1"># +optional</span>
        <span class="pi">-</span> <span class="na">replicaProgressThreshold</span><span class="pi">:</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">Percent</span>
            <span class="na">value</span><span class="pi">:</span> <span class="m">90</span>


        <span class="c1"># executes the configured plugin by name with the provided configuration</span>
        <span class="pi">-</span> <span class="na">plugin</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">example</span>
            <span class="na">config</span><span class="pi">:</span>
              <span class="na">key</span><span class="pi">:</span> <span class="s">value</span>

        <span class="c1"># Sets header based route with specified header values</span>
        <span class="c1"># Setting header based route will send all traffic to the canary for the requests</span>
        <span class="c1"># with a specified header, in this case request header "version":"2"</span>
        <span class="c1"># (supported only with trafficRouting, for Istio only at the moment)</span>
        <span class="pi">-</span> <span class="na">setHeaderRoute</span><span class="pi">:</span>
            <span class="c1"># Name of the route that will be created by argo rollouts this must also be configured</span>
            <span class="c1"># in spec.strategy.canary.trafficRouting.managedRoutes</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">header-route-1'</span>
            <span class="c1"># The matching rules for the header route, if this is missing it acts as a removal of the route.</span>
            <span class="na">match</span><span class="pi">:</span>
              <span class="c1"># headerName The name of the header to apply the match rules to.</span>
              <span class="pi">-</span> <span class="na">headerName</span><span class="pi">:</span> <span class="s1">'</span><span class="s">version'</span>
                <span class="c1"># headerValue must contain exactly one field of exact, regex, or prefix. Not all traffic routers support</span>
                <span class="c1"># all types</span>
                <span class="na">headerValue</span><span class="pi">:</span>
                  <span class="c1"># Exact will only match if the header value is exactly the same</span>
                  <span class="na">exact</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
                  <span class="c1"># Will match the rule if the regular expression matches</span>
                  <span class="na">regex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.0.(.*)'</span>
                  <span class="c1"># prefix will be a prefix match of the header value</span>
                  <span class="na">prefix</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.0'</span>

          <span class="c1"># Sets up a mirror/shadow based route with the specified match rules</span>
          <span class="c1"># The traffic will be mirrored at the configured percentage to the canary service</span>
          <span class="c1"># during the rollout</span>
          <span class="c1"># (supported only with trafficRouting, for Istio only at the moment)</span>
        <span class="pi">-</span> <span class="na">setMirrorRoute</span><span class="pi">:</span>
            <span class="c1"># Name of the route that will be created by argo rollouts this must also be configured</span>
            <span class="c1"># in spec.strategy.canary.trafficRouting.managedRoutes</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">header-route-1'</span>
            <span class="c1"># The percentage of the matched traffic to mirror to the canary</span>
            <span class="na">percentage</span><span class="pi">:</span> <span class="m">100</span>
            <span class="c1"># The matching rules for the header route, if this is missing it acts as a removal of the route.</span>
            <span class="c1"># All conditions inside a single match block have AND semantics, while the list of match blocks have OR semantics.</span>
            <span class="c1"># Each type within a match (method, path, headers) must have one and only one match type (exact, regex, prefix)</span>
            <span class="c1"># Not all match types (exact, regex, prefix) will be supported by all traffic routers.</span>
            <span class="na">match</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">method</span><span class="pi">:</span> <span class="c1"># What HTTP method to match</span>
                  <span class="na">exact</span><span class="pi">:</span> <span class="s1">'</span><span class="s">GET'</span>
                  <span class="na">regex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">P.*'</span>
                  <span class="na">prefix</span><span class="pi">:</span> <span class="s1">'</span><span class="s">POST'</span>
                <span class="na">path</span><span class="pi">:</span> <span class="c1"># What HTTP url paths to match.</span>
                  <span class="na">exact</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/test'</span>
                  <span class="na">regex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/test/.*'</span>
                  <span class="na">prefix</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/'</span>
                <span class="na">headers</span><span class="pi">:</span>
                  <span class="na">agent-1b</span><span class="pi">:</span> <span class="c1"># What HTTP header name to use in the match.</span>
                    <span class="na">exact</span><span class="pi">:</span> <span class="s1">'</span><span class="s">firefox'</span>
                    <span class="na">regex</span><span class="pi">:</span> <span class="s1">'</span><span class="s">firefox2(.*)'</span>
                    <span class="na">prefix</span><span class="pi">:</span> <span class="s1">'</span><span class="s">firefox'</span>

        <span class="c1"># an inline analysis step</span>
        <span class="pi">-</span> <span class="na">analysis</span><span class="pi">:</span>
            <span class="na">templates</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">templateName</span><span class="pi">:</span> <span class="s">success-rate</span>

        <span class="c1"># an inline experiment step</span>
        <span class="pi">-</span> <span class="na">experiment</span><span class="pi">:</span>
            <span class="na">duration</span><span class="pi">:</span> <span class="s">1h</span>
            <span class="na">templates</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">baseline</span>
                <span class="na">specRef</span><span class="pi">:</span> <span class="s">stable</span>
                <span class="c1"># optional, creates a service for the experiment if set</span>
                <span class="na">service</span><span class="pi">:</span>
                  <span class="c1"># optional, service: {} is also acceptable if name is not included</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">test-service</span>
              <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">canary</span>
                <span class="na">specRef</span><span class="pi">:</span> <span class="s">canary</span>
                <span class="c1"># optional, set the weight of traffic routed to this version</span>
                <span class="na">weight</span><span class="pi">:</span> <span class="m">10</span>
            <span class="na">analyses</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mann-whitney</span>
                <span class="na">templateName</span><span class="pi">:</span> <span class="s">mann-whitney</span>
                <span class="c1"># Metadata which will be attached to the AnalysisRun.</span>
                <span class="na">analysisRunMetadata</span><span class="pi">:</span>
                  <span class="na">labels</span><span class="pi">:</span>
                    <span class="na">app.service.io/analysisType</span><span class="pi">:</span> <span class="s">smoke-test</span>
                  <span class="na">annotations</span><span class="pi">:</span>
                    <span class="na">link.argocd.argoproj.io/external-link</span><span class="pi">:</span> <span class="s">http://my-loggin-platform.com/pre-generated-link</span>

      <span class="c1"># Anti-affinity configuration between desired and previous ReplicaSet.</span>
      <span class="c1"># Only one must be specified.</span>
      <span class="na">antiAffinity</span><span class="pi">:</span>
        <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span> <span class="pi">{}</span>
        <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
          <span class="na">weight</span><span class="pi">:</span> <span class="m">1</span> <span class="c1"># Between 1 - 100</span>

      <span class="c1"># Traffic routing specifies the ingress controller or service mesh</span>
      <span class="c1"># configuration to achieve advanced traffic splitting. If omitted,</span>
      <span class="c1"># will achieve traffic split via a weighted replica counts between</span>
      <span class="c1"># the canary and stable ReplicaSet.</span>
      <span class="na">trafficRouting</span><span class="pi">:</span>
        <span class="c1"># Supports nginx and plugins only: This lets you control the denominator or total weight of traffic.</span>
        <span class="c1"># The total weight of traffic. If unspecified, it defaults to 100</span>
        <span class="na">maxTrafficWeight</span><span class="pi">:</span> <span class="m">1000</span>
        <span class="c1"># This is a list of routes that Argo Rollouts has the rights to manage it is currently only required for</span>
        <span class="c1"># setMirrorRoute and setHeaderRoute. The order of managedRoutes array also sets the precedence of the route</span>
        <span class="c1"># in the traffic router. Argo Rollouts will place these routes in the order specified above any routes already</span>
        <span class="c1"># defined in the used traffic router if something exists. The names here must match the names from the</span>
        <span class="c1"># setHeaderRoute and setMirrorRoute steps.</span>
        <span class="na">managedRoutes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">set-header</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mirror-route</span>
        <span class="c1"># Istio traffic routing configuration</span>
        <span class="na">istio</span><span class="pi">:</span>
          <span class="c1"># Either virtualService or virtualServices can be configured.</span>
          <span class="na">virtualService</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">rollout-vsvc</span> <span class="c1"># required</span>
            <span class="na">routes</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">primary</span> <span class="c1"># optional if there is a single route in VirtualService, required otherwise</span>
          <span class="na">virtualServices</span><span class="pi">:</span>
            <span class="c1"># One or more virtualServices can be configured</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">rollouts-vsvc1</span> <span class="c1"># required</span>
              <span class="na">routes</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s">primary</span> <span class="c1"># optional if there is a single route in VirtualService, required otherwise</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">rollouts-vsvc2</span> <span class="c1"># required</span>
              <span class="na">routes</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s">secondary</span> <span class="c1"># optional if there is a single route in VirtualService, required otherwise</span>

        <span class="c1"># NGINX Ingress Controller routing configuration</span>
        <span class="na">nginx</span><span class="pi">:</span>
          <span class="c1"># Either stableIngress or stableIngresses must be configured, but not both.</span>
          <span class="na">stableIngress</span><span class="pi">:</span> <span class="s">primary-ingress</span>
          <span class="na">stableIngresses</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">primary-ingress</span>
            <span class="pi">-</span> <span class="s">secondary-ingress</span>
            <span class="pi">-</span> <span class="s">tertiary-ingress</span>
          <span class="na">annotationPrefix</span><span class="pi">:</span> <span class="s">customingress.nginx.ingress.kubernetes.io</span> <span class="c1"># optional</span>
          <span class="na">additionalIngressAnnotations</span><span class="pi">:</span> <span class="c1"># optional</span>
            <span class="na">canary-by-header</span><span class="pi">:</span> <span class="s">X-Canary</span>
            <span class="na">canary-by-header-value</span><span class="pi">:</span> <span class="s">iwantsit</span>
          <span class="na">canaryIngressAnnotations</span><span class="pi">:</span> <span class="c1"># optional</span>
            <span class="na">my-custom-annotation.mygroup.com/key</span><span class="pi">:</span> <span class="s">value</span>

        <span class="c1"># ALB Ingress Controller routing configuration</span>
        <span class="na">alb</span><span class="pi">:</span>
          <span class="na">ingress</span><span class="pi">:</span> <span class="s">ingress</span> <span class="c1"># required</span>
          <span class="na">servicePort</span><span class="pi">:</span> <span class="m">443</span> <span class="c1"># required</span>
          <span class="na">annotationPrefix</span><span class="pi">:</span> <span class="s">custom.alb.ingress.kubernetes.io</span> <span class="c1"># optional</span>

        <span class="c1"># Service Mesh Interface routing configuration</span>
        <span class="na">smi</span><span class="pi">:</span>
          <span class="na">rootService</span><span class="pi">:</span> <span class="s">root-svc</span> <span class="c1"># optional</span>
          <span class="na">trafficSplitName</span><span class="pi">:</span> <span class="s">rollout-example-traffic-split</span> <span class="c1"># optional</span>

      <span class="c1"># Add a delay in second before scaling down the canary pods when update</span>
      <span class="c1"># is aborted for canary strategy with traffic routing (not applicable for basic canary).</span>
      <span class="c1"># 0 means canary pods are not scaled down. Default is 30 seconds.</span>
      <span class="na">abortScaleDownDelaySeconds</span><span class="pi">:</span> <span class="m">30</span>

      <span class="c1"># Automatically reduce the number of stable pods as the number of canary pods increases</span>
      <span class="c1"># Only available when traffic routing is used. Default value is false meaning that as more canary pods</span>
      <span class="c1"># are created the number of stable pods stays the same. </span>
      <span class="na">dynamicStableScale</span><span class="pi">:</span> <span class="no">false</span>

<span class="na">status</span><span class="pi">:</span>
  <span class="na">pauseConditions</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">reason</span><span class="pi">:</span> <span class="s">StepPause</span>
      <span class="na">startTime</span><span class="pi">:</span> <span class="s">2019-10-00T1234</span>
    <span class="pi">-</span> <span class="na">reason</span><span class="pi">:</span> <span class="s">BlueGreenPause</span>
      <span class="na">startTime</span><span class="pi">:</span> <span class="s">2019-10-00T1234</span>
    <span class="pi">-</span> <span class="na">reason</span><span class="pi">:</span> <span class="s">AnalysisRunInconclusive</span>
      <span class="na">startTime</span><span class="pi">:</span> <span class="s">2019-10-00T1234</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<h4 id="blue-green-and-canary-deployment">Blue Green and Canary Deployment</h4>
<p>一切都始於使用者發出指令(i.e. 更新 Rollout CRD)，要求進行上版</p>

<p>針對 <a href="#blue-green-deployment">Blue Green Deployment</a><br>
<code class="language-plaintext highlighter-rouge">activeService</code> 以及 <code class="language-plaintext highlighter-rouge">previewService</code> 會是這次更新過程中的主要角色</p>

<p>一開始</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">activeService</code> 會指向 <em>revision 1 RS</em>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">previewService</code> 會指向 <em>revision 1 RS</em>
</li>
</ul>

<p>然後開始進行更新，<em>revision 2 RS</em> 建立</p>
<ul>
  <li>
<code class="language-plaintext highlighter-rouge">activeService</code> 會指向 <em>revision 1 RS</em>
</li>
  <li>
<code class="language-plaintext highlighter-rouge">previewService</code> 會指向 <em>revision 2 RS</em>
</li>
</ul>

<blockquote>
  <p>在 Blue Green 中，previewService 是類似於 funnel traffic(漏斗流量)</p>
</blockquote>

<p>當 <em>revision 2 RS</em> 已經準備好了<br>
就會開始執行 <code class="language-plaintext highlighter-rouge">prePromotionAnalysis</code> 執行升級檢查<br>
在正式 “promotion” 之前，你可以讓他先暫停一下(e.g. <code class="language-plaintext highlighter-rouge">autoPromotionEnabled</code> 以及 <code class="language-plaintext highlighter-rouge">autoPromotionSeconds</code>)<br>
進到 promotion 階段就是將 <code class="language-plaintext highlighter-rouge">activeService</code> 指向 <em>revision 2 RS</em><br>
最後就剩下 <code class="language-plaintext highlighter-rouge">postPromotionAnalysis</code> 再次執行升級檢查</p>

<p>而 <a href="#canary-deployment">Canary Deployment</a> 比較不一樣<br>
因為說實在的，他並沒有一個統一的做法<br>
所以 Argo Rollouts 針對 Canary 反而是讓你自定義他該怎麼做</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
<td class="rouge-code"><pre><span class="na">strategy</span><span class="pi">:</span>
  <span class="na">canary</span><span class="pi">:</span>
    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">setWeight</span><span class="pi">:</span> <span class="m">20</span>
    <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="pi">-</span> <span class="na">setWeight</span><span class="pi">:</span> <span class="m">40</span>
    <span class="pi">-</span> <span class="na">setCanaryScale</span><span class="pi">:</span>
      <span class="na">replicas</span><span class="pi">:</span> <span class="m">3</span>
    <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">duration</span><span class="pi">:</span> <span class="nv">1m</span> <span class="pi">}</span>
    <span class="pi">-</span> <span class="na">setWeight</span><span class="pi">:</span> <span class="m">60</span>
    <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">duration</span><span class="pi">:</span> <span class="nv">1h</span> <span class="pi">}</span>
    <span class="pi">-</span> <span class="na">setWeight</span><span class="pi">:</span> <span class="m">80</span>
    <span class="pi">-</span> <span class="na">pause</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">duration</span><span class="pi">:</span> <span class="nv">30m</span> <span class="pi">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>如果沒有指定 steps，就會 fallback 到 Rolling update</p>
</blockquote>

<p>透過一系列的 <strong>steps</strong> 來控制 canary 該怎麼執行<br>
所以上述可以這樣理解</p>
<ol>
  <li>設定 canary 吃 20% 的流量</li>
  <li>等待直到手動恢復</li>
  <li>設定 canary 吃 40% 的流量</li>
  <li>調整 canary replicas 的數量到 3(他並不會影響流量佔比)</li>
  <li>… 以此類推</li>
</ol>

<h4 id="hpa-and-vpa">HPA and VPA</h4>
<p><code class="language-plaintext highlighter-rouge">Rollout</code> CRD 都可以跟現有的 <a href="#horizontal-pod-autoscalerhpa">HorizontalPodAutoscaler</a> 以及 <a href="#vertical-pod-autoscalervpa">VerticalPodAutoscaler</a> 相容</p>

<p>主要的原因在於 Argo Rollouts v0.3.0 有揭露 <code class="language-plaintext highlighter-rouge">/scale</code> 這個 subresource(跟原本的 Kubernetes Deployment 相同)<br>
也因為如此，HPA 可以透過 <code class="language-plaintext highlighter-rouge">/scale</code> 讀取 current replicas(從 scale subresource 取得)並與 <code class="language-plaintext highlighter-rouge">status.replicas</code> 比較來決定要如何調整</p>

<p>以前是 <code class="language-plaintext highlighter-rouge">HPA ➡️ replica set</code><br>
現在是 <code class="language-plaintext highlighter-rouge">HPA ➡️ Rollout ➡️ replica set</code></p>

<p>有了 Rollout 這層包裝，replica set 的操作就會落到 Rollout Controller 的身上</p>

<blockquote>
  <p>決定數量依然是 HPA 的責任，Argo Rollouts 則負責實際的調整</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
<td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">autoscaling/v2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">HorizontalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">demo-hpa</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">demo</span>
<span class="na">spec</span><span class="pi">:</span>      <span class="c1"># The min and max number of pods the HPA can scale</span>
  <span class="na">minReplicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">maxReplicas</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">scaleTargetRef</span><span class="pi">:</span>       <span class="c1"># The HPA targets the Rollout object for scaling.</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s">argoproj.io/v1alpha1</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Rollout</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">rollout-hpa-example</span>
<span class="nn">...</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>VPA 也是可以照 HPA 的寫法，只不過官方文件並未說明是否也是因為 <code class="language-plaintext highlighter-rouge">/scale</code> subresource 的關係</p>
</blockquote>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
<td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">autoscaling.k8s.io/v1beta2"</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VerticalPodAutoscaler</span>  
<span class="na">metadata</span><span class="pi">:</span>  
  <span class="na">name</span><span class="pi">:</span> <span class="s">vpa-rollout-example</span>  
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">test-vpa</span>  
<span class="na">spec</span><span class="pi">:</span>  
  <span class="na">targetRef</span><span class="pi">:</span>  
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">argoproj.io/v1alpha1"</span>  
    <span class="na">kind</span><span class="pi">:</span> <span class="s">Rollout</span>  
    <span class="na">name</span><span class="pi">:</span> <span class="s">vpa-demo-rollout</span>  
  <span class="na">updatePolicy</span><span class="pi">:</span>  
    <span class="na">updateMode</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Auto"</span>
<span class="nn">...</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<h1 id="references">References</h1>
<ul>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/autoscaling/">Autoscaling Workloads</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/management/#canary-deployments">Managing Workloads</a></li>
  <li><a href="https://jefflin1982.medium.com/software-%E8%BB%9F%E9%AB%94%E7%89%88%E6%9C%ACcanary%E6%98%AF%E4%BB%80%E9%BA%BC%E6%84%8F%E6%80%9D-470b645829cd">Software — 軟體版本Canary是什麼意思?</a></li>
  <li><a href="https://ithelp.ithome.com.tw/m/articles/10292369">Day08 - 使用 Kubernetes 實現藍綠部屬 (Blue/Green Deployment)</a></li>
  <li><a href="https://ithelp.ithome.com.tw/articles/10289913">從異世界歸來的第十三天 - Kubernetes Deployment Strategies - Rolling Update &amp; Recreate (二)</a></li>
  <li><a href="https://ithelp.ithome.com.tw/articles/10290317">從異世界歸來的第十四天 - Kubernetes Deployment Strategies - Blue/Green Deployment 藍綠部署 (三)</a></li>
  <li><a href="https://ithelp.ithome.com.tw/articles/10290852">從異世界歸來的第十五天 - Kubernetes Deployment Strategies - Canary Deployment 金絲雀部署 (四)</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/resize-container-resources/">Resize CPU and Memory Resources assigned to Containers</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">Horizontal Pod Autoscaling</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/cluster-administration/node-autoscaling/">Node Autoscaling</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/">Configure Quality of Service for Pods</a></li>
  <li><a href="https://keda.sh/docs/2.17/concepts/">KEDA Concepts</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">HorizontalPodAutoscaler Walkthrough</a></li>
  <li><a href="https://medium.com/@muppedaanvesh/rolling-update-recreate-deployment-strategies-in-kubernetes-%EF%B8%8F-327b59f27202">⎈ Rolling Update &amp; Recreate Deployment Strategies in Kubernetes ⚙️</a></li>
  <li><a href="https://medium.com/@vinoji2005/day-29-kubernetes-a-b-testing-126f260f7006">Day 29: Kubernetes A/B Testing</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/workloads/management/#canary-deployments">Managing Workloads</a></li>
  <li><a href="https://argoproj.github.io/argo-rollouts/features/hpa-support/#bluegreen-deployments-with-hpa">Horizontal Pod Autoscaling</a></li>
  <li><a href="https://argoproj.github.io/argo-rollouts/features/bluegreen/">BlueGreen Deployment Strategy</a></li>
  <li><a href="https://argoproj.github.io/argo-rollouts/features/canary/">Canary Deployment Strategy</a></li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#ab-testing" class="page__taxonomy-item p-category" rel="tag">ab testing</a><span class="sep">, </span>
    
      <a href="/tags/#argo-rollouts" class="page__taxonomy-item p-category" rel="tag">argo rollouts</a><span class="sep">, </span>
    
      <a href="/tags/#auto-scaling" class="page__taxonomy-item p-category" rel="tag">auto scaling</a><span class="sep">, </span>
    
      <a href="/tags/#blue-green" class="page__taxonomy-item p-category" rel="tag">blue green</a><span class="sep">, </span>
    
      <a href="/tags/#canary" class="page__taxonomy-item p-category" rel="tag">canary</a><span class="sep">, </span>
    
      <a href="/tags/#controller" class="page__taxonomy-item p-category" rel="tag">controller</a><span class="sep">, </span>
    
      <a href="/tags/#deployment" class="page__taxonomy-item p-category" rel="tag">deployment</a><span class="sep">, </span>
    
      <a href="/tags/#horizontal-pod-autoscaler" class="page__taxonomy-item p-category" rel="tag">horizontal pod autoscaler</a><span class="sep">, </span>
    
      <a href="/tags/#hpa" class="page__taxonomy-item p-category" rel="tag">hpa</a><span class="sep">, </span>
    
      <a href="/tags/#hpa-and-vpa" class="page__taxonomy-item p-category" rel="tag">hpa and vpa</a><span class="sep">, </span>
    
      <a href="/tags/#keda" class="page__taxonomy-item p-category" rel="tag">keda</a><span class="sep">, </span>
    
      <a href="/tags/#keda-concepts" class="page__taxonomy-item p-category" rel="tag">keda concepts</a><span class="sep">, </span>
    
      <a href="/tags/#manual-scaling" class="page__taxonomy-item p-category" rel="tag">manual scaling</a><span class="sep">, </span>
    
      <a href="/tags/#metric-data" class="page__taxonomy-item p-category" rel="tag">metric data</a><span class="sep">, </span>
    
      <a href="/tags/#observed-generation" class="page__taxonomy-item p-category" rel="tag">observed generation</a><span class="sep">, </span>
    
      <a href="/tags/#recreate" class="page__taxonomy-item p-category" rel="tag">recreate</a><span class="sep">, </span>
    
      <a href="/tags/#resize-container-resources" class="page__taxonomy-item p-category" rel="tag">resize container resources</a><span class="sep">, </span>
    
      <a href="/tags/#rolling-update" class="page__taxonomy-item p-category" rel="tag">rolling update</a><span class="sep">, </span>
    
      <a href="/tags/#rollout" class="page__taxonomy-item p-category" rel="tag">rollout</a><span class="sep">, </span>
    
      <a href="/tags/#rollout-crd" class="page__taxonomy-item p-category" rel="tag">rollout crd</a><span class="sep">, </span>
    
      <a href="/tags/#scale-out" class="page__taxonomy-item p-category" rel="tag">scale out</a><span class="sep">, </span>
    
      <a href="/tags/#scale-up" class="page__taxonomy-item p-category" rel="tag">scale up</a><span class="sep">, </span>
    
      <a href="/tags/#scaling" class="page__taxonomy-item p-category" rel="tag">scaling</a><span class="sep">, </span>
    
      <a href="/tags/#scaling-policy" class="page__taxonomy-item p-category" rel="tag">scaling policy</a><span class="sep">, </span>
    
      <a href="/tags/#shadow" class="page__taxonomy-item p-category" rel="tag">shadow</a><span class="sep">, </span>
    
      <a href="/tags/#shadow-deployment" class="page__taxonomy-item p-category" rel="tag">shadow deployment</a><span class="sep">, </span>
    
      <a href="/tags/#stabilization-window" class="page__taxonomy-item p-category" rel="tag">stabilization window</a><span class="sep">, </span>
    
      <a href="/tags/#tolerance" class="page__taxonomy-item p-category" rel="tag">tolerance</a><span class="sep">, </span>
    
      <a href="/tags/#vertical-pod-autoscaler" class="page__taxonomy-item p-category" rel="tag">vertical pod autoscaler</a><span class="sep">, </span>
    
      <a href="/tags/#vpa" class="page__taxonomy-item p-category" rel="tag">vpa</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#kubernetes" class="page__taxonomy-item p-category" rel="tag">kubernetes</a>
    
    </span>
  </p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Kubernetes+%E5%BE%9E%E9%9B%B6%E9%96%8B%E5%A7%8B+-+%E9%83%A8%E7%BD%B2%E7%AD%96%E7%95%A5+101%20https%3A%2F%2Fambersuncreates.com%2Fkubernetes%2Fkubernetes-scale%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fambersuncreates.com%2Fkubernetes%2Fkubernetes-scale%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fambersuncreates.com%2Fkubernetes%2Fkubernetes-scale%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/database/database-delayed-queue/" class="pagination--pager" title="資料庫 - Delayed Queue 的設計與考量
">Previous</a>
    
    
      <a href="/kubernetes/kubernetes-traffic/" class="pagination--pager" title="Kubernetes 從零開始 - 在分散式的世界實現 Zero Downtime 路由管理
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/kubernetes/kubernetes-traffic/" rel="permalink">Kubernetes 從零開始 - 在分散式的世界實現 Zero Downtime 路由管理
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-10-16">2025-10-16</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-10-10">
            2025-10-10
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/kubernetes/kubernetes-traffic/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/kubernetes/kubernetes-traffic/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/kubernetes/kubernetes-traffic/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">Proxy
Proxy 是一個中間人，負責處理 client 與 server 之間的溝通請求
相比於 client 直接與 server 溝通，Proxy 的優勢在於可以進行流量控制、負載平衡、安全性控制等
他可以分為兩類 Forward Proxy 以及 Reverse Proxy

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/database/database-delayed-queue/" rel="permalink">資料庫 - Delayed Queue 的設計與考量
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-08-18">2025-08-18</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-10-10">
            2025-10-10
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/database/database-delayed-queue/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/database/database-delayed-queue/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/database/database-delayed-queue/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">What is Delayed Queue?
Delayed Queue 是一種特殊的 message queue
與一般的 message queue 不同，Delayed Queue 裡面的資料並不會被立即取出
你可以對每個 message 設定一個延遲時間
只有當時間到了之後，資料才可以被 consumer...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/random/syslog/" rel="permalink">玩轉 Syslog 第一次就上手
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-06-23">2025-06-23</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-10-10">
            2025-10-10
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/random/syslog/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/random/syslog/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/random/syslog/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">Introduction to Syslog
任何運行中的系統都會有 Log，主要是為了方便除錯、監控以及分析等等的
可以說沒有 Log 的系統是沒有辦法運作的

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/algorithm/algorithm-union-find/" rel="permalink">神奇的演算法 - 分組的好朋友 Union Find
</a>
      
    </h2>
    


  <p class="page__meta">
    

    

    
      
      

      

         

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>

         

      <span class="page__meta-readtime">
        <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Posted on:
        <time class="dt-published" datetime="2025-06-12">2025-06-12</time>
      </span>

      
           
        
        <span class="page__meta-readtime">
          <i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i>Updated on:
          <time class="dt-published" datetime="2025-10-10">
            2025-10-10
          </time>
        </span>

           

        <span>
          <i class="fas fa-eye" aria-hidden="true"></i>
          Views: <span id="view-field-/algorithm/algorithm-union-find/"> Loading...</span>
        </span>
      
    
  </p>


<script>
  fetch(`https://api.ambersuncreates.com/views?url=/algorithm/algorithm-union-find/`)
    .then(async (response) => {
      if (response.ok) {
        data = await response.json();

        let text = "-";
        if (data.views > 100) {
          text = Intl.NumberFormat('en', { notation: 'compact' }).format(data.views);
        }
        document.getElementById("view-field-/algorithm/algorithm-union-find/").innerHTML = text;
      }
    })
</script>

    <p class="archive__item-excerpt" itemprop="description">Introduction to Union Find
Disjoint Set 是一種資料結構，用來管理一組互不相交的集合（disjoint sets）。每個集合中的元素都是唯一的，且不同集合之間沒有共同的元素。

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

<script type="text/javascript">
  let viewHeight = window. innerHeight;
  let codeblocks = document.getElementsByClassName("highlight");

  Array.from(codeblocks).forEach(value => {
      if (value.scrollHeight > viewHeight) {
          value.setAttribute("style", "height:100vh;overflow-y:auto;");
      }
  })
</script>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
          <li><a href="https://github.com/ambersun1234" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">© 2025 Shawn Hsu. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q9EYCKB89S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Q9EYCKB89S', { 'anonymize_ip': false});
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://ambersuncreates.com/kubernetes/kubernetes-scale/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/kubernetes/kubernetes-scale"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://https-ambersun1234-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>


  


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
    },
    "HTML-CSS": {
      scale: 80
    }
  });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> 




  </body>
</html>
